<!-- AOC/04AOC.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>AOC04 · Parking Lot Escape</title>
<style>
  :root{
    --bg:#05030a;
    --ui:#e8e8ff;
    --muted:rgba(232,232,255,0.72);
    --violet:#8a2eff;
    --accent:#b300ff;
    --cyan:#00ffd5;
    --danger:#ff3b6b;
    --ok:#7CFF6B;
  }
  html,body{
    height:100%; margin:0; overflow:hidden;
    background:radial-gradient(1100px 740px at 50% 40%, #140a2a 0%, #05030a 60%, #02010a 100%);
    color:var(--ui);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  }
  #wrap{height:100%; display:grid; place-items:center;}
  canvas{
    image-rendering:pixelated; image-rendering:crisp-edges;
    border:1px solid rgba(255,255,255,0.14);
    border-radius:14px;
    background:#03020a;
    box-shadow:0 18px 60px rgba(0,0,0,0.62), 0 0 0 1px rgba(179,0,255,0.10) inset;
  }
  .nav{
    position:fixed; top:12px; left:14px; z-index:50;
    font-size:12px; letter-spacing:.25em; text-transform:uppercase;
    display:flex; gap:18px; align-items:center; user-select:none;
  }
  .nav a{color:#fff; text-decoration:none; opacity:.75; transition:.2s; text-shadow:0 0 18px rgba(138,46,255,.22);}
  .nav a:hover{opacity:1}
  .hint{
    position:fixed; left:14px; bottom:12px; z-index:50;
    font-size:12px; color:var(--muted);
    user-select:none; opacity:0.98;
    background:rgba(0,0,0,0.35);
    border:1px solid rgba(255,255,255,0.10);
    border-radius:12px;
    padding:10px 12px;
    max-width:min(700px,calc(100vw - 28px));
    line-height:1.45;
  }
  .topright{
    position:fixed; right:14px; top:12px; z-index:50;
    font-size:12px; color:rgba(232,232,255,0.70);
    user-select:none; opacity:0.95; text-align:right;
    background:rgba(0,0,0,0.28);
    border:1px solid rgba(255,255,255,0.10);
    border-radius:12px;
    padding:10px 12px;
  }
</style>
</head>
<body>
  <div class="nav">
    <a href="../index.html">CLAWBOI</a>
    <a href="../games.html">BACK TO GAMES</a>
  </div>

  <div id="wrap">
    <canvas id="c" width="960" height="540"></canvas>
  </div>

  <div class="topright" id="meta">
    AOC04 · PARKING LOT<br/>
    <span style="opacity:.7">find the car that unlocks.</span>
  </div>

  <div class="hint" id="hint">
    <b>Move</b> WASD · <b>Aim/Shoot</b> Mouse · <b>Punch</b> Space · <b>Dash</b> Shift · <b>Interact</b> E · <b>Restart</b> R
    <br><span id="msg" style="opacity:.8"></span>
  </div>

<script>
(() => {
  // ===== Canvas =====
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha:false });

  const W=320, H=180;
  const world=document.createElement('canvas');
  world.width=W; world.height=H;
  const g=world.getContext('2d', { alpha:false });

  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rand=(a,b)=>a+Math.random()*(b-a);
  const randi=(a,b)=>a+Math.floor(Math.random()*(b-a+1));
  const lerp=(a,b,t)=>a+(b-a)*t;
  const dist2=(ax,ay,bx,by)=>{const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy;};

  // ===== Save + choice =====
  const SAVE_KEY="AOC_SAVE";
  const CHOICE_KEY="AOC_CHOICE_ROACH";
  const PROG_KEY="AOC_PROGRESS";
  const choice = localStorage.getItem(CHOICE_KEY) || "unknown";
  localStorage.setItem(PROG_KEY, "AOC04");

  function ensureSave(){
    try{
      const raw=localStorage.getItem(SAVE_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    const s={ name:"CLAWBOI", level:1, hp:100, xp:0, gold:0, created:Date.now() };
    localStorage.setItem(SAVE_KEY, JSON.stringify(s));
    return s;
  }
  ensureSave();

  // ===== Fixed timestep =====
  let last=performance.now(), acc=0;
  const DT=1/60;

  // ===== Input =====
  const keys=new Set();
  const pressed=new Set();
  let mouse={x:W/2,y:H/2,down:false};

  window.addEventListener('keydown',(e)=>{
    const k=e.key.toLowerCase();
    keys.add(k); pressed.add(k);
    if([" ","arrowup","arrowdown","arrowleft","arrowright"].includes(e.key)) e.preventDefault();
  },{passive:false});
  window.addEventListener('keyup',(e)=>keys.delete(e.key.toLowerCase()));

  canvas.addEventListener('mousemove',(e)=>{
    const r=canvas.getBoundingClientRect();
    const sx=(e.clientX-r.left)/r.width;
    const sy=(e.clientY-r.top)/r.height;
    mouse.x=clamp(Math.floor(sx*W),0,W-1);
    mouse.y=clamp(Math.floor(sy*H),0,H-1);
  });
  canvas.addEventListener('mousedown',()=>mouse.down=true);
  window.addEventListener('mouseup',()=>mouse.down=false);

  // ===== FX =====
  let shake=0, hitstop=0;
  const sparks=[]; // {x,y,vx,vy,life,col}
  const floats=[]; // {x,y,vx,vy,life,text,col}
  const msgEl=document.getElementById("msg");

  function particles(x,y,count,spread,speed,life,colA,colB){
    for(let i=0;i<count;i++){
      const a=rand(0,Math.PI*2);
      const s=rand(speed*0.3,speed);
      sparks.push({
        x,y,
        vx:Math.cos(a)*s + rand(-spread,spread),
        vy:Math.sin(a)*s + rand(-spread,spread),
        life:rand(life*0.6,life),
        col:(Math.random()<0.5?colA:colB)
      });
    }
  }

  // ===== Arena (outside lot) =====
  const room={x0:14,y0:12,x1:W-14,y1:H-14};

  // ===== Player (same vibe) =====
  const player={
    x:W*0.22, y:H*0.52,
    vx:0, vy:0,
    hp:100,
    dir:1,
    inv:0,
    shootCD:0,
    punchCD:0,
    dashCD:0,
    score:0
  };

  // ===== Cars (pick the one that unlocks) =====
  const cars=[];
  const CAR_COUNT=8;

  function makeCars(){
    cars.length=0;
    // place in a rough grid
    const cols=4, rows=2;
    const startX=86, startY=44;
    const gapX=54, gapY=54;
    let idx=0;
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        idx++;
        const x=startX + c*gapX + rand(-4,4);
        const y=startY + r*gapY + rand(-4,4);
        cars.push({
          x,y, w:28, h:16,
          id:idx,
          locked:true,
          // tiny flicker to make them feel alive
          tw:rand(0,6.28)
        });
      }
    }
    // choose one unlock car
    const chosen = Math.floor(Math.random()*cars.length);
    cars[chosen].locked=false;

    // store which car id is the real one so reload keeps it consistent
    localStorage.setItem("AOC04_UNLOCK_CAR_ID", String(cars[chosen].id));
  }

  // If there’s a stored chosen car, rebuild cars and mark that one as unlock.
  function loadCars(){
    makeCars();
    const stored = parseInt(localStorage.getItem("AOC04_UNLOCK_CAR_ID")||"",10);
    if(Number.isFinite(stored)){
      for(const c of cars) c.locked = (c.id !== stored);
    }
  }
  loadCars();

  // ===== Enemies: guards swarm from edges =====
  const guards=[];  // {x,y,vx,vy,hp,spd,t,elite,shootCD}
  const bullets=[]; // {x,y,vx,vy,dmg,life,col,from}

  const choiceMod = (choice==="throw") ? 1.08 : (choice==="hide") ? 0.98 : 1.0;

  let wave=1;
  let timeToNext=0.8;
  let maxWaves=999; // endless pressure
  let spawnRate=0.85; // seconds
  let spawnTimer=0;

  function spawnGuard(elite=false){
    const side=randi(0,3);
    let x,y;
    if(side===0){x=room.x0-10; y=rand(room.y0+10,room.y1-10);}
    if(side===1){x=room.x1+10; y=rand(room.y0+10,room.y1-10);}
    if(side===2){x=rand(room.x0+10,room.x1-10); y=room.y0-10;}
    if(side===3){x=rand(room.x0+10,room.x1-10); y=room.y1+10;}

    const hp=elite?78:52;
    const spd=elite?rand(20,28):rand(16,24);

    guards.push({x,y,vx:0,vy:0,hp,spd,t:rand(0,999),elite,shootCD:rand(0.4,1.2)});
  }

  function resetRun(){
    guards.length=0; bullets.length=0; sparks.length=0; floats.length=0;
    player.x=W*0.22; player.y=H*0.52;
    player.vx=0; player.vy=0;
    player.hp=100; player.inv=0; player.shootCD=0; player.punchCD=0; player.dashCD=0;
    player.score=0;
    spawnRate=0.85; spawnTimer=0;
    msgEl.textContent = "SEARCH THE LOT. ONE CAR UNLOCKS. PRESS E NEAR IT.";
    loadCars();
    // initial burst
    for(let i=0;i<6;i++) spawnGuard(false);
    spawnGuard(true);
  }

  // ===== Drawing =====
  function drawClawboi(px,py,dir,frame,aimAng){
    const x=px|0, y=py|0;
    const bob=(Math.sin(frame*0.25)*1)|0;

    g.fillStyle="rgba(0,0,0,0.35)";
    g.fillRect(x-7,y+9,14,3);

    g.fillStyle="#2a0f2d";
    g.fillRect(x-6,y+3+bob,5,6);
    g.fillRect(x+1,y+3+bob,5,6);

    g.fillStyle="#8a2eff";
    g.fillRect(x-6,y-4+bob,12,10);

    g.fillStyle="#00ffd5";
    g.fillRect(x-6,y+1+bob,12,2);

    g.fillStyle="#b300ff";
    g.fillRect(x-6,y-13+bob,12,9);

    g.fillStyle="rgba(255,255,255,0.85)";
    const ex=dir>0?1:-3;
    g.fillRect(x+ex,y-10+bob,2,2);
    g.fillRect(x+ex+4,y-10+bob,2,2);

    // aim line
    const ax=x+Math.cos(aimAng)*12;
    const ay=y+Math.sin(aimAng)*12;
    g.strokeStyle="rgba(0,255,213,0.28)";
    g.beginPath(); g.moveTo(x,y-2+bob); g.lineTo(ax,ay); g.stroke();
  }

  function drawGuard(e){
    const x=e.x|0, y=e.y|0;
    const bob=(Math.sin(e.t*0.18)*1)|0;

    g.fillStyle="rgba(0,0,0,0.35)";
    g.fillRect(x-5,y+7,10,3);

    g.fillStyle=e.elite?"#ff3b6b":"#58b0ff";
    g.fillRect(x-4,y-5+bob,8,10);

    g.fillStyle=e.elite?"#b300ff":"#2b6bd6";
    g.fillRect(x-5,y-14+bob,10,9);

    g.fillStyle="rgba(0,0,0,0.55)";
    g.fillRect(x-3,y-11+bob,6,2);
  }

  function drawCar(c,tt,near,unlockHint){
    const x=c.x|0, y=c.y|0;
    // body
    g.fillStyle = c.locked ? "rgba(255,255,255,0.10)" : "rgba(0,255,213,0.13)";
    g.fillRect(x-14,y-8,28,16);

    // outline
    g.strokeStyle = c.locked ? "rgba(255,255,255,0.22)" : "rgba(0,255,213,0.55)";
    g.strokeRect(x-14,y-8,28,16);

    // windows
    g.fillStyle="rgba(0,0,0,0.45)";
    g.fillRect(x-10,y-6,20,6);

    // taillight / headlight
    g.fillStyle="rgba(255,59,107,0.55)";
    g.fillRect(x-14,y-2,2,4);
    g.fillStyle="rgba(255,255,255,0.42)";
    g.fillRect(x+12,y-2,2,4);

    // subtle “key shimmer” on the unlock car
    if(!c.locked){
      const blink=(Math.sin(tt*5 + c.tw)>0.5);
      g.fillStyle=blink ? "rgba(0,255,213,0.95)" : "rgba(138,46,255,0.55)";
      g.fillRect(x+4,y+6,2,2);
      g.fillRect(x+7,y+6,1,1);
    }

    if(near){
      g.fillStyle="rgba(0,0,0,0.35)";
      g.fillRect(x-20,y-26,40,14);
      g.fillStyle="rgba(232,232,255,0.85)";
      g.font="10px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
      g.fillText(unlockHint ? "E: ENTER" : "E: TRY LOCK", x-18, y-16);
    }
  }

  function drawLotBackdrop(tt){
    g.fillStyle="#070517";
    g.fillRect(0,0,W,H);

    // night fog slabs
    for(let i=0;i<5;i++){
      const fx=(W*(0.15+i*0.18) + Math.sin(tt*0.7+i)*12);
      const fy=(H*(0.18+i*0.12) + Math.cos(tt*0.6+i)*10);
      g.fillStyle=`rgba(138,46,255,${0.04+i*0.014})`;
      g.fillRect(fx-34,fy-22,68,44);
    }

    // ground
    g.fillStyle="rgba(0,0,0,0.35)";
    g.fillRect(room.x0, room.y0, room.x1-room.x0, room.y1-room.y0);

    // lot lines
    g.strokeStyle="rgba(255,255,255,0.06)";
    for(let y=38;y<room.y1-10;y+=18){
      g.beginPath(); g.moveTo(room.x0+8,y); g.lineTo(room.x1-8,y); g.stroke();
    }
    g.strokeStyle="rgba(0,255,213,0.08)";
    for(let x=78;x<room.x1-10;x+=54){
      g.beginPath(); g.moveTo(x, room.y0+22); g.lineTo(x, room.y1-10); g.stroke();
    }

    // boundary
    g.strokeStyle="rgba(255,255,255,0.12)";
    g.strokeRect(room.x0, room.y0, room.x1-room.x0, room.y1-room.y0);

    // UI strips
    g.fillStyle="rgba(0,0,0,0.35)";
    g.fillRect(0,0,W,18);
    g.fillStyle="rgba(232,232,255,0.85)";
    g.font="10px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
    g.fillText("AOC04 // FIND THE UNLOCK CAR", 8, 13);

    // HP bar
    const hpP=clamp(player.hp/100,0,1);
    g.fillStyle="rgba(255,255,255,0.08)";
    g.fillRect(8, 22, 140, 8);
    g.fillStyle = hpP>0.4 ? "#7CFF6B" : "#ff3b6b";
    g.fillRect(8, 22, 140*hpP, 8);
    g.strokeStyle="rgba(255,255,255,0.14)";
    g.strokeRect(8, 22, 140, 8);

    // score
    g.fillStyle="rgba(232,232,255,0.65)";
    g.fillText("SCORE " + player.score, 168, 29);
  }

  // ===== Combat =====
  function shoot(ang){
    if(player.shootCD>0) return;
    player.shootCD = 1/10.5;
    const spd=280, dmg=24;
    bullets.push({
      x: player.x + Math.cos(ang)*7,
      y: player.y + Math.sin(ang)*7,
      vx: Math.cos(ang)*spd,
      vy: Math.sin(ang)*spd,
      dmg, life:0.9, col:"#00ffd5", from:"p"
    });
    particles(player.x+Math.cos(ang)*7, player.y+Math.sin(ang)*7, 8, 0.7, 55, 0.25, "#00ffd5", "rgba(255,255,255,0.75)");
    shake=Math.max(shake,3);
  }

  function punch(ang){
    if(player.punchCD>0) return;
    player.punchCD=0.42;
    const reach=14;
    const hx=player.x+Math.cos(ang)*reach;
    const hy=player.y+Math.sin(ang)*reach;

    let hit=false;
    for(let i=guards.length-1;i>=0;i--){
      const e=guards[i];
      if(dist2(hx,hy,e.x,e.y) < 10*10){
        e.hp -= 55;
        hit=true;
        particles(e.x,e.y,18,1.4,75,0.35,"#ffd24a","#ff3b6b");
        floats.push({x:e.x,y:e.y-8,vx:rand(-10,10),vy:rand(-20,-10),life:0.7,text:"-55",col:"#ffd24a"});
        shake=Math.max(shake,7);
        if(e.hp<=0){
          guards.splice(i,1);
          player.score += e.elite ? 40 : 24;
          particles(e.x,e.y,22,1.5,95,0.45,"#00ffd5","#b300ff");
        }
      }
    }
    particles(hx,hy, hit?10:7, 1.0, 55, 0.22, "#ffd24a", "rgba(255,255,255,0.7)");
  }

  function dash(ang){
    if(player.dashCD>0) return;
    player.dashCD=1.0;
    player.vx += Math.cos(ang)*160;
    player.vy += Math.sin(ang)*160;
    player.inv = 0.18;
    particles(player.x,player.y,34,2.0,110,0.42,"#b300ff","#00ffd5");
    shake=Math.max(shake,9);
  }

  function hurtPlayer(amount){
    if(player.inv>0) return;
    player.hp -= amount;
    player.inv=0.55;
    shake=Math.max(shake,7);
    particles(player.x,player.y,30,2.0,90,0.6,"#ff3b6b","#b300ff");
  }

  function guardShoot(e){
    const a=Math.atan2(player.y-e.y, player.x-e.x);
    const spd=e.elite?190:170;
    const dmg=e.elite?10:8;
    bullets.push({
      x:e.x+Math.cos(a)*6, y:e.y+Math.sin(a)*6,
      vx:Math.cos(a)*spd, vy:Math.sin(a)*spd,
      dmg, life:1.1, col:(e.elite?"#ff3b6b":"#58b0ff"), from:"e"
    });
    particles(e.x+Math.cos(a)*6, e.y+Math.sin(a)*6, 6, 0.8, 55, 0.22, bullets[bullets.length-1].col, "rgba(255,255,255,0.6)");
  }

  // ===== Transition =====
  function fadeTo(url){
    const d=document.createElement("div");
    d.style.position="fixed";
    d.style.inset="0";
    d.style.background="#000";
    d.style.opacity="0";
    d.style.transition="900ms";
    d.style.zIndex="999";
    document.body.appendChild(d);
    requestAnimationFrame(()=>d.style.opacity="1");
    setTimeout(()=>location.href=url, 940);
  }

  // ===== Update =====
  function update(dt){
    if(hitstop>0){ hitstop-=dt; return; }

    if(pressed.has("r")){
      resetRun();
      pressed.clear();
      return;
    }

    // movement
    let mx=0,my=0;
    if(keys.has("a")) mx-=1;
    if(keys.has("d")) mx+=1;
    if(keys.has("w")) my-=1;
    if(keys.has("s")) my+=1;
    const L=Math.hypot(mx,my)||1; mx/=L; my/=L;

    const spd=62;
    player.vx=lerp(player.vx, mx*spd, 0.22);
    player.vy=lerp(player.vy, my*spd, 0.22);
    player.x += player.vx*dt;
    player.y += player.vy*dt;

    player.x=clamp(player.x, room.x0+8, room.x1-8);
    player.y=clamp(player.y, room.y0+10, room.y1-10);

    // aim
    const ang=Math.atan2(mouse.y-player.y, mouse.x-player.x);
    player.dir = Math.cos(ang)>=0 ? 1 : -1;

    // timers
    player.inv=Math.max(0, player.inv-dt);
    player.shootCD=Math.max(0, player.shootCD-dt);
    player.punchCD=Math.max(0, player.punchCD-dt);
    player.dashCD=Math.max(0, player.dashCD-dt);

    // actions
    if(keys.has("shift")) dash(ang);
    if(mouse.down) shoot(ang);
    if(pressed.has(" ")) { punch(ang); hitstop=0.02; }

    // enemy spawning ramps up
    spawnTimer -= dt;
    if(spawnTimer<=0){
      spawnTimer = spawnRate;
      spawnGuard(Math.random() < 0.18); // occasional elite
      // slowly increase pressure
      spawnRate = Math.max(0.42, spawnRate - 0.0035*choiceMod);
    }

    // bullets
    for(let i=bullets.length-1;i>=0;i--){
      const b=bullets[i];
      b.life-=dt;
      b.x+=b.vx*dt;
      b.y+=b.vy*dt;

      if(b.life<=0 || b.x<0||b.x>W||b.y<0||b.y>H){ bullets.splice(i,1); continue; }

      if(b.from==="p"){
        for(let j=guards.length-1;j>=0;j--){
          const e=guards[j];
          if(dist2(b.x,b.y,e.x,e.y) < 7*7){
            e.hp -= b.dmg * (1.12/choiceMod);
            particles(b.x,b.y,10,1.0,70,0.28,b.col,"rgba(255,255,255,0.7)");
            floats.push({x:e.x,y:e.y-7,vx:rand(-8,8),vy:rand(-18,-10),life:0.6,text:`-${Math.floor(b.dmg)}`,col:b.col});
            bullets.splice(i,1);
            hitstop=0.012;
            shake=Math.max(shake,4);
            if(e.hp<=0){
              guards.splice(j,1);
              player.score += e.elite ? 40 : 22;
              particles(e.x,e.y,22,1.5,95,0.45,"#00ffd5","#b300ff");
            }
            break;
          }
        }
      }else{
        if(dist2(b.x,b.y,player.x,player.y) < 8*8){
          hurtPlayer(b.dmg);
          bullets.splice(i,1);
          hitstop=0.012;
        }
      }
    }

    // guards AI
    for(let i=guards.length-1;i>=0;i--){
      const e=guards[i];
      e.t += 1;

      const a=Math.atan2(player.y-e.y, player.x-e.x);
      e.vx=Math.cos(a)*e.spd*choiceMod;
      e.vy=Math.sin(a)*e.spd*choiceMod;
      e.x += e.vx*dt;
      e.y += e.vy*dt;

      // mild obstacle wiggle around cars (simple repulsion)
      for(const c of cars){
        const dx=e.x-c.x, dy=e.y-c.y;
        const d2=dx*dx+dy*dy;
        const rr=18*18;
        if(d2<rr){
          const inv=1/Math.max(1,Math.sqrt(d2));
          e.x += dx*inv*12*dt;
          e.y += dy*inv*12*dt;
        }
      }

      // contact damage
      if(dist2(e.x,e.y,player.x,player.y) < 10*10){
        hurtPlayer(e.elite?12:9);
      }

      // shoot
      e.shootCD -= dt;
      const r=(e.elite?118:95);
      if(e.shootCD<=0 && dist2(e.x,e.y,player.x,player.y) < r*r){
        e.shootCD = e.elite ? rand(0.55,0.9) : rand(0.85,1.35);
        guardShoot(e);
      }
    }

    // interact with cars
    let nearCar=null;
    for(const c of cars){
      const inRange = dist2(player.x,player.y,c.x,c.y) < 20*20;
      if(inRange){ nearCar=c; break; }
    }

    if(nearCar){
      if(!nearCar.locked){
        msgEl.textContent = "FOUND IT. THE DOOR CLICKS LIKE A SECRET. PRESS E.";
      }else{
        msgEl.textContent = "WRONG CAR. LOCKED. PRESS E TO TRY ANYWAY (WASTE TIME).";
      }
    }else{
      msgEl.textContent = "SEARCH THE LOT. ONE CAR UNLOCKS. PRESS E NEAR IT.";
    }

    if(pressed.has("e")){
      if(nearCar){
        if(!nearCar.locked){
          localStorage.setItem(PROG_KEY, "AOC04_COMPLETE");
          // tiny reward + log
          const s=ensureSave();
          s.gold = (s.gold||0) + 5;
          localStorage.setItem(SAVE_KEY, JSON.stringify(s));
          particles(nearCar.x, nearCar.y, 80, 2.4, 140, 0.8, "#00ffd5","#b300ff");
          shake=Math.max(shake,10);
          fadeTo("05AOC.html");
        }else{
          // “waste time” penalty
          shake=Math.max(shake,5);
          particles(nearCar.x, nearCar.y, 18, 1.5, 90, 0.35, "#ff3b6b", "#b300ff");
          // small punish: spawn an extra elite
          spawnGuard(true);
        }
      }
    }

    pressed.clear();

    // death
    if(player.hp<=0){
      resetRun();
    }
  }

  // ===== Render =====
  function draw(){
    const sx = shake>0 ? randi(-shake,shake) : 0;
    const sy = shake>0 ? randi(-shake,shake) : 0;
    shake = Math.max(0, shake - 0.35);

    const tt=performance.now()/1000;

    drawLotBackdrop(tt);

    g.save();
    g.translate(sx,sy);

    // cars
    let nearCarId=0;
    let nearCar=null;
    for(const c of cars){
      if(dist2(player.x,player.y,c.x,c.y) < 20*20){ nearCar=c; break; }
    }
    for(const c of cars){
      drawCar(c, tt, nearCar===c, (!c.locked));
    }

    // bullets
    for(const b of bullets){
      g.fillStyle=b.col;
      g.fillRect((b.x|0)-1,(b.y|0)-1,3,3);
    }

    // guards
    for(const e of guards) drawGuard(e);

    // player blink when inv
    const aimAng=Math.atan2(mouse.y-player.y, mouse.x-player.x);
    const blink = player.inv>0 && ((performance.now()/70|0)%2===0);
    if(!blink) drawClawboi(player.x,player.y,player.dir,(performance.now()/16)|0,aimAng);

    // particles
    for(let i=sparks.length-1;i>=0;i--){
      const p=sparks[i];
      p.life -= DT;
      p.x += p.vx*DT;
      p.y += p.vy*DT;
      p.vx *= 0.90; p.vy *= 0.90;
      g.fillStyle=p.col;
      g.fillRect(p.x|0,p.y|0,1,1);
      if(p.life<=0) sparks.splice(i,1);
    }

    // float text
    for(let i=floats.length-1;i>=0;i--){
      const f=floats[i];
      f.life -= DT;
      f.x += f.vx*DT;
      f.y += f.vy*DT;
      f.vx *= 0.88;
      f.vy += 34*DT;
      g.fillStyle=f.col;
      g.font="10px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
      g.fillText(f.text, f.x|0, f.y|0);
      if(f.life<=0) floats.splice(i,1);
    }

    g.restore();

    ctx.imageSmoothingEnabled=false;
    ctx.drawImage(world,0,0,W,H,0,0,canvas.width,canvas.height);
  }

  function loop(now){
    const dt=Math.min(0.05,(now-last)/1000);
    last=now;
    acc += dt;
    while(acc>=DT){
      update(DT);
      acc -= DT;
    }
    draw();
    requestAnimationFrame(loop);
  }

  resetRun();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>

