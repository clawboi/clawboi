<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>DECRYPT</title>
<style>
:root{--bg:#000;--violet:#8a2eff;--fg:#fff;}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  overflow:hidden;
}
a{color:#fff;text-decoration:none}
.brand{
  position:fixed;top:14px;left:14px;z-index:9;
  font-size:11px;letter-spacing:.34em;text-transform:uppercase;
  opacity:.75;text-shadow:0 0 18px rgba(138,46,255,.25);
}
.brand:hover{opacity:1}
.hud{
  position:fixed;top:14px;right:14px;z-index:9;
  font-size:10px;letter-spacing:.30em;text-transform:uppercase;
  opacity:.62;
}
.panel{
  position:fixed;
  left:14px; bottom:14px;
  z-index:9;
  width:min(520px, calc(100vw - 28px));
  background:rgba(255,255,255,.03);
  border-radius:16px;
  padding:14px;
  backdrop-filter: blur(10px);
  box-shadow:0 0 38px rgba(138,46,255,.10);
}
.panel .title{
  font-size:10px;letter-spacing:.34em;text-transform:uppercase;opacity:.75;
}
.files{
  margin-top:10px;
  font-size:12px;
  line-height:1.6;
  letter-spacing:.08em;
  opacity:.85;
}
.file{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  background:rgba(138,46,255,.06);
  margin-top:8px;
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
}
.file:hover{filter:brightness(1.06)}
.file:active{transform:translateY(0.5px)}
.file .name{opacity:.92}
.file .tag{opacity:.55; letter-spacing:.22em; text-transform:uppercase; font-size:10px}

/* mini player + visualizer */
.player{
  margin-top:12px;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.pbtn{
  appearance:none;
  border:0;
  cursor:pointer;
  padding:10px 12px;
  border-radius:999px;
  background:rgba(138,46,255,.16);
  color:#fff;
  letter-spacing:.22em;
  font-size:10px;
  text-transform:uppercase;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
}
.pbtn:hover{filter:brightness(1.06)}
.pbtn.alt{background:rgba(255,255,255,.06)}
.viz{
  width:100%;
  height:46px;
  border-radius:12px;
  overflow:hidden;
  background:rgba(255,255,255,.02);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}

/* now playing line */
.now{
  margin-top:10px;
  font-size:10px;
  letter-spacing:.30em;
  text-transform:uppercase;
  opacity:.55;
}
.now b{opacity:.9; letter-spacing:.34em}

canvas{position:fixed;inset:0; pointer-events:none;}
.scan{
  position:fixed;inset:0;pointer-events:none;z-index:3;
  opacity:.08;mix-blend-mode:overlay;
  background:repeating-linear-gradient(to bottom, rgba(255,255,255,.06) 0px, rgba(255,255,255,.06) 1px, transparent 3px, transparent 6px);
}
</style>
</head>
<body>

<a class="brand" href="vault.html">CLAWBOI</a>
<div class="hud" id="hud">DECRYPTING…</div>
<canvas id="c"></canvas>
<div class="scan"></div>

<div class="panel">
  <div class="title">LOST SONG FILES</div>

  <div class="files" id="files">
    <div class="file" data-song="audio/untitled.01">
      <div class="name">untitled.01</div>
      <div class="tag">PLAY</div>
    </div>
    <div class="file" data-song="untitled.02">
      <div class="name">untitled.02</div>
      <div class="tag">PLAY</div>
    </div>
    <div class="file" data-song="untitled.03">
      <div class="name">untitled.03</div>
      <div class="tag">PLAY</div>
    </div>
    <div class="file" data-song="untitled.04">
      <div class="name">untitled.04</div>
      <div class="tag">PLAY</div>
    </div>
  </div>

  <div class="player">
    <button class="pbtn alt" id="stopBtn">STOP</button>
    <a class="pbtn alt" href="secret.html">RETURN TO TRANSMISSION</a>

    <!-- single audio element used for all tracks -->
    <audio id="amb" preload="auto" playsinline></audio>

    <canvas class="viz" id="viz" aria-hidden="true"></canvas>
  </div>

  <div class="now" id="now">NOW PLAYING: <b>NONE</b></div>
</div>

<script>
/* Matrix rain */
const c = document.getElementById("c");
const ctx = c.getContext("2d");
let cols, ys, font = 16;

function resize(){
  c.width = window.innerWidth * devicePixelRatio;
  c.height = window.innerHeight * devicePixelRatio;
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(devicePixelRatio, devicePixelRatio);
  cols = Math.floor(window.innerWidth / font);
  ys = Array(cols).fill(0).map(()=>Math.random()*window.innerHeight);
}
window.addEventListener("resize", resize);
resize();

/* Audio analyser */
let aCtx, analyser, srcNode, data;
let amp = 0;
let playing = false;

const amb = document.getElementById("amb");
const nowEl = document.getElementById("now");

function setupAudio(){
  if(aCtx) return;
  aCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = aCtx.createAnalyser();
  analyser.fftSize = 1024;
  data = new Uint8Array(analyser.frequencyBinCount);

  srcNode = aCtx.createMediaElementSource(amb);

  const gain = aCtx.createGain();
  gain.gain.value = 0.95;

  srcNode.connect(analyser);
  analyser.connect(gain);
  gain.connect(aCtx.destination);
}

function getAmp(){
  if(!analyser || !playing) return amp * 0.92;
  analyser.getByteFrequencyData(data);

  let sum = 0;
  const start = 2, end = Math.min(64, data.length);
  for(let i=start;i<end;i++) sum += data[i];
  const avg = sum / (end-start) / 255;

  amp = amp*0.82 + avg*0.18;
  return amp;
}

/* HUD flicker */
const hud = document.getElementById("hud");
const hudLines = ["DECRYPTING…","PACKETS LOST…","REBUILDING INDEX…","SIGNAL FOUND.","OPEN A FILE."];
let hi = 0;
setInterval(()=>{ hi=(hi+1)%hudLines.length; hud.textContent=hudLines[hi]; }, 1100);

/* Visualizer canvas */
const viz = document.getElementById("viz");
const vctx = viz.getContext("2d");

function fitViz(){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  viz.width = Math.floor(viz.clientWidth * dpr);
  viz.height = Math.floor(viz.clientHeight * dpr);
  vctx.setTransform(1,0,0,1,0,0);
  vctx.scale(dpr,dpr);
}
addEventListener("resize", fitViz);
fitViz();

function drawViz(){
  const W = viz.clientWidth;
  const H = viz.clientHeight;
  vctx.clearRect(0,0,W,H);

  const level = getAmp();
  const bars = 32;
  const gap = 3;
  const bw = (W - gap*(bars-1)) / bars;

  for(let i=0;i<bars;i++){
    const idx = (analyser && data) ? Math.min(data.length-1, Math.floor(i*(data.length/bars))) : i;
    const raw = (analyser && data && playing) ? (data[idx]/255) : 0;

    const hh = Math.max(2, (raw*0.55 + level*0.65) * (H-6));
    const x = i*(bw+gap);
    const y = H - hh;

    vctx.fillStyle = `rgba(255,255,255,${0.12 + raw*0.35 + level*0.18})`;
    vctx.fillRect(x, y, bw, hh);

    vctx.fillStyle = `rgba(138,46,255,${0.10 + raw*0.40 + level*0.22})`;
    vctx.fillRect(x, y, bw, hh*0.92);
  }
  requestAnimationFrame(drawViz);
}
drawViz();

/* Matrix tick reacts to audio */
function tick(){
  const level = getAmp();

  const fade = 0.08 + level*0.09;
  ctx.fillStyle = `rgba(0,0,0,${fade})`;
  ctx.fillRect(0,0,window.innerWidth,window.innerHeight);

  const a = 0.78 + level*0.22;
  ctx.fillStyle = `rgba(138,46,255,${a})`;
  ctx.font = font + "px ui-monospace, Menlo, monospace";

  const speed = 1 + level*2.8;

  for(let i=0;i<cols;i++){
    const x = i*font;
    const y = ys[i];
    const ch = Math.random() > 0.5 ? "0" : "1";

    const wobble = Math.sin((i*0.7) + performance.now()*0.002) * (level*4.4);
    ctx.fillText(ch, x + wobble, y);

    ys[i] = y + font*speed;
    if(ys[i] > window.innerHeight + Math.random()*400) ys[i] = -Math.random()*200;
  }
  requestAnimationFrame(tick);
}
tick();

/* Robust track loader: tries common extensions */
const EXT_TRY = [".mp3",".m4a",".wav",".ogg"];

async function tryPlayWithExt(baseName){
  for(const ext of EXT_TRY){
    try{
      amb.pause();
      amb.currentTime = 0;

      amb.src = `audio/${baseName}${ext}?v=1`;
      amb.load();

      await amb.play();
      return { ok:true, ext };
    }catch(e){
      // keep trying next extension
    }
  }
  return { ok:false };
}

/* Play a selected file (stays on page) */
async function playTrack(name){
  nowEl.innerHTML = `NOW PLAYING: <b>LOADING</b>`;
  try{
    setupAudio();
    if(aCtx.state === "suspended") await aCtx.resume();

    playing = false;
    const res = await tryPlayWithExt(name);

    if(!res.ok){
      playing = false;
      nowEl.innerHTML = `NOW PLAYING: <b>NOT FOUND</b>`;
      return;
    }

    playing = true;
    nowEl.innerHTML = `NOW PLAYING: <b>${name}</b>`;
  }catch(e){
    playing = false;
    nowEl.innerHTML = `NOW PLAYING: <b>ERROR</b>`;
  }
}

/* Stop button stops whatever is playing */
document.getElementById("stopBtn").onclick = ()=>{
  amb.pause();
  amb.currentTime = 0;
  playing = false;
  nowEl.innerHTML = `NOW PLAYING: <b>NONE</b>`;
};

/* Click files to play (no redirects) */
document.getElementById("files").addEventListener("click",(e)=>{
  const row = e.target.closest(".file");
  if(!row) return;
  const key = row.getAttribute("data-song");
  if(!key) return;
  playTrack(key);
});

/* When track ends, reset state */
amb.addEventListener("ended", ()=>{
  playing = false;
  nowEl.innerHTML = `NOW PLAYING: <b>NONE</b>`;
});

/* iOS-friendly: ensure audio unlocks on first interaction (but still only plays when you click a track) */
function unlockAudioOnce(){
  try{
    setupAudio();
    aCtx.resume?.();
  }catch(e){}
  window.removeEventListener("pointerdown", unlockAudioOnce);
  window.removeEventListener("touchstart", unlockAudioOnce);
  window.removeEventListener("keydown", unlockAudioOnce);
}
window.addEventListener("pointerdown", unlockAudioOnce, {passive:true});
window.addEventListener("touchstart", unlockAudioOnce, {passive:true});
window.addEventListener("keydown", unlockAudioOnce);
</script>
</body>
</html>
