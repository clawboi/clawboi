<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Sophia's Audition — Workout</title>
<style>
  :root{ --bg:#07070b; --fg:#fff; --ui2:rgba(255,255,255,.14); --vio:#8a2eff;}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  body::before{content:"";position:fixed;inset:-20%;background:
      radial-gradient(circle at 20% 10%, rgba(138,46,255,.16), transparent 60%),
      radial-gradient(circle at 80% 40%, rgba(0,255,213,.10), transparent 65%),
      radial-gradient(circle at 50% 92%, rgba(138,46,255,.10), transparent 70%);
    filter:blur(40px) saturate(1.15); animation:drift 12s ease-in-out infinite; pointer-events:none;}
  body::after{content:"";position:fixed;inset:0;pointer-events:none;background:
      radial-gradient(1200px 900px at 50% 45%, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 70%, rgba(0,0,0,.60) 100%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.018) 0 1px, transparent 1px 4px);
    mix-blend-mode:overlay; opacity:.55;}
  @keyframes drift{0%,100%{transform:translate3d(0,0,0)}50%{transform:translate3d(1.5%,-1.5%,0)}}
  .wrap{height:100%; display:grid; place-items:center;}
  canvas{width:min(980px, 100vw); height:auto; image-rendering:pixelated; image-rendering:crisp-edges; touch-action:none;}
  .hud{position:fixed;left:12px;right:12px;top:12px;z-index:5;display:flex;gap:10px;flex-wrap:wrap;pointer-events:none;}
  .pill{pointer-events:auto;border:1px solid var(--ui2);background:rgba(0,0,0,.35);backdrop-filter:blur(8px);border-radius:999px;padding:10px 12px;font-size:11px;letter-spacing:.18em;text-transform:uppercase;display:flex;gap:10px;align-items:center;}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);border:1px solid var(--ui2);background:rgba(0,0,0,.55);border-radius:14px;padding:10px 12px;font-size:12px;letter-spacing:.08em;opacity:0;transition:.2s;max-width:min(720px,calc(100vw - 24px));text-align:center;z-index:6;}
  .toast.on{opacity:1}
</style>
</head>
<body>
<div class="hud">
  <div class="pill"><b>SOPHIA</b> <span>WORKOUT</span></div>
  <div class="pill">ROUND: <span id="round">1</span>/5</div>
  <div class="pill">PROMPT: <span id="prompt">READY</span></div>
  <div class="pill">FIT CHARGE: <span id="charge">0%</span></div>
  <div class="pill">Keys: SPACE / C / Shift (timing)</div>
  <div class="pill">E → LIVING ROOM</div>
</div>
<div class="toast" id="toast"></div>
<div class="wrap"><canvas id="c" width="320" height="180"></canvas></div>

<script>
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d',{alpha:false});
ctx.imageSmoothingEnabled=false;

const UI={
  round:document.getElementById('round'),
  prompt:document.getElementById('prompt'),
  charge:document.getElementById('charge'),
  toast:document.getElementById('toast'),
};

const STORE_KEY="SOPHIA_AUDITION_SAVE_V1";
function loadState(){
  const r=localStorage.getItem(STORE_KEY);
  if(r){ try{return JSON.parse(r);}catch(e){} }
  return { trip:false, roomFit:"NORMAL", dressColor:"#a64dff", shoeColor:"#ffffff", sophia:{x:160,y:120}, milo:{x:148,y:132} };
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
let state=loadState();
if(!state.roomFit) state.roomFit="NORMAL";

function toast(msg,ms=1500){
  UI.toast.textContent=msg;
  UI.toast.classList.add('on');
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>UI.toast.classList.remove('on'),ms);
}

const keysDown=new Set();
addEventListener('keydown',(e)=>{
  const k=e.key.toLowerCase();
  if(["arrowup","arrowdown","arrowleft","arrowright"," ","shift","w","a","s","d","e","c","enter"].includes(k)) e.preventDefault();
  keysDown.add(k);
});
addEventListener('keyup',(e)=>keysDown.delete(e.key.toLowerCase()));

const W=canvas.width,H=canvas.height;

function drawSophia(x,y,pose){
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(x-1,y+11,12,2);
  ctx.fillStyle="#f2d27a"; ctx.fillRect(x+1,y+0,8,4); ctx.fillRect(x+0,y+3,10,3);
  ctx.fillStyle="#ffd9c9"; ctx.fillRect(x+2,y+5,6,4);
  ctx.fillStyle="#67b7ff"; ctx.fillRect(x+3,y+6,1,1); ctx.fillRect(x+6,y+6,1,1);
  // dress + pose tweaks
  ctx.fillStyle="rgba(138,46,255,.55)"; ctx.fillRect(x+2,y+9,6,3);
  if(pose===1){ ctx.fillStyle="rgba(0,255,213,.12)"; ctx.fillRect(x+1,y+8,8,6); }
  if(pose===2){ ctx.fillStyle="rgba(255,210,77,.12)"; ctx.fillRect(x+1,y+8,8,6); }
  if(pose===3){ ctx.fillStyle="rgba(255,99,255,.12)"; ctx.fillRect(x+1,y+8,8,6); }
  ctx.fillStyle="rgba(255,255,255,.14)"; ctx.fillRect(x+3,y+10,4,1);
}

function drawMilo(x,y,t,cheer){
  ctx.fillStyle="rgba(0,0,0,.40)"; ctx.fillRect(x-1,y+7,10,2);
  ctx.fillStyle="#d8d8d8"; ctx.fillRect(x+1,y+2,6,5);
  ctx.fillStyle="#cfcfcf"; ctx.fillRect(x+1,y+1,2,2); ctx.fillRect(x+5,y+1,2,2);
  ctx.fillStyle="rgba(26,255,211,.9)"; ctx.fillRect(x+2,y+4,1,1); ctx.fillRect(x+5,y+4,1,1);
  ctx.fillStyle="#cfcfcf"; ctx.fillRect(x+7,y+3+((Math.sin(t*0.2)*1)|0),1,3);
  if(cheer && (t%18<9)){
    ctx.fillStyle="rgba(0,255,213,.20)";
    ctx.fillRect(x-2,y-2,1,1); ctx.fillRect(x+9,y-1,1,1);
  }
}

function vignette(){
  ctx.fillStyle="rgba(0,0,0,.18)";
  ctx.fillRect(0,0,W,12); ctx.fillRect(0,H-12,W,12);
  ctx.fillRect(0,0,12,H); ctx.fillRect(W-12,0,12,H);
}

function goBack(){ saveState(); location.href="Sophie03.html"; }

// Workout: 5 prompts, timing window, build charge
const prompts = [
  {name:"JUMP", key:"space", pose:1},
  {name:"FLEX", key:"shift", pose:2},
  {name:"DANCE", key:"c", pose:3},
  {name:"JUMP", key:"space", pose:1},
  {name:"FLEX", key:"shift", pose:2},
];

let round=1;
let charge=0;      // 0..100
let windowT=0;     // timing window timer
let cur = prompts[0];
let phase="READY"; // READY -> GO -> HIT/MISS -> NEXT
let pose=0;
let cheer=0;

function setRound(n){
  round=n;
  cur = prompts[n-1];
  windowT = 95; // frames
  phase="GO";
  pose=0;
  UI.round.textContent=String(round);
  UI.prompt.textContent=`${cur.name}!`;
}

function judge(){
  // If pressed during GO and window open
  const ok = (phase==="GO" && windowT>20);
  if(ok){
    charge = Math.min(100, charge + 22);
    toast("Nice! Milo approves.", 900);
    pose=cur.pose;
    cheer=40;
  } else {
    charge = Math.max(0, charge - 10);
    toast("Off-beat. Try again.", 900);
  }
  phase="HIT";
  windowT = 30;
}

function finish(){
  // Convert charge to living room outfit hint
  if(charge>=80){
    state.roomFit="AUDITION";
    toast("You feel locked in. FIT set to AUDITION.", 1600);
  } else if(charge>=50){
    state.roomFit="DATE";
    toast("You feel warm. FIT set to DATE.", 1600);
  } else {
    state.roomFit="NORMAL";
    toast("You’re fine. FIT stays NORMAL.", 1600);
  }
  saveState();
}

let t=0;
setRound(1);
toast("Quick workout. Hit prompts on time.", 1400);

function loop(){
  t++;

  if(keysDown.has("e") && !loop._e){ goBack(); loop._e=1; }
  if(!keysDown.has("e")) loop._e=0;

  // input for prompts
  if(phase==="GO"){
    const pressed =
      (cur.key==="space" && (keysDown.has(" ")||keysDown.has("space"))) ||
      (cur.key==="shift" && keysDown.has("shift")) ||
      (cur.key==="c" && keysDown.has("c"));

    if(pressed && !loop._hit){
      judge();
      loop._hit=1;
    }
    if(!pressed) loop._hit=0;

    windowT--;
    if(windowT<=0){
      // auto miss if never hit
      if(phase==="GO"){
        charge=Math.max(0, charge-8);
        toast("Missed the prompt.", 900);
        phase="HIT";
        windowT=25;
      }
    }
  } else if(phase==="HIT"){
    windowT--;
    if(windowT<=0){
      if(round<5){
        setRound(round+1);
      } else {
        phase="DONE";
        finish();
        // stay on screen until user exits
      }
    }
  }

  if(cheer>0) cheer--;

  // draw
  ctx.fillStyle="#05050a"; ctx.fillRect(0,0,W,H);

  const g=ctx.createRadialGradient(160,64,10,160,64,190);
  g.addColorStop(0,"rgba(255,255,255,.06)");
  g.addColorStop(0.35,"rgba(0,255,213,.08)");
  g.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // floor + mat
  ctx.fillStyle="rgba(255,255,255,.05)"; ctx.fillRect(10,108,300,62);
  ctx.fillStyle="rgba(0,255,213,.06)"; ctx.fillRect(74,118,172,36);

  // timing bar
  ctx.fillStyle="rgba(255,255,255,.06)";
  ctx.fillRect(60,40,200,10);
  // window fill
  const prog = (phase==="GO") ? (windowT/95) : 0;
  ctx.fillStyle="rgba(138,46,255,.20)";
  ctx.fillRect(60,40, (200*prog)|0, 10);
  // sweet spot line
  ctx.fillStyle="rgba(255,255,255,.10)";
  ctx.fillRect(60+140,40,2,10);

  // characters
  drawSophia(150,92,pose);
  drawMilo(172,102,t,cheer>0);

  // charge display
  UI.charge.textContent = `${Math.round(charge)}%`;
  if(charge>0){
    ctx.fillStyle="rgba(255,255,255,.06)";
    ctx.fillRect(90,62,140,8);
    ctx.fillStyle="rgba(0,255,213,.12)";
    ctx.fillRect(90,62, (140*(charge/100))|0, 8);
  }

  // done overlay hint
  if(phase==="DONE"){
    ctx.fillStyle="rgba(0,0,0,.35)";
    ctx.fillRect(34,74,252,28);
    ctx.fillStyle="rgba(255,255,255,.9)";
    ctx.font="10px ui-monospace, monospace";
    ctx.fillText("WORKOUT COMPLETE. E TO RETURN.", 58, 92);
  }

  vignette();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
