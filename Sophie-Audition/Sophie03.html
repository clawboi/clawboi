<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Sophia's Audition 03 — Living Room</title>
<style>
  :root{ --bg:#07070b; --fg:#fff; --ui2:rgba(255,255,255,.14); --vio:#8a2eff;}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}

  /* same “Bedroom/Backyard” polish layer */
  body::before{
    content:"";
    position:fixed;
    inset:-20%;
    background:
      radial-gradient(circle at 20% 10%, rgba(138,46,255,.16), transparent 60%),
      radial-gradient(circle at 80% 40%, rgba(0,255,213,.10), transparent 65%),
      radial-gradient(circle at 50% 92%, rgba(138,46,255,.10), transparent 70%);
    filter:blur(40px) saturate(1.15);
    animation:drift 12s ease-in-out infinite;
    pointer-events:none;
  }
  body::after{
    content:"";
    position:fixed;
    inset:0;
    pointer-events:none;
    background:
      radial-gradient(1200px 900px at 50% 45%, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 70%, rgba(0,0,0,.60) 100%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.018) 0 1px, transparent 1px 4px);
    mix-blend-mode:overlay;
    opacity:.55;
  }
  @keyframes drift{0%,100%{transform:translate3d(0,0,0)}50%{transform:translate3d(1.5%, -1.5%,0)}}

  .wrap{height:100%; display:grid; place-items:center;}
  canvas{width:min(980px, 100vw); height:auto; image-rendering:pixelated; image-rendering:crisp-edges; touch-action:none;}

  .hud{
    position:fixed; left:12px; right:12px; top:12px; z-index:5;
    display:flex; gap:10px; flex-wrap:wrap; pointer-events:none;
  }
  .pill{
    pointer-events:auto; border:1px solid var(--ui2); background:rgba(0,0,0,.35);
    backdrop-filter: blur(8px);
    border-radius:999px; padding:10px 12px;
    font-size:11px; letter-spacing:.18em; text-transform:uppercase;
    display:flex; gap:10px; align-items:center;
  }
  .toast{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    border:1px solid var(--ui2); background:rgba(0,0,0,.55);
    border-radius:14px; padding:10px 12px;
    font-size:12px; letter-spacing:.08em; opacity:0; transition:.2s;
    max-width:min(720px, calc(100vw - 24px)); text-align:center;
    z-index:6;
  }
  .toast.on{opacity:1}
</style>
</head>
<body>
<div class="hud">
  <div class="pill"><b>SOPHIA</b> <span>LIVING ROOM</span></div>
  <div class="pill">TIME: <span id="time">10:00</span></div>
  <div class="pill">KEYS: <span id="keys">NO</span></div>
  <div class="pill">FIT: <span id="fit">NORMAL</span></div>
  <div class="pill">LUCAS: <span id="lucasMood">gaming</span></div>
  <div class="pill">Door → Bedroom (left) · Door → Kitchen (right) · Front Door (top)</div>
</div>
<div class="toast" id="toast"></div>
<div class="wrap"><canvas id="c" width="320" height="180"></canvas></div>

<script>
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d',{alpha:false});
ctx.imageSmoothingEnabled=false;

const UI={
  keys:document.getElementById('keys'),
  fit:document.getElementById('fit'),
  time:document.getElementById('time'),
  lucasMood:document.getElementById('lucasMood'),
  toast:document.getElementById('toast')
};

const STORE_KEY="SOPHIA_AUDITION_SAVE_V1";
const RUN_KEY="SOPHIA_AUDITION_RUN_V1";
const DURATION_MS=10*60*1000;

function loadState(){
  const r=localStorage.getItem(STORE_KEY);
  if(r){try{return JSON.parse(r);}catch(e){}}
  return {
    hasKeys:false, slept:false, trip:false, puke:false,
    poemLines:0, guitarPlayed:0, lastRoom:"LIVING",
    dressColor:"#a64dff", shoeColor:"#ffffff",
    roomFit:"NORMAL", // only applies in living room
    lucas:{state:"gaming", annoyed:0, follow:false, kissed:false},
    found:{couch:false, cabinet:false, table:false},
    sophia:{x:160,y:120}, milo:{x:148,y:132}
  };
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

function loadRun(){ const r=localStorage.getItem(RUN_KEY); if(r){try{return JSON.parse(r);}catch(e){}}
  return { startTime:0, durationMs:DURATION_MS, active:false, ended:false };
}
function saveRun(run){ localStorage.setItem(RUN_KEY, JSON.stringify(run)); }

let state=loadState();
state.lastRoom="LIVING";
state.found = state.found || {couch:false, cabinet:false, table:false};
state.lucas = state.lucas || {state:"gaming", annoyed:0, follow:false, kissed:false};
if(!state.roomFit) state.roomFit="NORMAL";
saveState();

function toast(msg,ms=1500){
  UI.toast.textContent=msg;
  UI.toast.classList.add('on');
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>UI.toast.classList.remove('on'),ms);
}

function syncHUD(){
  UI.keys.textContent = state.hasKeys ? "YES" : "NO";
  UI.fit.textContent = state.roomFit || "NORMAL";
  UI.lucasMood.textContent =
    state.lucas.follow ? "following" :
    (state.lucas.kissed ? "soft" : state.lucas.state || "gaming");
}
syncHUD();

/* ---------- TIMER GUARD (real countdown, 10 mins) ---------- */
function fmt(ms){
  ms=Math.max(0, ms|0);
  const s=Math.ceil(ms/1000);
  const m=(s/60)|0;
  const ss=String(s%60).padStart(2,"0");
  return `${m}:${ss}`;
}
function timeLeftMs(){
  const run=loadRun();
  if(!run.active || run.ended) return run.durationMs;
  return (run.startTime + run.durationMs - Date.now());
}
function tickTimer(){
  const left=timeLeftMs();
  UI.time.textContent = fmt(left);
  if(left<=0){
    const run=loadRun();
    run.ended=true; run.active=false;
    saveRun(run);
    toast("TIME UP. Audition missed.", 1800);
    setTimeout(()=>location.href="Sophie00.html", 900);
  }
}
setInterval(tickTimer, 250);
tickTimer();

/* input */
const keysDown=new Set();
addEventListener('keydown',(e)=>{
  const k=e.key.toLowerCase();
  if(["arrowup","arrowdown","arrowleft","arrowright"," ","shift","w","a","s","d","e","c"].includes(k)) e.preventDefault();
  keysDown.add(k);
});
addEventListener('keyup',(e)=>keysDown.delete(e.key.toLowerCase()));

/* world */
const W=canvas.width,H=canvas.height;

/* solids */
const solids=[
  [0,0,W,10],[0,0,10,H],[0,H-10,W,10],[W-10,0,10,H],
  // couch
  [58,82,88,26],
  // coffee table
  [118,114,42,14],
  // TV stand
  [216,62,66,20],
  // cabinet block
  [34,50,36,22],
  // lucas desk area (solid)
  [214,92,72,36],
];

/* zones */
const zones=[
  // SEARCH (always false for keys)
  {name:"SEARCH COUCH", rect:[64,86,76,18], action: searchCouch},
  {name:"SEARCH CABINET", rect:[36,52,32,18], action: searchCabinet},
  {name:"SEARCH TABLE", rect:[120,116,38,10], action: searchTable},

  // doors
  {name:"DOOR_BEDROOM", rect:[10,78,10,28], action: ()=>go("Sophie01.html")},
  {name:"DOOR_KITCHEN", rect:[W-20,78,10,28], action: ()=>go("Sophie04.html")},
  {name:"FRONT DOOR", rect:[148,10,24,10], action: exitToStreet},

  // TV / workout / train milo
  {name:"WATCH TV", rect:[230,58,46,30], action: ()=>go("tv.html")},
  {name:"WORKOUT", rect:[28,120,34,18], action: ()=>go("workout.html")},
  {name:"TRAIN MILO", rect:[86,128,26,14], action: ()=>go("trainmilo.html")},

  // living-room-only outfits
  {name:"DRESS UP", rect:[176,126,18,10], action: cycleLivingFit},

  // paintings (with Lucas conditional line)
  {name:"PAINTING A", rect:[92,22,26,16], action: ()=>inspectPainting("A")},
  {name:"PAINTING B", rect:[132,24,28,16], action: ()=>inspectPainting("B")},
  {name:"PAINTING C", rect:[172,22,26,16], action: ()=>inspectPainting("C")},

  // lucas
  {name:"BUG LUCAS", rect:[236,110,36,18], action: bugLucas},
  {name:"KISS", rect:[0,0,0,0], action: kissLucas, dynamic:true}, // rect updated at runtime when follow=true
];

const sophia={x:state.sophia.x,y:state.sophia.y,w:10,h:12,speed:0.85,run:1.35};
const milo={x:state.milo.x,y:state.milo.y,w:8,h:8};

const lucas={
  x: 244, y: 108, w: 10, h: 12,
  tx: 244, ty: 108,
};

function rectsOverlap(ax,ay,aw,ah,bx,by,bw,bh){
  return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by;
}
function collides(x,y,w,h){
  for(const s of solids){
    if(rectsOverlap(x,y,w,h,s[0],s[1],s[2],s[3])) return true;
  }
  return false;
}
function tryMove(ent,dx,dy){
  const nx=ent.x+dx, ny=ent.y+dy;
  if(!collides(nx,ent.y,ent.w,ent.h)) ent.x=nx;
  if(!collides(ent.x,ny,ent.w,ent.h)) ent.y=ny;
}

/* nearest interactable (zones + dynamic KISS when Lucas follows) */
function nearestZone(){
  const px=sophia.x+sophia.w/2, py=sophia.y+sophia.h/2;
  let best=null, bd=9999;

  // update dynamic kiss zone if lucas is following
  const kz = zones.find(z=>z.name==="KISS");
  if(state.lucas.follow){
    kz.rect = [ (lucas.x-6)|0, (lucas.y-8)|0, 22, 22 ];
  }else{
    kz.rect = [0,0,0,0];
  }

  for(const z of zones){
    const [x,y,w,h]=z.rect;
    if(!w || !h) continue;
    const cx=x+w/2, cy=y+h/2;
    const d=(cx-px)*(cx-px)+(cy-py)*(cy-py);
    if(d<bd && d<1500){ bd=d; best=z; }
  }
  return best;
}
function interact(){ const z=nearestZone(); if(z) z.action(); }

/* ---------- KEY SEARCH LOGIC (NO KEYS HERE) ---------- */
function searchCouch(){
  if(state.found.couch) return toast("Couch already searched.", 1300);
  state.found.couch=true; saveState();
  toast("You dig through cushions. Receipts. A pen. No keys.", 1700);
}
function searchCabinet(){
  if(state.found.cabinet) return toast("Cabinet already searched.", 1300);
  state.found.cabinet=true; saveState();
  toast("Cabinet: candles, tape, a weird button. No keys.", 1700);
}
function searchTable(){
  if(state.found.table) return toast("Table: crumbs, hair ties, a note: 'MOVE FASTER'.", 1700);
  state.found.table=true; saveState();
}

/* ---------- OUTFIT (living-room-only) ---------- */
const fits=["NORMAL","DATE","AUDITION","COMFY"];
function cycleLivingFit(){
  const cur = state.roomFit || "NORMAL";
  const idx = (fits.indexOf(cur)+1) % fits.length;
  state.roomFit = fits[idx];
  saveState();
  syncHUD();
  toast(`Changed outfit: ${state.roomFit}. (Living Room only)`, 1600);
}

/* ---------- FRONT DOOR ---------- */
function exitToStreet(){
  if(!state.hasKeys) return toast("Front door won’t budge. Keys first (backyard gnome).", 1600);
  toast("Front door opens. Street noise leaks in.", 1600);
  setTimeout(()=>go("street.html"), 450);
}

/* ---------- PAINTINGS ---------- */
function inspectPainting(which){
  const lines={
    A:"A storm over a quiet city. Feels… familiar.",
    B:"A violet comet. Like the sky remembered something.",
    C:"A small house under a giant moon. Cozy but haunted."
  };
  toast(lines[which] || "A painting.", 1700);

  // Lucas adds a line if he's following you
  if(state.lucas.follow){
    setTimeout(()=>{
      toast("Lucas: Aren’t you late for that audition? Maybe check the backyard for your keys.", 2200);
    }, 900);
  }
}

/* ---------- LUCAS ---------- */
function bugLucas(){
  if(state.lucas.follow) return toast("Lucas is already following you.", 1300);

  state.lucas.annoyed = (state.lucas.annoyed||0) + 1;
  saveState();

  const a = state.lucas.annoyed;
  if(a===1) toast("Sophia: Babe…", 1100);
  else if(a===2) toast("Lucas: One sec. I’m in a match.", 1500);
  else if(a===3) toast("Lucas: You’re doing that thing again.", 1500);
  else if(a>=4){
    state.lucas.follow=true;
    state.lucas.state="standing";
    saveState();
    syncHUD();
    toast("Lucas stands up. He follows you now.", 1700);
  }
}

function kissLucas(){
  if(!state.lucas.follow) return toast("Lucas is busy gaming. Bug him first.", 1500);

  const px=sophia.x+sophia.w/2, py=sophia.y+sophia.h/2;
  const lx=lucas.x+lucas.w/2, ly=lucas.y+lucas.h/2;
  const d=(px-lx)*(px-lx)+(py-ly)*(py-ly);
  if(d>900) return toast("Get closer to Lucas.", 1200);

  state.lucas.kissed=true;
  saveState();
  syncHUD();
  toast("You kiss Lucas. He smiles like he forgot the game existed.", 2000);
}

/* navigation */
function go(file){
  state.sophia.x=sophia.x; state.sophia.y=sophia.y;
  state.milo.x=milo.x; state.milo.y=milo.y;
  saveState();
  location.href=file;
}

/* ---------- render helpers ---------- */
function drawRectBevel(x,y,w,h,fill){
  ctx.fillStyle=fill; ctx.fillRect(x,y,w,h);
  ctx.fillStyle="rgba(255,255,255,.08)"; ctx.fillRect(x,y,w,1);
  ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(x,y+h-1,w,1);
  ctx.fillStyle="rgba(255,255,255,.06)"; ctx.fillRect(x,y,1,h);
  ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(x+w-1,y,1,h);
}
function drawHintBubble(text,x,y){
  const pad=3;
  ctx.font="8px ui-monospace, monospace";
  const m=ctx.measureText(text);
  const w=Math.ceil(m.width)+pad*2, h=12;
  ctx.fillStyle="rgba(0,0,0,.65)"; ctx.fillRect((x-w/2)|0,(y-h)|0,w,h);
  ctx.strokeStyle="rgba(255,255,255,.12)"; ctx.strokeRect((x-w/2+0.5)|0,(y-h+0.5)|0,w-1,h-1);
  ctx.fillStyle="rgba(255,255,255,.9)"; ctx.fillText(text,(x-w/2+pad)|0,(y-4)|0);
}
function vignette(){
  ctx.fillStyle="rgba(0,0,0,.20)";
  ctx.fillRect(0,0,W,12); ctx.fillRect(0,H-12,W,12);
  ctx.fillRect(0,0,12,H); ctx.fillRect(W-12,0,12,H);
}

/* ---------- sprites ---------- */
function drawSophia(){
  const x=Math.round(sophia.x), y=Math.round(sophia.y);
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(x-1,y+11,12,2);

  // subtle fit tint (living room only)
  const fit = state.roomFit || "NORMAL";
  const fitColor =
    fit==="DATE" ? "rgba(255,77,136,.18)" :
    fit==="AUDITION" ? "rgba(0,255,213,.14)" :
    fit==="COMFY" ? "rgba(255,210,77,.14)" :
    "rgba(138,46,255,.12)";

  // hair/head
  ctx.fillStyle="#f2d27a"; ctx.fillRect(x+1,y+0,8,4); ctx.fillRect(x+0,y+3,10,3);
  // face
  ctx.fillStyle="#ffd9c9"; ctx.fillRect(x+2,y+5,6,4);
  // eyes
  ctx.fillStyle="#67b7ff"; ctx.fillRect(x+3,y+6,1,1); ctx.fillRect(x+6,y+6,1,1);
  // dress
  ctx.fillStyle="rgba(138,46,255,.55)"; ctx.fillRect(x+2,y+9,6,3);
  // overlay tint for chosen fit
  ctx.fillStyle=fitColor; ctx.fillRect(x+1,y+8,8,6);
  // sparkle stitch
  ctx.fillStyle="rgba(255,255,255,.14)"; ctx.fillRect(x+3,y+10,4,1);
}
function drawMilo(t){
  const x=Math.round(milo.x), y=Math.round(milo.y);
  ctx.fillStyle="rgba(0,0,0,.40)"; ctx.fillRect(x-1,y+7,10,2);
  ctx.fillStyle="#d8d8d8"; ctx.fillRect(x+1,y+2,6,5);
  ctx.fillStyle="#cfcfcf"; ctx.fillRect(x+1,y+1,2,2); ctx.fillRect(x+5,y+1,2,2);
  ctx.fillStyle="#1affd3"; ctx.fillRect(x+2,y+4,1,1); ctx.fillRect(x+5,y+4,1,1);
  ctx.fillStyle="#cfcfcf"; ctx.fillRect(x+7,y+3,1,3);
}
function drawLucas(t){
  const x=Math.round(lucas.x), y=Math.round(lucas.y);
  // shadow
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(x-1,y+11,12,2);

  // hair (brown)
  ctx.fillStyle="rgba(120,70,40,.45)"; ctx.fillRect(x+1,y+0,8,4);
  // face
  ctx.fillStyle="rgba(255,217,201,.95)"; ctx.fillRect(x+2,y+4,6,4);
  // eyes
  ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(x+3,y+5,1,1); ctx.fillRect(x+6,y+5,1,1);

  // hoodie/body
  const mood = state.lucas.follow ? "rgba(0,255,213,.12)" : "rgba(255,255,255,.08)";
  ctx.fillStyle="rgba(255,255,255,.06)"; ctx.fillRect(x+2,y+8,6,4);
  ctx.fillStyle=mood; ctx.fillRect(x+1,y+7,8,6);

  // controller blink if gaming
  if(!state.lucas.follow && (t%20<10)){
    ctx.fillStyle="rgba(0,255,213,.30)";
    ctx.fillRect(x+4,y+10,2,1);
  }

  // little heart after kiss
  if(state.lucas.kissed && (t%30<12)){
    ctx.fillStyle="rgba(255,77,136,.30)";
    ctx.fillRect(x+12,y-2,1,1);
    ctx.fillRect(x+13,y-3,1,1);
    ctx.fillRect(x+14,y-2,1,1);
    ctx.fillRect(x+13,y-1,1,1);
  }
}

/* ---------- world render ---------- */
function drawWorld(t){
  ctx.fillStyle="#05050a"; ctx.fillRect(0,0,W,H);

  // soft room glow
  const g=ctx.createRadialGradient(160,64,10,160,64,180);
  g.addColorStop(0,"rgba(255,255,255,.06)");
  g.addColorStop(0.35,"rgba(138,46,255,.10)");
  g.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // walls
  ctx.fillStyle="rgba(255,255,255,.06)"; ctx.fillRect(10,10,W-20,78);

  // floor scanlines
  for(let y=92;y<H-10;y++){
    ctx.fillStyle=`rgba(255,255,255,${(y%6===0)?0.10:0.05})`;
    ctx.fillRect(10,y,W-20,1);
  }

  // paintings (actual visuals)
  // A
  drawRectBevel(92,22,26,16,"rgba(255,255,255,.04)");
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(94,24,22,12);
  ctx.fillStyle="rgba(138,46,255,.18)"; ctx.fillRect(96,26,8,6);
  ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(106,28,8,4);
  // B
  drawRectBevel(132,24,28,16,"rgba(255,255,255,.04)");
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(134,26,24,12);
  ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(138,30,6,1);
  ctx.fillStyle="rgba(138,46,255,.22)"; ctx.fillRect(146,28,2,2);
  ctx.fillStyle="rgba(0,255,213,.10)"; ctx.fillRect(150,32,4,1);
  // C
  drawRectBevel(172,22,26,16,"rgba(255,255,255,.04)");
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(174,24,22,12);
  ctx.fillStyle="rgba(255,210,77,.12)"; ctx.fillRect(176,30,6,3);
  ctx.fillStyle="rgba(255,255,255,.08)"; ctx.fillRect(184,26,6,1);

  // cabinet
  drawRectBevel(34,50,36,22,"rgba(255,255,255,.05)");
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(38,54,28,14);

  // couch
  drawRectBevel(58,82,88,26,"rgba(255,255,255,.06)");
  ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(62,86,80,10);

  // coffee table
  drawRectBevel(118,114,42,14,"rgba(255,255,255,.05)");

  // workout mat zone marker
  drawRectBevel(28,120,34,18,"rgba(255,255,255,.04)");
  ctx.fillStyle="rgba(0,255,213,.06)"; ctx.fillRect(30,122,30,14);

  // "train milo" toy
  drawRectBevel(86,128,26,14,"rgba(255,255,255,.04)");
  ctx.fillStyle="rgba(255,77,136,.10)"; ctx.fillRect(90,133,18,3);

  // TV stand + screen
  drawRectBevel(216,62,66,20,"rgba(255,255,255,.05)");
  ctx.fillStyle="rgba(0,0,0,.55)"; ctx.fillRect(220,64,58,12);
  // subtle screen flicker
  if(t%18<9){
    ctx.fillStyle="rgba(138,46,255,.08)"; ctx.fillRect(220,64,58,12);
  }else{
    ctx.fillStyle="rgba(0,255,213,.05)"; ctx.fillRect(220,64,58,12);
  }

  // Lucas desk
  drawRectBevel(214,92,72,36,"rgba(255,255,255,.04)");
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(218,96,64,8);
  ctx.fillStyle="rgba(255,255,255,.06)"; ctx.fillRect(220,106,22,10); // chair chunk

  // dress-up pile
  drawRectBevel(176,126,18,10,"rgba(255,255,255,.04)");
  ctx.fillStyle="rgba(138,46,255,.10)"; ctx.fillRect(178,128,14,6);

  // doors
  ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(10,78,10,28);
  ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(W-20,78,10,28);

  // front door (top center)
  ctx.fillStyle = state.hasKeys ? "rgba(0,255,213,.16)" : "rgba(255,255,255,.08)";
  ctx.fillRect(148,10,24,10);
  ctx.fillStyle="rgba(0,0,0,.55)"; ctx.fillRect(150,12,20,6);

  // hint
  const z=nearestZone();
  if(z) drawHintBubble(z.name, sophia.x+6, sophia.y-10);

  vignette();
}

/* ---------- lucas movement ---------- */
function updateLucas(){
  if(!state.lucas.follow){
    lucas.tx = 244; lucas.ty = 108;
  }else{
    // follow Sophia with a comfy offset, avoid jitter
    lucas.tx = sophia.x - 14;
    lucas.ty = sophia.y + 2;
  }

  // ease towards target
  lucas.x += (lucas.tx - lucas.x)*0.08;
  lucas.y += (lucas.ty - lucas.y)*0.08;

  // keep inside bounds a bit
  lucas.x = Math.max(12, Math.min(W-22, lucas.x));
  lucas.y = Math.max(18, Math.min(H-22, lucas.y));
}

/* loop */
let t=0;
function loop(){
  t++;

  // movement
  const run=keysDown.has("shift");
  const sp=sophia.speed*(run?sophia.run:1);
  let dx=0,dy=0;
  if(keysDown.has("w")||keysDown.has("arrowup")) dy-=sp;
  if(keysDown.has("s")||keysDown.has("arrowdown")) dy+=sp;
  if(keysDown.has("a")||keysDown.has("arrowleft")) dx-=sp;
  if(keysDown.has("d")||keysDown.has("arrowright")) dx+=sp;
  if(dx&&dy){dx*=0.72; dy*=0.72;}
  if(dx||dy) tryMove(sophia,dx,dy);

  // Milo follow
  const tx=sophia.x-10, ty=sophia.y+6;
  milo.x += (tx-milo.x)*0.06;
  milo.y += (ty-milo.y)*0.06;

  updateLucas();
  syncHUD();

  // interact
  if(keysDown.has("e")){
    if(!loop._eWasDown) interact();
    loop._eWasDown=true;
  } else loop._eWasDown=false;

  if(t%60===0){
    state.sophia.x=sophia.x; state.sophia.y=sophia.y;
    state.milo.x=milo.x; state.milo.y=milo.y;
    saveState();
  }

  drawWorld(t);
  drawMilo(t);
  drawLucas(t);
  drawSophia();

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
