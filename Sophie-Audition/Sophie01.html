<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Sophia's Audition 01 — Bedroom</title>
<style>
:root{ --bg:#07070b; --fg:#fff; --ui:rgba(255,255,255,.08); --ui2:rgba(255,255,255,.14); --vio:#8a2eff;}
html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
.wrap{height:100%; display:grid; place-items:center;}
canvas{
  width:min(1180px, 100vw);
  height:auto;
  image-rendering:pixelated;
  image-rendering:crisp-edges;
  touch-action:none;
  outline:none;
}

body::before{
  content:"";
  position:fixed;
  inset:-20%;
  background:
    radial-gradient(circle at 18% 12%, rgba(255,170,255,.15), transparent 60%),
    radial-gradient(circle at 82% 44%, rgba(160,255,240,.12), transparent 65%),
    radial-gradient(circle at 50% 85%, rgba(138,46,255,.10), transparent 60%);
  filter:blur(42px);
  animation:drift 12s ease-in-out infinite;
  pointer-events:none;
}
@keyframes drift{0%,100%{transform:translate3d(0,0,0)}50%{transform:translate3d(1.5%,-1.5%,0)}}

.hud{
  position:fixed; left:12px; right:12px; top:12px; z-index:5;
  display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap;
  pointer-events:none;
}
.pill{
  pointer-events:auto;
  border:1px solid var(--ui2); background:rgba(0,0,0,.35);
  backdrop-filter: blur(8px);
  border-radius:999px; padding:10px 12px;
  font-size:11px; letter-spacing:.18em; text-transform:uppercase;
  display:flex; gap:10px; align-items:center;
}
.pill b{letter-spacing:.22em}
.hint{
  pointer-events:auto;
  flex:1 1 260px;
  border:1px solid var(--ui2); background:rgba(0,0,0,.35);
  backdrop-filter: blur(8px);
  border-radius:18px; padding:10px 12px;
  font-size:11px; letter-spacing:.10em; line-height:1.35;
}
.hint .k{display:inline-block; padding:2px 7px; border-radius:8px; border:1px solid var(--ui2); background:rgba(255,255,255,.06); font-weight:700}
.toast{
  position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
  border:1px solid var(--ui2); background:rgba(0,0,0,.55);
  border-radius:14px; padding:10px 12px;
  font-size:12px; letter-spacing:.08em; opacity:0; transition:.2s;
  max-width:min(760px, calc(100vw - 24px)); text-align:center;
}
.toast.on{opacity:1}

/* poem modal */
#poemBox{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); z-index:9;}
#poemBox textarea{width:320px;height:190px;background:#0b0b12;color:#fff;border:1px solid var(--ui2);padding:10px;font-family:monospace;border-radius:12px;}
#poemBox button{margin-top:8px;background:var(--vio);border:none;color:white;padding:8px 16px;cursor:pointer;border-radius:10px;}
</style>
</head>
<body>

<div class="hud">
  <div class="pill"><b>SOPHIA</b> <span id="status">BEDROOM</span></div>
  <div class="pill">MILO: <span id="miloMood">following</span></div>
  <div class="pill">KEYS: <span id="keys">NO</span></div>
  <div class="hint">
    Move: <span class="k">WASD</span> · Interact: <span class="k">E</span> · Run: <span class="k">SHIFT</span> · Click/Tap = interact<br>
    Desk = write poetry · Guitar = play · Clothes = change outfit · Bed = sleep · Doors lead out
  </div>
</div>

<div class="toast" id="toast"></div>

<div id="poemBox">
  <div>
    <textarea id="poemInput" placeholder="Write poetry..."></textarea><br>
    <button id="poemSaveBtn">Save Line</button>
  </div>
</div>

<!-- Bigger internal resolution so the room feels larger -->
<div class="wrap"><canvas id="c" width="480" height="270" tabindex="0"></canvas></div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha:false });
  ctx.imageSmoothingEnabled = false;

  const statusEl = document.getElementById("status");
  const keysEl = document.getElementById("keys");
  const miloMoodEl = document.getElementById("miloMood");
  const toastEl = document.getElementById("toast");
  const poemBoxEl = document.getElementById("poemBox");
  const poemInputEl = document.getElementById("poemInput");
  const poemSaveBtn = document.getElementById("poemSaveBtn");

  const STORE_KEY="SOPHIA_AUDITION_SAVE_V1";
  let state = JSON.parse(localStorage.getItem(STORE_KEY) || `{
    "hasKeys":false,"slept":false,"trip":false,"puke":false,
    "poemLines":0,"poems":[],"guitarPlayed":0,
    "outfit":0,
    "lastRoom":"BEDROOM",
    "sophia":{"x":60,"y":200},
    "milo":{"50":190,"y":215}
  }`);

  function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

  const W = canvas.width, H = canvas.height;

  statusEl.textContent = "BEDROOM";
  keysEl.textContent = state.hasKeys ? "YES" : "NO";
  miloMoodEl.textContent = "following";

  /* ---------- controls ---------- */
  const keysDown = new Set();
  const held = { e:false };

  function keyName(e){ return (e.key || "").toLowerCase(); }

  window.addEventListener("keydown", (e) => {
    if(["arrowup","arrowdown","arrowleft","arrowright"," "].includes(keyName(e))) e.preventDefault();
    keysDown.add(keyName(e));
  }, { passive:false });

  window.addEventListener("keyup", (e) => keysDown.delete(keyName(e)));

  window.addEventListener("pointerdown", () => canvas.focus(), { passive:true });

  /* ---------- helpers ---------- */
  const SX = W/320, SY = H/180;
  const S = (x)=>Math.round(x*SX);
  const T = (y)=>Math.round(y*SY);
  const SW = (w)=>Math.round(w*SX);
  const SH = (h)=>Math.round(h*SY);

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("on");
    setTimeout(()=>toastEl.classList.remove("on"), 1500);
  }

  /* ---------- poem modal ---------- */
  function savePoem(){
    const t = poemInputEl.value.trim();
    if(!t) return;
    state.poems.push(t);
    state.poemLines++;
    poemInputEl.value="";
    save();
    poemBoxEl.style.display="none";
    toast("Poetry saved.");
  }
  poemSaveBtn.addEventListener("click", savePoem);
  window.savePoem = savePoem;

  /* ---------- ROOM GEOMETRY (same layout, scaled) ---------- */
  // thickness
  const WALL = T(10);

  // Furniture as 3D boxes: x,y,w,h,depth (depth is vertical extrusion)
  const furniture = {
    desk:   { x:S(38),  y:T(48),  w:SW(90), h:SH(34), d:T(8)  },
    bed:    { x:S(210), y:T(42),  w:SW(78), h:SH(42), d:T(10) },
    guitar: { x:S(52),  y:T(118), w:SW(22), h:SH(30), d:T(6)  },
    dresser:{ x:S(132), y:T(86),  w:SW(56), h:SH(18), d:T(7)  },
    clothes:{ x:S(90),  y:T(130), w:SW(40), h:SH(20), d:T(5)  }
  };

  // Solids should block only the "footprint" of furniture
  const solids = [
    [0,0,W,WALL],[0,0,S(10),H],[0,H-WALL,W,WALL],[W-S(10),0,S(10),H],
    [furniture.desk.x, furniture.desk.y, furniture.desk.w, furniture.desk.h],
    [furniture.bed.x, furniture.bed.y, furniture.bed.w, furniture.bed.h],
    [furniture.guitar.x, furniture.guitar.y, furniture.guitar.w, furniture.guitar.h],
    [furniture.dresser.x, furniture.dresser.y, furniture.dresser.w, furniture.dresser.h],
    [furniture.clothes.x, furniture.clothes.y, furniture.clothes.w, furniture.clothes.h],
  ];

  const zones = [
    {name:"DESK", rect:[S(44),T(52),SW(78),SH(26)], action:()=>location.href="poetry.html"},
    {name:"BED", rect:[S(216),T(46),SW(66),SH(34)], action:()=>{ state.slept=true; save(); toast("She sleeps. Audition gone."); }},
    {name:"GUITAR", rect:[S(48),T(122),SW(32),SH(26)], action:()=>location.href="guitar.html"},
    {name:"CLOTHES", rect:[S(90),T(130),SW(40),SH(20)], action:changeOutfit},
    {name:"DOOR_LIVING", rect:[W-S(24),T(78),S(14),SH(28)], action:()=>go("Sophie03.html")},
    {name:"DOOR_YARD", rect:[S(154),H-T(20),SW(34),T(10)], action:()=>go("Sophie02.html")}
  ];

  function changeOutfit(){
    state.outfit=(state.outfit+1)%4;
    save();
    toast("Outfit changed.");
  }

  /* ---------- entities ---------- */
  // Bigger sprite but still fits around furniture
  const sophia = { x: state.sophia.x, y: state.sophia.y, w:S(14), h:T(18) };
  // spawn safety fix
if(col(sophia.x, sophia.y, sophia.w, sophia.h)){
  sophia.x = S(60);
  sophia.y = T(150);
}
  const milo   = { x: state.milo.x,   y: state.milo.y };

  // Safety: if saved position is inside a solid (old versions), reset to safe spot
  function insideSolid(px,py,pw,ph){
    for(const s of solids){
      if(px < s[0]+s[2] && px+pw > s[0] && py < s[1]+s[3] && py+ph > s[1]) return true;
    }
    return false;
  }
  if(insideSolid(sophia.x,sophia.y,sophia.w,sophia.h)){
    sophia.x = S(160);
    sophia.y = T(140);
  }

  function move(dx,dy){
    if(!insideSolid(sophia.x+dx,sophia.y,sophia.w,sophia.h)) sophia.x += dx;
    if(!insideSolid(sophia.x,sophia.y+dy,sophia.w,sophia.h)) sophia.y += dy;
  }

  function nearest(){
    let best=null, bd=1e18;
    const px = sophia.x + sophia.w/2;
    const py = sophia.y + sophia.h/2;
    const MAX = (S(44)*S(44));
    for(const z of zones){
      const cx=z.rect[0]+z.rect[2]/2;
      const cy=z.rect[1]+z.rect[3]/2;
      const d=(cx-px)**2+(cy-py)**2;
      if(d<bd && d<MAX){ bd=d; best=z; }
    }
    return best;
  }

  function interact(){
    const z=nearest();
    if(z) z.action();
    else toast("Nothing to interact with.");
  }

  canvas.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    canvas.focus();
    interact();
  }, { passive:false });

  function updateMilo(){
    const tx = sophia.x - S(18);
    const ty = sophia.y + T(10);
    milo.x += (tx - milo.x) * .06;
    milo.y += (ty - milo.y) * .06;
    if(Math.random()<.0016) toast("Milo: meow ♡");
  }

  /* ---------- render: 2.5D boxes ---------- */
  function box3D(x,y,w,h,d, top, front, side, stroke){
    // shadow on floor
    ctx.fillStyle="rgba(0,0,0,.22)";
    ctx.fillRect(x+S(2), y+h-S(2), w-S(4), S(4));

    // top face (slightly above)
    ctx.fillStyle=top;
    ctx.fillRect(x, y-d, w, d);

    // side face (right)
    ctx.fillStyle=side;
    ctx.fillRect(x+w-d, y-d, d, h);

    // front face
    ctx.fillStyle=front;
    ctx.fillRect(x, y, w, h);

    // outline
    if(stroke){
      ctx.strokeStyle=stroke;
      ctx.strokeRect(x+.5, y+.5, w, h);
      ctx.strokeRect(x+.5, y-d+.5, w, d);
    }
  }

  function rrect(x,y,w,h,r,fill,stroke){
    r=Math.max(0,Math.min(r,Math.min(w,h)/2));
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
    if(fill){ ctx.fillStyle=fill; ctx.fill(); }
    if(stroke){ ctx.strokeStyle=stroke; ctx.stroke(); }
  }

  function bg(){
    ctx.fillStyle="#05050a";
    ctx.fillRect(0,0,W,H);

    // room glow
    let g=ctx.createRadialGradient(S(90),T(55),S(12),S(90),T(55),S(240));
    g.addColorStop(0,"rgba(255,170,255,.16)");
    g.addColorStop(.55,"rgba(138,46,255,.08)");
    g.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle=g;
    ctx.fillRect(0,0,W,H);

    let g2=ctx.createRadialGradient(S(260),T(90),S(8),S(260),T(90),S(230));
    g2.addColorStop(0,"rgba(160,255,240,.12)");
    g2.addColorStop(.6,"rgba(0,255,213,.06)");
    g2.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle=g2;
    ctx.fillRect(0,0,W,H);

    // wall panel
    rrect(S(12),T(12),W-S(24),T(110),S(10),"rgba(255,255,255,.04)","rgba(255,255,255,.10)");

    // floor pattern (depth)
    for(let y=T(112); y<H-T(10); y+=2){
      const a = (y%10===0) ? .075 : .035;
      ctx.fillStyle=`rgba(255,255,255,${a})`;
      ctx.fillRect(S(10),y,W-S(20),1);
    }

    // rug (adds depth cue)
    rrect(S(120),T(120),SW(90),SH(44),S(10),"rgba(255,255,255,.05)","rgba(255,255,255,.10)");
  }

  function drawFurniture(){
    // Desk (cute lavender)
    const D = furniture.desk;
    box3D(D.x,D.y,D.w,D.h,D.d,
      "rgba(190,160,255,.13)",
      "rgba(190,160,255,.08)",
      "rgba(140,120,200,.10)",
      "rgba(255,255,255,.12)"
    );
    // little monitor on desk top
    rrect(D.x+S(14), D.y-D.d+T(4), SW(18), T(10), S(4), "rgba(0,0,0,.35)","rgba(255,255,255,.14)");

    // Bed (soft teal)
    const B = furniture.bed;
    box3D(B.x,B.y,B.w,B.h,B.d,
      "rgba(160,255,240,.12)",
      "rgba(160,255,240,.07)",
      "rgba(110,190,180,.10)",
      "rgba(255,255,255,.12)"
    );
    // pillow
    rrect(B.x+S(10), B.y+T(8), SW(24), T(10), S(6), "rgba(255,255,255,.10)","rgba(255,255,255,.14)");
    // blanket stripe
    rrect(B.x+S(8), B.y+T(22), B.w-S(16), T(10), S(6), "rgba(255,170,255,.08)","rgba(255,170,255,.12)");

    // Dresser (warm)
    const R = furniture.dresser;
    box3D(R.x,R.y,R.w,R.h,R.d,
      "rgba(255,220,160,.10)",
      "rgba(255,220,160,.06)",
      "rgba(200,160,110,.09)",
      "rgba(255,255,255,.12)"
    );
    // drawers
    for(let i=0;i<2;i++){
      rrect(R.x+S(8), R.y+T(4+i*7), R.w-S(16), T(6), S(4), "rgba(0,0,0,.12)","rgba(255,255,255,.08)");
    }

    // Clothes pile (pink puff)
    const C = furniture.clothes;
    box3D(C.x,C.y,C.w,C.h,C.d,
      "rgba(255,170,255,.12)",
      "rgba(255,170,255,.07)",
      "rgba(200,120,180,.09)",
      "rgba(255,255,255,.12)"
    );

    // Guitar stand (tiny prop)
    const G = furniture.guitar;
    box3D(G.x,G.y,G.w,G.h,G.d,
      "rgba(255,255,255,.08)",
      "rgba(255,255,255,.05)",
      "rgba(255,255,255,.07)",
      "rgba(255,255,255,.12)"
    );

    // Door glow cues
    rrect(W-S(26),T(76),S(18),SH(32),S(6),"rgba(0,255,213,.08)","rgba(0,255,213,.16)");
    rrect(S(152),H-T(22),SW(38),T(12),S(6),"rgba(0,255,213,.08)","rgba(0,255,213,.16)");
  }

  /* ---------- sprites: cute chibi, still pixel ---------- */
  function drawSophia(){
    const x=Math.round(sophia.x), y=Math.round(sophia.y);
    const outfits=[
      {dress:"#b98bff", bow:"#ffd1ff"},
      {dress:"#8fffe9", bow:"#d7f7ff"},
      {dress:"#ff85b2", bow:"#ffe0ea"},
      {dress:"#ffe07a", bow:"#fff0bf"}
    ];
    const o = outfits[state.outfit];

    // shadow
    ctx.fillStyle="rgba(0,0,0,.26)";
    ctx.fillRect(x+S(3), y+T(16), S(10), T(2));

    // hair
    ctx.fillStyle="#f2d27a";
    ctx.fillRect(x+S(3), y+T(0), S(8), T(5));
    ctx.fillRect(x+S(2), y+T(2), S(10), T(5));
    ctx.fillRect(x+S(3), y+T(5), S(2), T(2));
    ctx.fillRect(x+S(8), y+T(5), S(2), T(2));

    // face
    ctx.fillStyle="#ffd9c9";
    ctx.fillRect(x+S(3), y+T(6), S(8), T(7));

    // eyes
    ctx.fillStyle="#1a0f2a";
    ctx.fillRect(x+S(4), y+T(8), S(2), T(2));
    ctx.fillRect(x+S(8), y+T(8), S(2), T(2));
    ctx.fillStyle="#67b7ff";
    ctx.fillRect(x+S(4), y+T(9), S(1), T(1));
    ctx.fillRect(x+S(8), y+T(9), S(1), T(1));

    // blush
    ctx.fillStyle="rgba(255,120,160,.22)";
    ctx.fillRect(x+S(3), y+T(11), S(2), T(1));
    ctx.fillRect(x+S(9), y+T(11), S(2), T(1));

    // bow
    ctx.fillStyle=o.bow;
    ctx.fillRect(x+S(6), y+T(5), S(2), T(1));
    ctx.fillRect(x+S(5), y+T(4), S(1), T(2));
    ctx.fillRect(x+S(8), y+T(4), S(1), T(2));

    // dress
    ctx.fillStyle=o.dress;
    ctx.fillRect(x+S(4), y+T(13), S(6), T(4));
    ctx.fillRect(x+S(3), y+T(14), S(8), T(4));

    // sleeves
    ctx.fillStyle="rgba(255,255,255,.22)";
    ctx.fillRect(x+S(2), y+T(14), S(2), T(2));
    ctx.fillRect(x+S(10), y+T(14), S(2), T(2));
  }

  function drawMilo(){
    const x=Math.round(milo.x), y=Math.round(milo.y);

    ctx.fillStyle="rgba(0,0,0,.22)";
    ctx.fillRect(x+S(2), y+T(9), S(10), T(2));

    ctx.fillStyle="#e6e6ef";
    ctx.fillRect(x+S(2), y+T(4), S(10), T(6));
    ctx.fillRect(x+S(3), y+T(3), S(8), T(6));
    ctx.fillRect(x+S(2), y+T(3), S(2), T(2));
    ctx.fillRect(x+S(10), y+T(3), S(2), T(2));

    ctx.fillStyle="#1a0f2a";
    ctx.fillRect(x+S(5), y+T(6), S(1), T(1));
    ctx.fillRect(x+S(8), y+T(6), S(1), T(1));
    ctx.fillStyle="#1affd3";
    ctx.fillRect(x+S(5), y+T(5), S(1), T(1));
    ctx.fillRect(x+S(8), y+T(5), S(1), T(1));

    ctx.fillStyle="rgba(255,120,160,.30)";
    ctx.fillRect(x+S(6), y+T(8), S(2), T(1));
  }

  function drawInteractHint(){
    const z=nearest();
    if(!z) return;
    rrect(S(12), H-T(30), S(220), T(18), S(8), "rgba(0,0,0,.50)", "rgba(255,255,255,.18)");
    ctx.fillStyle="rgba(255,255,255,.95)";
    ctx.font = `${T(10)}px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial`;
    ctx.fillText(`Press E or tap: ${z.name}`, S(22), H-T(18));
  }

  /* ---------- loop ---------- */
  function go(f){ save(); location.href=f; }

  function loop(){
    if(!state.slept){
      const sp = keysDown.has("shift") ? 1.9 : 1.25;
      const dx = (keysDown.has("d")||keysDown.has("arrowright")?sp:0) - (keysDown.has("a")||keysDown.has("arrowleft")?sp:0);
      const dy = (keysDown.has("s")||keysDown.has("arrowdown")?sp:0) - (keysDown.has("w")||keysDown.has("arrowup")?sp:0);
      move(dx,dy);
    }

    if(keysDown.has("e") && !held.e){ interact(); held.e=true; }
    if(!keysDown.has("e")) held.e=false;

    updateMilo();

    state.sophia.x=sophia.x; state.sophia.y=sophia.y;
    state.milo.x=milo.x; state.milo.y=milo.y;
    save();

    bg();
    drawFurniture();
    drawMilo();
    drawSophia();
    drawInteractHint();

    requestAnimationFrame(loop);
  }

  canvas.focus();
  loop();
})();
</script>
</body>
</html>
