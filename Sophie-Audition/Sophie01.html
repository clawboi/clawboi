<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Sophia's Audition â€” Bedroom</title>
<style>
:root{
  --bg:#07070b; --fg:#fff;
  --ui:rgba(255,255,255,.10); --ui2:rgba(255,255,255,.18);
  --vio:#8a2eff;
}
html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
.wrap{height:100%; display:grid; place-items:center;}
canvas{
  width:min(1400px, 100vw);
  height:auto;
  image-rendering:pixelated;
  image-rendering:crisp-edges;
  touch-action:none;
  outline:none;
}

body::before{
  content:"";
  position:fixed;
  inset:-20%;
  background:
    radial-gradient(circle at 15% 15%, rgba(255,200,235,.14), transparent 60%),
    radial-gradient(circle at 85% 45%, rgba(170,255,245,.12), transparent 65%),
    radial-gradient(circle at 52% 88%, rgba(138,46,255,.10), transparent 60%);
  filter:blur(46px);
  animation:drift 12s ease-in-out infinite;
  pointer-events:none;
}
@keyframes drift{0%,100%{transform:translate3d(0,0,0)}50%{transform:translate3d(1.5%,-1.5%,0)}}

.hud{
  position:fixed; left:12px; right:12px; top:12px; z-index:5;
  display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap;
  pointer-events:none;
}
.titleCard{
  pointer-events:auto;
  border:1px solid var(--ui2);
  background:rgba(0,0,0,.42);
  backdrop-filter: blur(8px);
  border-radius:18px;
  padding:10px 14px;
  min-width:260px;
}
.titleCard .t{
  font-weight:800;
  letter-spacing:.16em;
  text-transform:uppercase;
  font-size:13px;
}
.titleCard .s{
  margin-top:4px;
  font-size:12px;
  letter-spacing:.10em;
  opacity:.85;
}
.pill{
  pointer-events:auto;
  border:1px solid var(--ui2);
  background:rgba(0,0,0,.42);
  backdrop-filter: blur(8px);
  border-radius:999px;
  padding:10px 12px;
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  display:flex; gap:10px; align-items:center;
  white-space:nowrap;
}
.hint{
  pointer-events:auto;
  flex:1 1 340px;
  border:1px solid var(--ui2);
  background:rgba(0,0,0,.42);
  backdrop-filter: blur(8px);
  border-radius:18px;
  padding:10px 12px;
  font-size:12px;
  letter-spacing:.08em;
  line-height:1.35;
}
.hint .k{display:inline-block; padding:2px 7px; border-radius:8px; border:1px solid var(--ui2); background:rgba(255,255,255,.06); font-weight:800}

.toast{
  position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
  border:1px solid var(--ui2);
  background:rgba(0,0,0,.60);
  border-radius:14px;
  padding:10px 12px;
  font-size:12px;
  letter-spacing:.08em;
  opacity:0;
  transition:.2s;
  max-width:min(860px, calc(100vw - 24px));
  text-align:center;
}
.toast.on{opacity:1}

/* poem modal */
#poemBox{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.65); z-index:9;}
#poemBox textarea{
  width:360px;height:210px;
  background:#0b0b12;
  color:#fff;
  border:1px solid var(--ui2);
  padding:12px;
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
  border-radius:14px;
}
#poemBox button{margin-top:10px;background:var(--vio);border:none;color:white;padding:10px 18px;cursor:pointer;border-radius:12px;}
</style>
</head>
<body>

<div class="hud">
  <div class="titleCard">
    <div class="t">Sophiaâ€™s Audition</div>
    <div class="s"><span id="status">Bedroom</span> Â· Explore, interact, vibe âœ¨</div>
  </div>

  <div class="pill">Milo: <span id="miloMood">following</span></div>
  <div class="pill">Keys: <span id="keys">NO</span></div>

  <div class="hint">
    Move: <span class="k">WASD</span> Â· Interact: <span class="k">E</span> Â· Run: <span class="k">SHIFT</span> Â· Click/Tap = interact<br>
    Desk = write poetry Â· Guitar = play Â· Clothes = change outfit Â· Bed = sleep Â· Doors lead out
  </div>
</div>

<div class="toast" id="toast"></div>

<div id="poemBox">
  <div>
    <textarea id="poemInput" placeholder="Write poetry..."></textarea><br>
    <button id="poemSaveBtn">Save Line</button>
  </div>
</div>

<!-- Bigger viewport (screen) -->
<div class="wrap"><canvas id="c" width="768" height="432" tabindex="0"></canvas></div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha:false });
  ctx.imageSmoothingEnabled = false;

  const statusEl = document.getElementById("status");
  const keysEl = document.getElementById("keys");
  const miloMoodEl = document.getElementById("miloMood");
  const toastEl = document.getElementById("toast");
  const poemBoxEl = document.getElementById("poemBox");
  const poemInputEl = document.getElementById("poemInput");
  const poemSaveBtn = document.getElementById("poemSaveBtn");

  const STORE_KEY="SOPHIA_AUDITION_SAVE_V1";

  // robust load
  let state;
  try{ state = JSON.parse(localStorage.getItem(STORE_KEY) || "null") || null; }
  catch(e){ state = null; }
  if(!state || typeof state !== "object") state = {};
  state = Object.assign({
    hasKeys:false, slept:false, trip:false, puke:false,
    poemLines:0, poems:[], guitarPlayed:0,
    outfit:0,
    lastRoom:"BEDROOM",
    sophia:{x:170,y:210},
    milo:{x:150,y:226}
  }, state);

  if(!state.sophia || typeof state.sophia.x!=="number" || typeof state.sophia.y!=="number") state.sophia={x:170,y:210};
  if(!state.milo   || typeof state.milo.x!=="number"   || typeof state.milo.y!=="number")   state.milo={x:150,y:226};

  function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

  statusEl.textContent = "Bedroom";
  keysEl.textContent = state.hasKeys ? "YES" : "NO";
  miloMoodEl.textContent = "following";

  /* ---------- controls ---------- */
  const keysDown = new Set();
  const held = { e:false };
  const heldPtr = { down:false };

  function keyName(e){ return (e.key || "").toLowerCase(); }

  window.addEventListener("keydown", (e) => {
    const k = keyName(e);
    if(["arrowup","arrowdown","arrowleft","arrowright"," "].includes(k)) e.preventDefault();
    keysDown.add(k);
  }, { passive:false });

  window.addEventListener("keyup", (e) => keysDown.delete(keyName(e)));
  window.addEventListener("pointerdown", () => canvas.focus(), { passive:true });

  /* ---------- world + camera ---------- */
  // Viewport units (design grid)
  const VIEW_W = 320, VIEW_H = 180;

  // Bigger WORLD (more space to move)
  const WORLD_W = 560, WORLD_H = 340;

  // Scale from design grid to canvas pixels
  const SX = canvas.width / VIEW_W;
  const SY = canvas.height / VIEW_H;

  const X = (x)=>Math.round((x - cam.x) * SX);
  const Y = (y)=>Math.round((y - cam.y) * SY);
  const Wp = (w)=>Math.round(w * SX);
  const Hp = (h)=>Math.round(h * SY);

  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("on");
    setTimeout(()=>toastEl.classList.remove("on"), 1600);
  }

  /* ---------- poem modal ---------- */
  function savePoem(){
    const t = poemInputEl.value.trim();
    if(!t) return;
    state.poems.push(t);
    state.poemLines++;
    poemInputEl.value="";
    save();
    poemBoxEl.style.display="none";
    toast("Poetry saved âœ¨");
  }
  poemSaveBtn.addEventListener("click", savePoem);
  window.savePoem = savePoem;

  /* ---------- geometry ---------- */
  const WALL = 10;

  // Furniture in WORLD coords (solid, not see-through)
  const furn = {
    desk:    { x:70,  y:70,  w:120, h:38, d:10 },
    bed:     { x:360, y:56,  w:150, h:72, d:12 },
    guitar:  { x:88,  y:235, w:32,  h:52, d:8  },
    dresser: { x:230, y:128, w:88,  h:26, d:10 },
    clothes: { x:170, y:260, w:62,  h:28, d:8  },
    table:   { x:330, y:164, w:38,  h:26, d:9  },
    window:  { x:120, y:26,  w:74,  h:36 }
  };

  const solids = [
    [0,0,WORLD_W,WALL],[0,0,WALL,WORLD_H],[0,WORLD_H-WALL,WORLD_W,WALL],[WORLD_W-WALL,0,WALL,WORLD_H],
    [furn.desk.x, furn.desk.y, furn.desk.w, furn.desk.h],
    [furn.bed.x, furn.bed.y, furn.bed.w, furn.bed.h],
    [furn.guitar.x, furn.guitar.y, furn.guitar.w, furn.guitar.h],
    [furn.dresser.x, furn.dresser.y, furn.dresser.w, furn.dresser.h],
    [furn.clothes.x, furn.clothes.y, furn.clothes.w, furn.clothes.h],
    [furn.table.x, furn.table.y, furn.table.w, furn.table.h],
  ];

  const zones = [
    {name:"DESK", rect:[furn.desk.x+10,furn.desk.y+8, 80, 22], action:()=>location.href="poetry.html"},
    {name:"BED", rect:[furn.bed.x+12,furn.bed.y+10, 110, 42], action:()=>{ state.slept=true; save(); toast("She sleepsâ€¦ audition fades ðŸ˜´"); }},
    {name:"GUITAR", rect:[furn.guitar.x-6,furn.guitar.y+8, 46, 30], action:()=>location.href="guitar.html"},
    {name:"CLOTHES", rect:[furn.clothes.x,furn.clothes.y, furn.clothes.w, furn.clothes.h], action:changeOutfit},
    {name:"DOOR_LIVING", rect:[WORLD_W-20, 126, 12, 36], action:()=>go("Sophie03.html")},
    {name:"DOOR_YARD", rect:[270, WORLD_H-18, 54, 10], action:()=>go("Sophie02.html")}
  ];

  function changeOutfit(){
    state.outfit=(state.outfit+1)%4;
    save();
    toast("Outfit changed â™¡");
  }

  function insideSolid(px,py,pw,ph){
    for(const s of solids){
      if(px < s[0]+s[2] && px+pw > s[0] && py < s[1]+s[3] && py+ph > s[1]) return true;
    }
    return false;
  }

  /* ---------- entities ---------- */
  const sophia = { x: state.sophia.x, y: state.sophia.y, w:16, h:20, bob:0 };
  const milo   = { x: state.milo.x,   y: state.milo.y,   bob:0 };

  // camera
  const cam = { x:0, y:0 };

  // spawn safety
  if(insideSolid(sophia.x,sophia.y,sophia.w,sophia.h)){
    sophia.x = 120; sophia.y = 200;
  }

  function moveWithSlide(dx,dy){
    const steps = 3;
    dx/=steps; dy/=steps;
    for(let i=0;i<steps;i++){
      if(!insideSolid(sophia.x+dx, sophia.y, sophia.w, sophia.h)) sophia.x += dx;
      if(!insideSolid(sophia.x, sophia.y+dy, sophia.w, sophia.h)) sophia.y += dy;
    }
  }

  /* ---------- interact ---------- */
  function nearest(){
    let best=null, bd=1e18;
    const px = sophia.x + sophia.w/2;
    const py = sophia.y + sophia.h/2;
    const MAX = 60*60;
    for(const z of zones){
      const cx=z.rect[0]+z.rect[2]/2;
      const cy=z.rect[1]+z.rect[3]/2;
      const d=(cx-px)**2+(cy-py)**2;
      if(d<bd && d<MAX){ bd=d; best=z; }
    }
    return best;
  }

  function interact(){
    const z=nearest();
    if(z) z.action();
    else toast("Nothing hereâ€¦");
  }

  canvas.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    canvas.focus();
    if(!heldPtr.down){ interact(); heldPtr.down=true; }
  }, { passive:false });
  window.addEventListener("pointerup", ()=>heldPtr.down=false, { passive:true });

  /* ---------- draw helpers ---------- */
  function rrect(px,py,pw,ph,r,fill,stroke){
    const x=px, y=py, w=pw, h=ph;
    r=Math.max(0,Math.min(r,Math.min(w,h)/2));
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
    if(fill){ ctx.fillStyle=fill; ctx.fill(); }
    if(stroke){ ctx.strokeStyle=stroke; ctx.stroke(); }
  }

  // Tiny texture overlay (checker + speckle), keeps furniture "solid" but detailed
  function texture(px,py,pw,ph, step, a1, a2){
    for(let y=0;y<ph;y+=step){
      for(let x=0;x<pw;x+=step){
        const on = ((x/step|0)+(y/step|0))%2===0;
        ctx.fillStyle = on ? a1 : a2;
        ctx.fillRect(px+x, py+y, step, step);
      }
    }
  }

  function box3D(wx,wy,ww,wh,wd, colTop, colFront, colSide, edge){
    const x = X(wx), y = Y(wy), w = Wp(ww), h = Hp(wh), d = Hp(wd);

    // floor shadow
    ctx.fillStyle="rgba(0,0,0,.28)";
    rrect(x+Wp(2), y+h-Hp(2), w-Wp(4), Hp(5), Wp(2), "rgba(0,0,0,.28)");

    // top
    rrect(x, y-d, w, d, Wp(4), colTop);
    texture(x, y-d, w, d, Math.max(2, Wp(2)), "rgba(255,255,255,.06)", "rgba(0,0,0,.03)");

    // side
    rrect(x+w-d, y-d, d, h, Wp(3), colSide);
    texture(x+w-d, y-d, d, h, Math.max(2, Wp(2)), "rgba(255,255,255,.05)", "rgba(0,0,0,.04)");

    // front
    rrect(x, y, w, h, Wp(5), colFront);
    texture(x, y, w, h, Math.max(2, Wp(2)), "rgba(255,255,255,.05)", "rgba(0,0,0,.03)");

    // highlight strip
    ctx.fillStyle="rgba(255,255,255,.10)";
    rrect(x+Wp(2), y+Hp(2), w-Wp(10), Hp(6), Wp(3), "rgba(255,255,255,.08)");

    // outline
    ctx.strokeStyle=edge;
    ctx.strokeRect(x+.5, y+.5, w, h);
  }

  /* ---------- background ---------- */
  const motes = Array.from({length:28}, ()=>({
    x: Math.random()*WORLD_W,
    y: Math.random()*WORLD_H,
    r: 1+Math.random()*2,
    sp: 0.18+Math.random()*0.38
  }));

  function bg(){
    // base
    ctx.fillStyle="#0b0810";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // walls area
    rrect(X(8),Y(8),Wp(VIEW_W-16),Hp(110),Wp(8), "#181224", "rgba(255,255,255,.10)");

    // window frame
    const win = furn.window;
    rrect(X(win.x),Y(win.y),Wp(win.w),Hp(win.h),Wp(6), "#2a2240", "rgba(255,255,255,.16)");
    // window glow spill
    const gx = X(win.x+win.w/2), gy = Y(win.y+win.h/2);
    const g = ctx.createRadialGradient(gx,gy, Wp(6), gx,gy, Wp(150));
    g.addColorStop(0,"rgba(255,245,210,.22)");
    g.addColorStop(.55,"rgba(255,200,235,.10)");
    g.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle=g;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // floor (solid wood-ish tile look)
    const floorY = 118;
    const fy = Y(floorY);
    ctx.fillStyle="#1a1327";
    ctx.fillRect(0, fy, canvas.width, canvas.height - fy);

    // planks
    for(let y=fy; y<canvas.height; y+=Hp(4)){
      ctx.fillStyle="rgba(255,255,255,.04)";
      ctx.fillRect(0, y, canvas.width, 1);
    }
    for(let x=0; x<canvas.width; x+=Wp(18)){
      ctx.fillStyle="rgba(0,0,0,.10)";
      ctx.fillRect(x, fy, 1, canvas.height - fy);
    }

    // rug
    rrect(X(210),Y(205),Wp(150),Hp(84),Wp(10), "#2a2040", "rgba(255,255,255,.14)");
    texture(X(210),Y(205),Wp(150),Hp(84),Math.max(2,Wp(2)),"rgba(255,170,255,.06)","rgba(0,0,0,.05)");
    rrect(X(224),Y(218),Wp(122),Hp(56),Wp(9), "#3a2b58", "rgba(255,170,255,.16)");

    // motes (ghibli air)
    for(const m of motes){
      m.y -= m.sp;
      m.x += Math.sin((m.y+m.r)*0.03)*0.20;
      if(m.y < 0){ m.y = WORLD_H; m.x = Math.random()*WORLD_W; }
      const px = X(m.x), py = Y(m.y);
      if(px< -10 || px>canvas.width+10 || py< -10 || py>canvas.height+10) continue;
      ctx.fillStyle="rgba(255,255,255,.07)";
      ctx.fillRect(px,py, Math.max(1,Wp(m.r)), Math.max(1,Wp(m.r)));
    }

    // vignette
    ctx.fillStyle="rgba(0,0,0,.22)";
    ctx.fillRect(0,0,canvas.width,Hp(6));
    ctx.fillRect(0,canvas.height-Hp(6),canvas.width,Hp(6));
    ctx.fillRect(0,0,Wp(6),canvas.height);
    ctx.fillRect(canvas.width-Wp(6),0,Wp(6),canvas.height);
  }

  function drawFurniture(){
    // Solid palette (real RPG props)
    box3D(furn.desk.x, furn.desk.y, furn.desk.w, furn.desk.h, furn.desk.d,
      "#6e4bb8", "#5b3aa3", "#4a2f86", "rgba(0,0,0,.35)"
    );
    // desk details
    rrect(X(furn.desk.x+14), Y(furn.desk.y+12), Wp(84), Hp(10), Wp(4), "#3a255f", "rgba(255,255,255,.10)");
    rrect(X(furn.desk.x+18), Y(furn.desk.y - furn.desk.d + 4), Wp(30), Hp(16), Wp(5), "#1b1427", "rgba(255,255,255,.14)"); // monitor
    rrect(X(furn.desk.x+23), Y(furn.desk.y - furn.desk.d + 9), Wp(18), Hp(7), Wp(3), "#3ee6d3", "rgba(255,255,255,.10)");

    box3D(furn.bed.x, furn.bed.y, furn.bed.w, furn.bed.h, furn.bed.d,
      "#62d3c9", "#4fbdb3", "#3a9a92", "rgba(0,0,0,.35)"
    );
    rrect(X(furn.bed.x+14), Y(furn.bed.y+12), Wp(44), Hp(16), Wp(7), "#efeef7", "rgba(0,0,0,.18)"); // pillow
    rrect(X(furn.bed.x+10), Y(furn.bed.y+34), Wp(furn.bed.w-20), Hp(16), Wp(8), "#ff86c3", "rgba(0,0,0,.18)"); // blanket
    texture(X(furn.bed.x+10), Y(furn.bed.y+34), Wp(furn.bed.w-20), Hp(16), Math.max(2,Wp(2)), "rgba(255,255,255,.06)", "rgba(0,0,0,.05)");

    box3D(furn.dresser.x, furn.dresser.y, furn.dresser.w, furn.dresser.h, furn.dresser.d,
      "#d59a51", "#c4873e", "#9c6a2f", "rgba(0,0,0,.35)"
    );
    for(let i=0;i<2;i++){
      rrect(X(furn.dresser.x+10), Y(furn.dresser.y+6+i*10), Wp(furn.dresser.w-20), Hp(8), Wp(4), "#7a4f22", "rgba(255,255,255,.10)");
      rrect(X(furn.dresser.x+furn.dresser.w-18), Y(furn.dresser.y+8+i*10), Wp(6), Hp(4), Wp(2), "#ffe8b8", "rgba(0,0,0,.18)");
    }

    box3D(furn.clothes.x, furn.clothes.y, furn.clothes.w, furn.clothes.h, furn.clothes.d,
      "#ff8fbd", "#ff6fb0", "#c24f85", "rgba(0,0,0,.35)"
    );

    box3D(furn.guitar.x, furn.guitar.y, furn.guitar.w, furn.guitar.h, furn.guitar.d,
      "#e7e5f2", "#cfcbe6", "#b0abc9", "rgba(0,0,0,.35)"
    );
    // cute guitar silhouette
    rrect(X(furn.guitar.x+10), Y(furn.guitar.y+10), Wp(8), Hp(24), Wp(3), "#b98bff", "rgba(0,0,0,.20)");

    box3D(furn.table.x, furn.table.y, furn.table.w, furn.table.h, furn.table.d,
      "#e9f0f7", "#d7e2ef", "#b7c4d6", "rgba(0,0,0,.35)"
    );
    // lamp
    rrect(X(furn.table.x+10), Y(furn.table.y - furn.table.d + 4), Wp(8), Hp(10), Wp(3), "#fff2c7", "rgba(0,0,0,.18)");
    const lamp = ctx.createRadialGradient(X(furn.table.x+14), Y(furn.table.y - furn.table.d + 8), Wp(4), X(furn.table.x+14), Y(furn.table.y - furn.table.d + 8), Wp(110));
    lamp.addColorStop(0,"rgba(255,245,210,.22)");
    lamp.addColorStop(1,"rgba(0,0,0,0)");
    ctx.fillStyle=lamp;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // doors (solid)
    rrect(X(WORLD_W-22), Y(124), Wp(14), Hp(40), Wp(6), "#2a2240", "rgba(0,255,213,.22)");
    rrect(X(270), Y(WORLD_H-20), Wp(56), Hp(12), Wp(6), "#2a2240", "rgba(0,255,213,.22)");
  }

  /* ---------- sprites ---------- */
  function drawSophia(){
    const outfits=[
      {dress:"#c2a3ff", bow:"#ffe1ff"},
      {dress:"#99fff0", bow:"#e4fbff"},
      {dress:"#ff8fbd", bow:"#ffe2ee"},
      {dress:"#ffe28a", bow:"#fff2c7"}
    ];
    const o=outfits[state.outfit];

    const bob = Math.sin(sophia.bob)*0.8;
    const x = X(sophia.x);
    const y = Y(sophia.y + bob);

    // shadow
    ctx.fillStyle="rgba(0,0,0,.26)";
    rrect(x+Wp(3), y+Hp(18), Wp(10), Hp(3), Wp(2), "rgba(0,0,0,.26)");

    // hair
    rrect(x+Wp(3), y+Hp(0), Wp(10), Hp(7), Wp(3), "#f2d27a");
    ctx.fillStyle="#f2d27a";
    ctx.fillRect(x+Wp(2), y+Hp(3), Wp(12), Hp(6));
    ctx.fillRect(x+Wp(3), y+Hp(6), Wp(3), Hp(3));
    ctx.fillRect(x+Wp(10),y+Hp(6), Wp(3), Hp(3));

    // face
    rrect(x+Wp(4), y+Hp(7), Wp(10), Hp(9), Wp(3), "#ffd9c9");

    // eyes
    rrect(x+Wp(6), y+Hp(10), Wp(3), Hp(3), Wp(1), "#1a0f2a");
    rrect(x+Wp(11),y+Hp(10), Wp(3), Hp(3), Wp(1), "#1a0f2a");
    ctx.fillStyle="#67b7ff";
    ctx.fillRect(x+Wp(7), y+Hp(11), Wp(1), Hp(1));
    ctx.fillRect(x+Wp(12),y+Hp(11), Wp(1), Hp(1));

    // blush
    ctx.fillStyle="rgba(255,120,160,.20)";
    ctx.fillRect(x+Wp(5), y+Hp(14), Wp(2), Hp(1));
    ctx.fillRect(x+Wp(13),y+Hp(14), Wp(2), Hp(1));

    // bow
    rrect(x+Wp(9), y+Hp(6), Wp(4), Hp(2), Wp(1), o.bow);

    // dress
    rrect(x+Wp(5), y+Hp(16), Wp(10), Hp(6), Wp(3), o.dress);
    ctx.fillStyle="rgba(255,255,255,.22)";
    ctx.fillRect(x+Wp(6), y+Hp(18), Wp(8), Hp(1));
  }

  function drawMilo(){
    const bob = Math.sin(milo.bob)*0.8;
    const x = X(milo.x);
    const y = Y(milo.y + bob);

    ctx.fillStyle="rgba(0,0,0,.22)";
    rrect(x+Wp(2), y+Hp(10), Wp(12), Hp(3), Wp(2), "rgba(0,0,0,.22)");

    rrect(x+Wp(2), y+Hp(4), Wp(14), Hp(9), Wp(4), "#ececf6");
    ctx.fillStyle="#ececf6";
    ctx.fillRect(x+Wp(3), y+Hp(3), Wp(4), Hp(3));
    ctx.fillRect(x+Wp(11),y+Hp(3), Wp(4), Hp(3));

    ctx.fillStyle="#1a0f2a";
    ctx.fillRect(x+Wp(6), y+Hp(7), Wp(1), Hp(1));
    ctx.fillRect(x+Wp(11),y+Hp(7), Wp(1), Hp(1));
    ctx.fillStyle="#1affd3";
    ctx.fillRect(x+Wp(6), y+Hp(6), Wp(1), Hp(1));
    ctx.fillRect(x+Wp(11),y+Hp(6), Wp(1), Hp(1));

    ctx.fillStyle="rgba(255,120,160,.30)";
    ctx.fillRect(x+Wp(8), y+Hp(9), Wp(2), Hp(1));
  }

  function drawInteractHint(){
    const z=nearest();
    if(!z) return;
    rrect(Wp(8), canvas.height-Hp(28), Wp(280), Hp(18), Wp(8), "rgba(0,0,0,.55)", "rgba(255,255,255,.20)");
    ctx.fillStyle="rgba(255,255,255,.95)";
    ctx.font = `${Math.max(10, Hp(10))}px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial`;
    ctx.fillText(`Press E or tap: ${z.name}`, Wp(16), canvas.height-Hp(15));
  }

  /* ---------- loop ---------- */
  function go(f){ save(); location.href=f; }

  function updateCamera(){
    // follow Sophia, clamp to world bounds
    const targetX = (sophia.x + sophia.w/2) - VIEW_W/2;
    const targetY = (sophia.y + sophia.h/2) - VIEW_H/2;
    cam.x += (targetX - cam.x) * 0.10;
    cam.y += (targetY - cam.y) * 0.10;
    cam.x = clamp(cam.x, 0, WORLD_W - VIEW_W);
    cam.y = clamp(cam.y, 0, WORLD_H - VIEW_H);
  }

  function loop(){
    if(!state.slept){
      const run = keysDown.has("shift");
      const sp = run ? 2.4 : 1.7;

      let dx = (keysDown.has("d")||keysDown.has("arrowright")?1:0) - (keysDown.has("a")||keysDown.has("arrowleft")?1:0);
      let dy = (keysDown.has("s")||keysDown.has("arrowdown")?1:0) - (keysDown.has("w")||keysDown.has("arrowup")?1:0);

      if(dx || dy){
        const mag = Math.hypot(dx,dy) || 1;
        dx = dx/mag * sp;
        dy = dy/mag * sp;
      }

      moveWithSlide(dx,dy);
      sophia.bob += 0.18;
    } else {
      sophia.bob += 0.04;
    }

    // E fires once
    if(keysDown.has("e") && !held.e){ interact(); held.e=true; }
    if(!keysDown.has("e")) held.e=false;

    // Milo follow
    const tx = sophia.x - 20;
    const ty = sophia.y + 12;
    milo.x += (tx - milo.x) * 0.065;
    milo.y += (ty - milo.y) * 0.065;
    milo.bob += 0.12;

    // clamp to world bounds
    sophia.x = clamp(sophia.x, 12, WORLD_W - 28);
    sophia.y = clamp(sophia.y, 12, WORLD_H - 30);

    updateCamera();

    // save
    state.sophia.x = sophia.x; state.sophia.y = sophia.y;
    state.milo.x   = milo.x;   state.milo.y   = milo.y;
    save();

    // draw
    bg();
    drawFurniture();
    drawMilo();
    drawSophia();
    drawInteractHint();

    requestAnimationFrame(loop);
  }

  canvas.focus();
  loop();
})();
</script>
</body>
</html>
