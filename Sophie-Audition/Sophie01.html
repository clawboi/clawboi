<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Sophia's Audition 01 — Bedroom</title>
<style>
:root{ --bg:#07070b; --fg:#fff; --ui:rgba(255,255,255,.08); --ui2:rgba(255,255,255,.14); --vio:#8a2eff;}
html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
.wrap{height:100%; display:grid; place-items:center;}
canvas{width:min(980px, 100vw); height:auto; image-rendering:pixelated; image-rendering:crisp-edges; touch-action:none; outline:none;}

body::before{
content:"";
position:fixed;
inset:-20%;
background:
radial-gradient(circle at 20% 10%, rgba(138,46,255,.18), transparent 60%),
radial-gradient(circle at 80% 40%, rgba(0,255,213,.12), transparent 65%);
filter:blur(40px);
animation:drift 12s ease-in-out infinite;
pointer-events:none;
}
@keyframes drift{
0%,100%{transform:translate3d(0,0,0)}
50%{transform:translate3d(1.5%, -1.5%,0)}
}

.hud{
position:fixed; left:12px; right:12px; top:12px; z-index:5;
display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap;
pointer-events:none;
}
.pill{
pointer-events:auto;
border:1px solid var(--ui2); background:rgba(0,0,0,.35);
backdrop-filter: blur(8px);
border-radius:999px; padding:10px 12px;
font-size:11px; letter-spacing:.18em; text-transform:uppercase;
display:flex; gap:10px; align-items:center;
}
.pill b{letter-spacing:.22em}
.hint{
pointer-events:auto;
flex:1 1 260px;
border:1px solid var(--ui2); background:rgba(0,0,0,.35);
backdrop-filter: blur(8px);
border-radius:18px; padding:10px 12px;
font-size:11px; letter-spacing:.10em; line-height:1.35;
}
.hint .k{display:inline-block; padding:2px 7px; border-radius:8px; border:1px solid var(--ui2); background:rgba(255,255,255,.06); font-weight:700}
.toast{
position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
border:1px solid var(--ui2); background:rgba(0,0,0,.55);
border-radius:14px; padding:10px 12px;
font-size:12px; letter-spacing:.08em; opacity:0; transition:.2s;
max-width:min(720px, calc(100vw - 24px)); text-align:center;
}
.toast.on{opacity:1}

/* poem modal */
#poemBox{
position:fixed;
inset:0;
display:none;
place-items:center;
background:rgba(0,0,0,.6);
z-index:9;
}
#poemBox textarea{
width:300px;height:180px;
background:#0b0b12;
color:#fff;
border:1px solid var(--ui2);
padding:10px;
font-family:monospace;
}
#poemBox button{
margin-top:6px;
background:var(--vio);
border:none;
color:white;
padding:6px 14px;
cursor:pointer;
}
</style>
</head>
<body>

<div class="hud">
  <div class="pill"><b>SOPHIA</b> <span id="status">BEDROOM</span></div>
  <div class="pill">MILO: <span id="miloMood">following</span></div>
  <div class="pill">KEYS: <span id="keys">NO</span></div>
  <div class="hint">
    Move: <span class="k">WASD</span> · Interact: <span class="k">E</span> · Run: <span class="k">SHIFT</span> · Click/Tap = interact<br>
    Desk = write poetry · Guitar = play · Clothes = change outfit · Bed = sleep · Doors lead out
  </div>
</div>

<div class="toast" id="toast"></div>

<div id="poemBox">
  <div>
    <textarea id="poemInput" placeholder="Write poetry..."></textarea><br>
    <button id="poemSaveBtn">Save Line</button>
  </div>
</div>

<div class="wrap"><canvas id="c" width="320" height="180" tabindex="0"></canvas></div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d", { alpha:false });
  ctx.imageSmoothingEnabled = false;

  const statusEl = document.getElementById("status");
  const keysEl = document.getElementById("keys");
  const miloMoodEl = document.getElementById("miloMood");
  const toastEl = document.getElementById("toast");
  const poemBoxEl = document.getElementById("poemBox");
  const poemInputEl = document.getElementById("poemInput");
  const poemSaveBtn = document.getElementById("poemSaveBtn");

  const STORE_KEY="SOPHIA_AUDITION_SAVE_V1";

  let state = JSON.parse(localStorage.getItem(STORE_KEY) || `{
    "hasKeys":false,"slept":false,"trip":false,"puke":false,
    "poemLines":0,"poems":[],"guitarPlayed":0,
    "outfit":0,
    "lastRoom":"BEDROOM",
    "sophia":{"x":160,"y":120},
    "milo":{"x":148,"y":132}
  }`);

  function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

  const W=320, H=180;

  // Keep UI consistent
  statusEl.textContent = "BEDROOM";
  keysEl.textContent = state.hasKeys ? "YES" : "NO";
  miloMoodEl.textContent = "following";

  /* ---------- controls ---------- */
  const keysDown = new Set();

  function keyName(e){
    // normalize space/shift etc if you expand later
    return (e.key || "").toLowerCase();
  }

  window.addEventListener("keydown", (e) => {
    // prevent page scrolling on arrows/space
    if(["arrowup","arrowdown","arrowleft","arrowright"," "].includes(keyName(e))) e.preventDefault();
    keysDown.add(keyName(e));
  }, { passive:false });

  window.addEventListener("keyup", (e) => {
    keysDown.delete(keyName(e));
  });

  // Make sure key events hit even if user clicked elsewhere
  window.addEventListener("pointerdown", () => canvas.focus(), { passive:true });

  /* ---------- solids ---------- */
  const solids=[
    [0,0,W,10],[0,0,10,H],[0,H-10,W,10],[W-10,0,10,H],

    // furniture collision blocks
    [38,48,90,34],    // desk
    [210,42,78,42],   // bed
    [52,118,22,30],   // guitar stand
    [132,86,56,18],   // dresser
    [90,130,40,20]    // clothes pile
  ];

  /* ---------- zones ---------- */
  const zones=[
    {name:"DESK", rect:[44,52,78,26], action:()=>{ location.href="poetry.html"; }},
    {name:"BED", rect:[216,46,66,34], action:()=>{ state.slept=true; save(); toast("She sleeps. Audition gone."); }},
    {name:"GUITAR", rect:[48,122,32,26], action:()=>{ location.href="guitar.html"; }},
    {name:"CLOTHES", rect:[90,130,40,20], action:changeOutfit},
    {name:"DOOR_LIVING", rect:[W-24,78,14,28], action:()=>go("Sophie03.html")},
    {name:"DOOR_YARD", rect:[154,H-20,34,10], action:()=>go("Sophie02.html")}
  ];

  function changeOutfit(){
    state.outfit = (state.outfit+1)%4;
    save();
    toast("Outfit changed.");
  }

  /* ---------- poem modal ---------- */
  function savePoem(){
    const t = poemInputEl.value.trim();
    if(!t) return;
    state.poems.push(t);
    state.poemLines++;
    poemInputEl.value="";
    save();
    poemBoxEl.style.display="none";
    toast("Poetry saved.");
  }
  poemSaveBtn.addEventListener("click", savePoem);
  // keep your inline compatibility too
  window.savePoem = savePoem;

  /* ---------- entities ---------- */
  const sophia={ x: state.sophia.x, y: state.sophia.y, w:10, h:12 };
  const milo={ x: state.milo.x, y: state.milo.y };

  function col(x,y,w,h){
    for(const s of solids){
      if(x < s[0]+s[2] && x+w > s[0] && y < s[1]+s[3] && y+h > s[1]) return true;
    }
    return false;
  }

  function move(dx,dy){
    if(!col(sophia.x+dx, sophia.y, sophia.w, sophia.h)) sophia.x += dx;
    if(!col(sophia.x, sophia.y+dy, sophia.w, sophia.h)) sophia.y += dy;
  }

  /* ---------- interact ---------- */
  function nearest(){
    let best=null, bd=9999;
    for(const z of zones){
      const cx = z.rect[0] + z.rect[2]/2;
      const cy = z.rect[1] + z.rect[3]/2;
      const d = (cx - (sophia.x+5))**2 + (cy - (sophia.y+6))**2;
      if(d < bd && d < 1400){ bd=d; best=z; }
    }
    return best;
  }

  function interact(){
    const z = nearest();
    if(z) z.action();
    else toast("Nothing to interact with.");
  }

  // Click/tap to interact too (less finicky)
  canvas.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    canvas.focus();
    interact();
  }, { passive:false });

  /* ---------- toast ---------- */
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("on");
    setTimeout(()=>toastEl.classList.remove("on"), 1500);
  }

  /* ---------- milo ---------- */
  function updateMilo(){
    const tx=sophia.x-12, ty=sophia.y+6;
    milo.x += (tx-milo.x)*.05;
    milo.y += (ty-milo.y)*.05;
    if(Math.random()<.002) toast("Milo: meow (he wants outside)");
  }

  /* ---------- render ---------- */
  function drawFurniture(){
    // furniture blocks more visible (still minimal)
    rect(38,48,90,34, "rgba(255,255,255,.10)");   // desk
    rect(210,42,78,42,"rgba(255,255,255,.09)");   // bed
    rect(52,118,22,30,"rgba(255,255,255,.09)");   // guitar stand
    rect(132,86,56,18,"rgba(255,255,255,.08)");   // dresser
    rect(90,130,40,20,"rgba(255,255,255,.10)");   // clothes
    // door hints
    rect(W-24,78,14,28,"rgba(0,255,213,.10)");
    rect(154,H-20,34,10,"rgba(0,255,213,.10)");
  }

  function rect(x,y,w,h,fill){
    ctx.fillStyle = fill || "rgba(255,255,255,.08)";
    ctx.fillRect(x,y,w,h);
  }

  function bg(){
    ctx.fillStyle="#05050a";
    ctx.fillRect(0,0,W,H);

    // ambient room glow
    let g=ctx.createRadialGradient(80,60,10,80,60,160);
    g.addColorStop(0,"rgba(138,46,255,.20)");
    g.addColorStop(.6,"rgba(138,46,255,.06)");
    g.addColorStop(1,"transparent");
    ctx.fillStyle=g;
    ctx.fillRect(0,0,W,H);

    // subtle cinematic lighting pass
    let light = ctx.createRadialGradient(
      sophia.x+5, sophia.y+5, 8,
      sophia.x+5, sophia.y+5, 90
    );
    light.addColorStop(0,"rgba(255,255,255,.07)");
    light.addColorStop(.4,"rgba(255,255,255,.03)");
    light.addColorStop(1,"transparent");
    ctx.fillStyle=light;
    ctx.fillRect(0,0,W,H);

    // top wall panel
    ctx.fillStyle="rgba(255,255,255,.05)";
    ctx.fillRect(10,10,W-20,80);

    // floor scanlines
    for(let y=92;y<H-10;y++){
      ctx.fillStyle=`rgba(255,255,255,${y%6===0?.10:.045})`;
      ctx.fillRect(10,y,W-20,1);
    }

    // vignette edges
    ctx.fillStyle="rgba(0,0,0,.18)";
    ctx.fillRect(0,0,W,8);
    ctx.fillRect(0,H-8,W,8);
    ctx.fillRect(0,0,8,H);
    ctx.fillRect(W-8,0,8,H);

    drawFurniture();
  }

  function drawSophia(){
    const x=sophia.x, y=sophia.y;

    ctx.fillStyle="#f2d27a"; // hair
    ctx.fillRect(x+1,y,8,4);
    ctx.fillRect(x,y+3,10,3);

    ctx.fillStyle="#ffd9c9"; // face
    ctx.fillRect(x+2,y+5,6,4);

    ctx.fillStyle="#67b7ff"; // eyes
    ctx.fillRect(x+3,y+6,1,1);
    ctx.fillRect(x+6,y+6,1,1);

    const outfits=["#a64dff","#4dffcf","#ff4d88","#ffd24d"];
    ctx.fillStyle=outfits[state.outfit];
    ctx.fillRect(x+2,y+9,6,3);
  }

  function drawMilo(){
    const x=milo.x, y=milo.y;
    ctx.fillStyle="#d8d8d8";
    ctx.fillRect(x+1,y+2,6,5);
    ctx.fillRect(x+1,y+1,2,2);
    ctx.fillRect(x+5,y+1,2,2);
    ctx.fillStyle="#1affd3";
    ctx.fillRect(x+2,y+4,1,1);
    ctx.fillRect(x+5,y+4,1,1);
  }

  function drawInteractHint(){
    const z = nearest();
    if(!z) return;
    // tiny on-canvas hint so you KNOW it’s hittable
    ctx.fillStyle="rgba(0,0,0,.55)";
    ctx.fillRect(10, H-26, 160, 16);
    ctx.strokeStyle="rgba(255,255,255,.18)";
    ctx.strokeRect(10.5, H-25.5, 160, 16);

    ctx.fillStyle="rgba(255,255,255,.92)";
    ctx.font="10px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(`Press E or tap: ${z.name}`, 16, H-14);
  }

  /* ---------- loop ---------- */
  function go(f){ save(); location.href=f; }

  function loop(){
    if(!state.slept){
      const sp = keysDown.has("shift") ? 1.4 : .9;
      const dx = (keysDown.has("d")||keysDown.has("arrowright")?sp:0) - (keysDown.has("a")||keysDown.has("arrowleft")?sp:0);
      const dy = (keysDown.has("s")||keysDown.has("arrowdown")?sp:0) - (keysDown.has("w")||keysDown.has("arrowup")?sp:0);
      move(dx,dy);
    }

    // make E reliable (fires once per press)
    if(keysDown.has("e") && !loop.e){ interact(); loop.e=1; }
    if(!keysDown.has("e")) loop.e=0;

    updateMilo();

    state.sophia.x=sophia.x; state.sophia.y=sophia.y;
    state.milo.x=milo.x; state.milo.y=milo.y;
    save();

    bg();
    drawMilo();
    drawSophia();
    drawInteractHint();

    requestAnimationFrame(loop);
  }

  // start focused
  canvas.focus();
  loop();
})();
</script>
</body>
</html>
