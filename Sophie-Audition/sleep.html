<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Sophia’s Audition — Sleep</title>
<style>
:root{ --bg:#07070b; --fg:#fff; --ui:rgba(255,255,255,.08); --ui2:rgba(255,255,255,.14); --vio:#8a2eff; --cyan:#00ffd5; }
html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; overflow:hidden;}
canvas{position:fixed; inset:0; width:100%; height:100%; image-rendering:pixelated; image-rendering:crisp-edges;}
body::before{
  content:""; position:fixed; inset:-20%;
  background:
    radial-gradient(circle at 20% 10%, rgba(138,46,255,.18), transparent 60%),
    radial-gradient(circle at 80% 40%, rgba(0,255,213,.10), transparent 65%);
  filter:blur(50px); animation:drift 14s ease-in-out infinite; pointer-events:none;
}
@keyframes drift{0%,100%{transform:translate3d(0,0,0)}50%{transform:translate3d(1.6%,-1.2%,0)}}

.hud{position:fixed; left:12px; right:12px; top:12px; z-index:5; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
.pill{
  border:1px solid var(--ui2); background:rgba(0,0,0,.35); backdrop-filter: blur(8px);
  border-radius:999px; padding:10px 12px; font-size:11px; letter-spacing:.18em; text-transform:uppercase;
  display:inline-flex; gap:10px; align-items:center;
}
.btnRow{position:fixed; left:12px; right:12px; bottom:12px; z-index:5; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;}
button,a.btn{
  border:1px solid rgba(255,255,255,.16); background:rgba(0,0,0,.45); color:#fff;
  padding:14px 16px; border-radius:16px; cursor:pointer; font-size:12px; letter-spacing:.14em; text-transform:uppercase;
  backdrop-filter: blur(10px); text-decoration:none;
}
button.primary{background:rgba(138,46,255,.75); border-color:transparent}
small.note{opacity:.72; letter-spacing:.08em}
.toast{
  position:fixed; left:50%; bottom:84px; transform:translateX(-50%);
  border:1px solid var(--ui2); background:rgba(0,0,0,.55); border-radius:14px;
  padding:10px 12px; font-size:12px; letter-spacing:.08em;
  opacity:0; transition:.2s; max-width:min(720px, calc(100vw - 24px)); text-align:center; z-index:6;
}
.toast.on{opacity:1}
</style>
</head>
<body>
<canvas id="c"></canvas>

<div class="hud">
  <div class="pill"><b>SOPHIA</b> SLEEP</div>
  <div class="pill"><span id="sleepState">DREAMING</span></div>
  <div class="pill"><small class="note">Tap to wake the audio system (iPhone)</small></div>
</div>

<div class="toast" id="toast"></div>

<div class="btnRow">
  <button class="primary" id="saveBtn">SAVE</button>
  <button id="switchBtn">SWITCH CHARACTER</button>
  <a class="btn" href="Sophie01.html" id="backBtn">BACK TO BEDROOM</a>
</div>

<script>
const STORE_KEY="SOPHIA_AUDITION_SAVE_V1";
let state=JSON.parse(localStorage.getItem(STORE_KEY)||`{
"hasKeys":false,"slept":false,"trip":false,"puke":false,
"poemLines":0,"poems":[],"guitarPlayed":0,
"outfit":0,"dressColor":"#a64dff","shoeColor":"#ffffff",
"lastRoom":"BEDROOM","character":"SOPHIA",
"sophia":{"x":160,"y":120},"milo":{"x":148,"y":132}
}`);
function save(){localStorage.setItem(STORE_KEY,JSON.stringify(state));}

const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
let W,H,dpr;

function resize(){
  dpr=Math.max(1, Math.min(2, window.devicePixelRatio||1));
  W=Math.floor(innerWidth*dpr); H=Math.floor(innerHeight*dpr);
  canvas.width=W; canvas.height=H;
  canvas.style.width=innerWidth+"px"; canvas.style.height=innerHeight+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
addEventListener("resize",resize); resize();

// iPhone-safe audio unlock + tiny lullaby blips
let AC, master, unlocked=false;
function unlock(){
  if(unlocked) return;
  try{
    AC = AC || new (window.AudioContext||window.webkitAudioContext)();
    if(AC.state==="suspended") AC.resume();
    master = AC.createGain();
    master.gain.value=0.55;
    master.connect(AC.destination);
    unlocked=true;
  }catch(e){}
}
addEventListener("pointerdown", unlock, {passive:true});

function blip(freq=660, dur=0.08, vol=0.08){
  if(!unlocked||!AC||!master) return;
  const t=AC.currentTime;
  const o=AC.createOscillator();
  const g=AC.createGain();
  o.type="sine";
  o.frequency.setValueAtTime(freq, t);
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(vol, t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
  o.connect(g); g.connect(master);
  o.start(t); o.stop(t+dur+0.02);
}

const toastEl=document.getElementById("toast");
function toast(msg){
  toastEl.textContent=msg;
  toastEl.classList.add("on");
  setTimeout(()=>toastEl.classList.remove("on"),1400);
}

// Buttons
document.getElementById("saveBtn").onclick=()=>{
  state.slept=true;
  state.lastRoom="SLEEP";
  save();
  blip(740,0.09,0.10);
  toast("Saved. Sophia feels a little calmer.");
};
document.getElementById("switchBtn").onclick=()=>{
  // placeholder for later city character system
  state.character = (state.character==="SOPHIA") ? "LUCAS" : "SOPHIA";
  save();
  blip(520,0.08,0.10);
  toast("Character set to: "+state.character+" (city system later)");
};

// Dream scene: cows hopping over moon
let t0=performance.now();
const cows = Array.from({length:7}, (_,i)=>({
  x:-200 - i*180,
  y:0.55 + Math.random()*0.12,
  s:0.8 + Math.random()*0.6,
  bob:Math.random()*Math.PI*2
}));

function star(x,y,a){
  ctx.globalAlpha=a;
  ctx.fillStyle="#fff";
  ctx.fillRect(x,y,2,2);
  ctx.fillRect(x+2,y+1,1,1);
  ctx.fillRect(x-1,y+2,1,1);
  ctx.globalAlpha=1;
}

function drawMoon(cx,cy,r){
  const g=ctx.createRadialGradient(cx-r*0.2,cy-r*0.2,r*0.2,cx,cy,r);
  g.addColorStop(0,"rgba(255,255,255,.95)");
  g.addColorStop(1,"rgba(255,255,255,.25)");
  ctx.fillStyle=g;
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();

  ctx.globalAlpha=0.18;
  ctx.fillStyle="#000";
  for(let i=0;i<10;i++){
    ctx.beginPath();
    ctx.arc(cx+(Math.random()*2-1)*r*0.5, cy+(Math.random()*2-1)*r*0.5, 4+Math.random()*9, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.globalAlpha=1;
}

function drawCow(x,y,scale){
  ctx.save();
  ctx.translate(x,y);
  ctx.scale(scale,scale);
  // body
  ctx.fillStyle="rgba(255,255,255,.85)";
  ctx.fillRect(-26,-10,52,22);
  // spots
  ctx.globalAlpha=0.22;
  ctx.fillStyle="#000";
  ctx.fillRect(-14,-6,8,6);
  ctx.fillRect(6,-2,10,7);
  ctx.globalAlpha=1;
  // head
  ctx.fillStyle="rgba(255,255,255,.9)";
  ctx.fillRect(24,-8,16,14);
  // legs
  ctx.fillStyle="rgba(255,255,255,.75)";
  ctx.fillRect(-18,10,6,10);
  ctx.fillRect(-2,10,6,10);
  ctx.fillRect(12,10,6,10);
  // tiny horn glow
  ctx.fillStyle="rgba(138,46,255,.45)";
  ctx.fillRect(34,-10,2,2);
  ctx.fillRect(38,-10,2,2);
  ctx.restore();
}

function loop(){
  const t=(performance.now()-t0)/1000;
  ctx.clearRect(0,0,innerWidth,innerHeight);

  // sky
  ctx.fillStyle="#05050a";
  ctx.fillRect(0,0,innerWidth,innerHeight);

  // nebula glow
  let g1=ctx.createRadialGradient(innerWidth*0.3,innerHeight*0.25,20,innerWidth*0.3,innerHeight*0.25,innerWidth*0.9);
  g1.addColorStop(0,"rgba(138,46,255,.20)");
  g1.addColorStop(1,"transparent");
  ctx.fillStyle=g1; ctx.fillRect(0,0,innerWidth,innerHeight);

  let g2=ctx.createRadialGradient(innerWidth*0.75,innerHeight*0.4,20,innerWidth*0.75,innerHeight*0.4,innerWidth*0.9);
  g2.addColorStop(0,"rgba(0,255,213,.10)");
  g2.addColorStop(1,"transparent");
  ctx.fillStyle=g2; ctx.fillRect(0,0,innerWidth,innerHeight);

  // stars
  for(let i=0;i<120;i++){
    const sx = (i*97 % 997)/997 * innerWidth;
    const sy = (i*173 % 991)/991 * innerHeight;
    star(sx,sy,0.10 + 0.25*Math.abs(Math.sin(t*0.7 + i)));
  }

  // moon
  drawMoon(innerWidth*0.72, innerHeight*0.30, Math.min(innerWidth,innerHeight)*0.09);

  // hill
  ctx.fillStyle="rgba(0,0,0,.65)";
  ctx.beginPath();
  ctx.moveTo(0, innerHeight*0.70);
  ctx.quadraticCurveTo(innerWidth*0.5, innerHeight*0.56, innerWidth, innerHeight*0.70);
  ctx.lineTo(innerWidth, innerHeight);
  ctx.lineTo(0, innerHeight);
  ctx.closePath();
  ctx.fill();

  // cows jump across horizon line
  const horizon = innerHeight*0.62;
  cows.forEach((c,i)=>{
    c.x += (70 + i*6) * (1/60);
    if(c.x > innerWidth + 260) c.x = -260;

    const jump = Math.max(0, Math.sin((t*1.2 + i*0.55)));
    const y = horizon - jump*80*c.s + (Math.sin(t*0.9 + c.bob)*6);
    drawCow(c.x, y, 1.0*c.s);
  });

  // soft “zzz”
  ctx.globalAlpha=0.55;
  ctx.fillStyle="rgba(255,255,255,.75)";
  ctx.font="12px ui-monospace, Menlo, monospace";
  ctx.fillText("zzz…", innerWidth*0.18 + Math.sin(t)*8, innerHeight*0.22 + Math.cos(t*0.7)*6);
  ctx.globalAlpha=1;

  // occasional lullaby ping
  if(Math.random()<0.006){ blip(520+Math.random()*220, 0.05, 0.06); }

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
