<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>TV</title>
<style>
  :root{ --bg:#07070b; --fg:#fff; --ui2:rgba(255,255,255,.14); --vio:#8a2eff; --aqua:#00ffd5;}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{height:100%; display:grid; place-items:center;}
  canvas{width:min(980px, 100vw); height:auto; image-rendering:pixelated; image-rendering:crisp-edges; touch-action:none;}
  .hud{
    position:fixed; left:12px; right:12px; top:12px; z-index:5;
    display:flex; gap:10px; flex-wrap:wrap; pointer-events:none;
  }
  .pill{
    pointer-events:auto; border:1px solid var(--ui2);
    background:rgba(0,0,0,.35); backdrop-filter: blur(8px);
    border-radius:999px; padding:10px 12px;
    font-size:11px; letter-spacing:.18em; text-transform:uppercase;
    display:flex; gap:10px; align-items:center;
  }
  .toast{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    border:1px solid var(--ui2); background:rgba(0,0,0,.55);
    border-radius:14px; padding:10px 12px;
    font-size:12px; letter-spacing:.08em;
    opacity:0; transition:.2s;
    max-width:min(760px, calc(100vw - 24px)); text-align:center;
    z-index:6;
  }
  .toast.on{opacity:1}
  .microhint{
    position:fixed; right:12px; bottom:12px; z-index:4;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.35);
    backdrop-filter: blur(8px);
    border-radius:14px;
    padding:8px 10px;
    font-size:10px;
    letter-spacing:.12em;
    opacity:.85;
    pointer-events:none;
  }
  .exit{
    position:fixed; left:12px; bottom:12px; z-index:7;
    pointer-events:auto;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(0,0,0,.45);
    backdrop-filter: blur(8px);
    border-radius:14px;
    padding:10px 12px;
    font-size:11px;
    letter-spacing:.18em;
    text-transform:uppercase;
    cursor:pointer;
  }
</style>
</head>
<body>
<div class="hud">
  <div class="pill"><b>TV</b> <span id="chanName">CATS</span></div>
  <div class="pill">CHANNEL: <span id="chanNum">01</span></div>
  <div class="pill">TIME: <span id="time">10:00</span></div>
  <div class="pill">TRIP: <span id="trip">OFF</span></div>
</div>
<div class="toast" id="toast"></div>
<button class="exit" id="exitBtn">EXIT → LIVING ROOM</button>
<div class="microhint">Switch: ←/→ or 1-5 · Exit: E</div>
<div class="wrap"><canvas id="c" width="320" height="180"></canvas></div>

<script>
const c=document.getElementById("c");
const ctx=c.getContext("2d",{alpha:false});
ctx.imageSmoothingEnabled=false;

const UI={
  toast:document.getElementById("toast"),
  time:document.getElementById("time"),
  trip:document.getElementById("trip"),
  chanName:document.getElementById("chanName"),
  chanNum:document.getElementById("chanNum"),
  exitBtn:document.getElementById("exitBtn"),
};

const STORE_KEY="SOPHIA_AUDITION_SAVE_V1";
const RUN_KEY="SOPHIA_AUDITION_RUN_V1";
const DURATION_MS=10*60*1000;

function loadState(){
  const r=localStorage.getItem(STORE_KEY);
  if(r){ try{return JSON.parse(r);}catch(e){} }
  return {trip:false, lastRoom:"LIVING", lucas:{mood:0,following:false,attempts:0,unlocked:false}};
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

function loadRun(){
  const r=localStorage.getItem(RUN_KEY);
  if(r){ try{return JSON.parse(r);}catch(e){} }
  return { startTime:0, durationMs:DURATION_MS, active:false, ended:false };
}
function saveRun(run){ localStorage.setItem(RUN_KEY, JSON.stringify(run)); }

let state=loadState();
state.tv = state.tv || { channel: 0 }; // persist channel
saveState();

function toast(msg,ms=1600){
  UI.toast.textContent=msg;
  UI.toast.classList.add("on");
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>UI.toast.classList.remove("on"),ms);
}

/* timer */
function fmt(ms){
  ms=Math.max(0, ms|0);
  const s=Math.ceil(ms/1000);
  const m=(s/60)|0;
  const ss=String(s%60).padStart(2,"0");
  return `${m}:${ss}`;
}
function timeLeftMs(){
  const run=loadRun();
  if(!run.active || run.ended) return run.durationMs;
  return (run.startTime + run.durationMs - Date.now());
}
function tickTimer(){
  const left=timeLeftMs();
  UI.time.textContent=fmt(left);
  if(left<=0){
    const run=loadRun();
    run.ended=true; run.active=false;
    saveRun(run);
    toast("TIME UP. Audition missed.", 1800);
    setTimeout(()=>location.href="Sophie00.html", 700);
  }
}
setInterval(tickTimer,250);
tickTimer();

UI.trip.textContent = state.trip ? "ON" : "OFF";

/* input */
const keysDown=new Set();
addEventListener("keydown",(e)=>{
  const k=e.key.toLowerCase();
  if(["arrowleft","arrowright","arrowup","arrowdown"," ","e","1","2","3","4","5"].includes(k)) e.preventDefault();
  keysDown.add(k);
});
addEventListener("keyup",(e)=>keysDown.delete(e.key.toLowerCase()));

/* channel system */
const channels=[
  {name:"CATS (ANIM)", id:"01"},
  {name:"BARBIE GIRLS", id:"02"},
  {name:"MUSHROOM RAVE", id:"03"},
  {name:"LOFI RAIN", id:"04"},
  {name:"ACTOR MOVIE", id:"05"},
];

let chan = Math.max(0, Math.min(channels.length-1, state.tv.channel|0));
let t=0;

function setChan(i){
  chan=(i+channels.length)%channels.length;
  state.tv.channel=chan;
  saveState();
  UI.chanName.textContent=channels[chan].name;
  UI.chanNum.textContent=channels[chan].id;
  toast(`Channel ${channels[chan].id}: ${channels[chan].name}`, 1200);
  if(state.trip) miloTalk("tv");
}

function miloTalk(mode){
  const linesTV=[
    "MILO: the box is dreaming again.",
    "MILO: switch it. i want the universe channel.",
    "MILO: this show smells like electricity.",
    "MILO: your eyes are doing that sparkle thing.",
    "MILO: humans watch squares. i watch you watch squares."
  ];
  const lines=[
    "MILO: i can hear the pixels purring.",
    "MILO: do NOT trust the barbie channel.",
    "MILO: mushrooms are dancing at us. rude.",
    "MILO: rain playlist? good. cleanse the room.",
    "MILO: actor channel is lying. i can tell."
  ];
  const pick = (Math.random()<0.5?linesTV:lines)[(Math.random()*5)|0];
  toast(pick, 1500);
}

setChan(chan);

/* render helpers */
const W=c.width, H=c.height;
function bevel(x,y,w,h,fill){
  ctx.fillStyle=fill; ctx.fillRect(x,y,w,h);
  ctx.fillStyle="rgba(255,255,255,.08)"; ctx.fillRect(x,y,w,1);
  ctx.fillStyle="rgba(0,0,0,.40)"; ctx.fillRect(x,y+h-1,w,1);
  ctx.fillStyle="rgba(255,255,255,.06)"; ctx.fillRect(x,y,1,h);
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(x+w-1,y,1,h);
}
function scanlines(t){
  for(let y=0;y<H;y+=3){
    ctx.fillStyle=`rgba(255,255,255,${0.02 + 0.01*Math.sin(t*0.08+y*0.22)})`;
    ctx.fillRect(0,y,W,1);
  }
}
function crtGlow(){
  const g=ctx.createRadialGradient(160,90,30,160,90,190);
  g.addColorStop(0,"rgba(138,46,255,.12)");
  g.addColorStop(0.35,"rgba(0,255,213,.06)");
  g.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
}
function noise(t){
  for(let i=0;i<90;i++){
    const x=(Math.random()*W)|0;
    const y=(Math.random()*H)|0;
    ctx.fillStyle=`rgba(255,255,255,${0.04+0.04*Math.random()})`;
    ctx.fillRect(x,y,1,1);
  }
}

/* Channel renders */
function showCats(t){
  ctx.fillStyle="#05050a"; ctx.fillRect(0,0,W,H);
  crtGlow();

  // cartoon bg
  ctx.fillStyle="rgba(255,255,255,.06)";
  ctx.fillRect(22,26,276,128);

  // cat parade (3 cats)
  for(let i=0;i<3;i++){
    const baseX = 70 + i*70 + Math.sin(t*0.03+i)*10;
    const baseY = 100 + Math.sin(t*0.06+i*2)*6;
    // body
    ctx.fillStyle="rgba(255,255,255,.14)";
    ctx.fillRect(baseX,baseY,22,10);
    // head
    ctx.fillRect(baseX-6,baseY-6,10,10);
    // ears
    ctx.fillRect(baseX-6,baseY-8,3,3);
    ctx.fillRect(baseX+1,baseY-8,3,3);
    // eyes
    ctx.fillStyle="rgba(0,255,213,.65)";
    ctx.fillRect(baseX-3,baseY-2,1,1);
    ctx.fillRect(baseX,baseY-2,1,1);
    // tail wag
    ctx.fillStyle="rgba(255,255,255,.12)";
    const wag = Math.round(Math.sin(t*0.12+i)*2);
    ctx.fillRect(baseX+22,baseY+2+wag,8,2);
  }

  // subtitle strip
  ctx.fillStyle="rgba(0,0,0,.55)";
  ctx.fillRect(22,138,276,16);
  ctx.fillStyle="rgba(255,255,255,.88)";
  ctx.font="8px ui-monospace, monospace";
  ctx.fillText("CATS: The Episode Where They All Pretend Not To Care", 30,149);

  scanlines(t);
}

function showBarbie(t){
  ctx.fillStyle="#05050a"; ctx.fillRect(0,0,W,H);

  // pink-ish “TV set” look (still fits your palette)
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,"rgba(255,255,255,.06)");
  g.addColorStop(0.4,"rgba(138,46,255,.10)");
  g.addColorStop(1,"rgba(0,0,0,.65)");
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // stage
  bevel(30,30,260,120,"rgba(255,255,255,.06)");

  // “girls show” dancers
  for(let i=0;i<5;i++){
    const x=60+i*45;
    const bob=Math.sin(t*0.08+i)*6;
    // head
    ctx.fillStyle="rgba(255,255,255,.16)";
    ctx.fillRect(x,70+bob,6,6);
    // body
    ctx.fillStyle="rgba(138,46,255,.18)";
    ctx.fillRect(x-1,76+bob,8,14);
    // arms
    ctx.fillStyle="rgba(255,255,255,.10)";
    const a=Math.sin(t*0.12+i)*3;
    ctx.fillRect(x-6,80+bob+a,6,2);
    ctx.fillRect(x+7,80+bob-a,6,2);
    // legs
    ctx.fillRect(x,90+bob,2,10);
    ctx.fillRect(x+4,90+bob,2,10);
  }

  // sparkles
  for(let i=0;i<40;i++){
    const x=(Math.sin(i*33+t*0.02)*0.5+0.5)*W;
    const y=(Math.cos(i*77+t*0.02)*0.5+0.5)*H;
    ctx.fillStyle=`rgba(255,255,255,${0.06+0.08*Math.random()})`;
    ctx.fillRect(x,y,1,1);
  }

  // caption
  ctx.fillStyle="rgba(0,0,0,.55)";
  ctx.fillRect(30,130,260,20);
  ctx.fillStyle="rgba(255,255,255,.9)";
  ctx.font="8px ui-monospace, monospace";
  ctx.fillText("BARBIE GIRLS: everyone is fine. no one is fine.", 38,143);

  scanlines(t);
}

function showMushroomRave(t){
  ctx.fillStyle="#05050a"; ctx.fillRect(0,0,W,H);
  crtGlow();

  // rave floor
  ctx.fillStyle="rgba(255,255,255,.05)";
  ctx.fillRect(0,120,W,60);

  // pulsing lights
  for(let i=0;i<6;i++){
    const x=30+i*50;
    const h=30+Math.sin(t*0.06+i)*20;
    ctx.fillStyle=`rgba(0,255,213,${0.05+0.10*Math.sin(t*0.05+i)*0.5})`;
    ctx.fillRect(x,110-h,20,h);
  }

  // dancing mushrooms
  for(let i=0;i<7;i++){
    const x=35+i*40;
    const sway=Math.sin(t*0.10+i)*6;
    const jump=Math.max(0, Math.sin(t*0.14+i*0.7))*8;
    const y=112 - jump;

    // cap
    ctx.fillStyle=`rgba(138,46,255,${0.12+0.15*Math.sin(t*0.08+i)*0.5})`;
    ctx.fillRect(x-6+sway,y-10,18,8);
    // stem
    ctx.fillStyle="rgba(255,255,255,.12)";
    ctx.fillRect(x+sway,y-2,6,12);
    // face
    ctx.fillStyle="rgba(0,0,0,.55)";
    ctx.fillRect(x+1+sway,y+2,1,1);
    ctx.fillRect(x+4+sway,y+2,1,1);
  }

  // crowd noise bar (visual)
  for(let i=0;i<60;i++){
    const x=i*6;
    const h=6+Math.sin(t*0.12+i*0.8)*8 + (state.trip?Math.sin(t*0.18+i)*4:0);
    ctx.fillStyle="rgba(255,255,255,.06)";
    ctx.fillRect(x,160-h,4,h);
  }

  ctx.fillStyle="rgba(0,0,0,.55)";
  ctx.fillRect(18,18,284,18);
  ctx.fillStyle="rgba(255,255,255,.9)";
  ctx.font="8px ui-monospace, monospace";
  ctx.fillText("MUSHROOM PEOPLE DANCING (they are not asking permission)", 24,30);

  scanlines(t);
  if(state.trip){
    ctx.fillStyle=`rgba(255,99,255,${0.08+0.06*Math.sin(t*0.07)})`;
    ctx.fillRect(0,0,W,H);
  }
}

function showLofiRain(t){
  ctx.fillStyle="#05050a"; ctx.fillRect(0,0,W,H);

  // window frame
  bevel(30,22,260,136,"rgba(255,255,255,.06)");
  ctx.fillStyle="rgba(0,0,0,.55)";
  ctx.fillRect(38,30,244,120);

  // city glow
  const cg=ctx.createRadialGradient(160,95,10,160,95,140);
  cg.addColorStop(0,"rgba(0,255,213,.08)");
  cg.addColorStop(0.5,"rgba(138,46,255,.10)");
  cg.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle=cg; ctx.fillRect(0,0,W,H);

  // rain drops
  for(let i=0;i<120;i++){
    const x=(i*23 + (t*2))%260;
    const y=(i*57 + (t*6))%140;
    ctx.fillStyle="rgba(255,255,255,.08)";
    ctx.fillRect(30+x,22+y,1,4);
  }

  // lo-fi “visualizer”
  const baseY=150;
  for(let i=0;i<38;i++){
    const x=48+i*6;
    const h=6 + Math.abs(Math.sin(t*0.08+i*0.7))*20 + (state.trip?Math.abs(Math.sin(t*0.13+i))*6:0);
    ctx.fillStyle="rgba(255,255,255,.06)";
    ctx.fillRect(x,baseY-h,4,h);
  }

  // track info
  ctx.fillStyle="rgba(0,0,0,.55)";
  ctx.fillRect(30,160,260,16);
  ctx.fillStyle="rgba(255,255,255,.85)";
  ctx.font="8px ui-monospace, monospace";
  ctx.fillText("LOFI RAIN PLAYLIST  •  track: 'quiet apartment'  •  volume: imaginary", 36,171);

  scanlines(t);
}

function showActorMovie(t){
  ctx.fillStyle="#05050a"; ctx.fillRect(0,0,W,H);

  // cinematic bars
  ctx.fillStyle="rgba(0,0,0,.75)"; ctx.fillRect(0,0,W,20);
  ctx.fillRect(0,H-20,W,20);

  // film grain
  noise(t);

  // “actor” close-up
  const x=160 + Math.sin(t*0.02)*2;
  const y=90 + Math.cos(t*0.018)*2;

  // face
  ctx.fillStyle="rgba(255,255,255,.10)";
  ctx.fillRect(x-22,y-18,44,38);
  // shadow jaw
  ctx.fillStyle="rgba(0,0,0,.35)";
  ctx.fillRect(x-22,y+10,44,10);

  // eyes
  const blink = Math.sin(t*0.07) > 0.985;
  ctx.fillStyle="rgba(0,255,213,.45)";
  if(blink){
    ctx.fillRect(x-10,y-4,20,1);
  }else{
    ctx.fillRect(x-12,y-6,4,2);
    ctx.fillRect(x+8,y-6,4,2);
  }
  // mouth
  ctx.fillStyle="rgba(138,46,255,.35)";
  ctx.fillRect(x-6,y+6,12,2);

  // subtitle
  ctx.fillStyle="rgba(0,0,0,.55)";
  ctx.fillRect(22,H-34,276,12);
  ctx.fillStyle="rgba(255,255,255,.90)";
  ctx.font="8px ui-monospace, monospace";
  ctx.fillText("ACTOR: \"i was born in a loading screen.\" (dramatic pause)", 28, H-25);

  scanlines(t);
}

function render(){
  t++;

  // controls
  if(keysDown.has("arrowleft")){ if(!render._l){ setChan(chan-1); } render._l=true; } else render._l=false;
  if(keysDown.has("arrowright")){ if(!render._r){ setChan(chan+1); } render._r=true; } else render._r=false;

  for(let i=1;i<=5;i++){
    if(keysDown.has(String(i))){
      if(!render["_n"+i]) setChan(i-1);
      render["_n"+i]=true;
    } else render["_n"+i]=false;
  }

  // exit with E
  if(keysDown.has("e")){
    if(!render._e){ goBack(); }
    render._e=true;
  } else render._e=false;

  // draw
  if(chan===0) showCats(t);
  if(chan===1) showBarbie(t);
  if(chan===2) showMushroomRave(t);
  if(chan===3) showLofiRain(t);
  if(chan===4) showActorMovie(t);

  // trip overlay (gentle)
  if(state.trip){
    ctx.fillStyle=`rgba(255,99,255,${0.06+0.05*Math.sin(t*0.06)})`;
    ctx.fillRect(0,0,W,H);
  }

  requestAnimationFrame(render);
}

function goBack(){
  // mark “watched tv” for flavor
  state.watchedTV = true;
  saveState();
  location.href="Sophie03.html";
}

UI.exitBtn.addEventListener("click", goBack);

render();
</script>
</body>
</html>
