<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Dancefloor â€” Kitchen Party</title>
<style>
  :root{ --bg:#07070b; --fg:#fff; --ui2:rgba(255,255,255,.14); --vio:#8a2eff;}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}

  /* same polish layer as rooms */
  body::before{
    content:""; position:fixed; inset:-20%;
    background:
      radial-gradient(circle at 18% 12%, rgba(138,46,255,.16), transparent 60%),
      radial-gradient(circle at 84% 42%, rgba(0,255,213,.10), transparent 65%),
      radial-gradient(circle at 50% 92%, rgba(138,46,255,.10), transparent 70%);
    filter:blur(40px) saturate(1.15);
    animation:drift 12s ease-in-out infinite;
    pointer-events:none;
  }
  body::after{
    content:""; position:fixed; inset:0; pointer-events:none;
    background:
      radial-gradient(1200px 900px at 50% 45%, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 70%, rgba(0,0,0,.60) 100%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.018) 0 1px, transparent 1px 4px);
    mix-blend-mode:overlay; opacity:.55;
  }
  @keyframes drift{0%,100%{transform:translate3d(0,0,0)}50%{transform:translate3d(1.5%, -1.5%,0)}}

  .wrap{height:100%; display:grid; place-items:center;}
  canvas{width:min(980px, 100vw); height:auto; image-rendering:pixelated; image-rendering:crisp-edges; touch-action:none;}

  .hud{
    position:fixed; left:12px; right:12px; top:12px; z-index:5;
    display:flex; gap:10px; flex-wrap:wrap; pointer-events:none;
  }
  .pill{
    pointer-events:auto; border:1px solid var(--ui2); background:rgba(0,0,0,.35);
    backdrop-filter: blur(8px);
    border-radius:999px; padding:10px 12px;
    font-size:11px; letter-spacing:.18em; text-transform:uppercase;
    display:flex; gap:10px; align-items:center;
  }
  .toast{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    border:1px solid var(--ui2); background:rgba(0,0,0,.55);
    border-radius:14px; padding:10px 12px;
    font-size:12px; letter-spacing:.08em; opacity:0; transition:.2s;
    max-width:min(720px, calc(100vw - 24px)); text-align:center;
    z-index:6;
  }
  .toast.on{opacity:1}
</style>
</head>
<body>
<div class="hud">
  <div class="pill"><b>SOPHIA</b> <span>DANCEFLOOR</span></div>
  <div class="pill">BEAT: <span id="beat">128</span></div>
  <div class="pill">HYPE: <span id="hype">0</span></div>
  <div class="pill">Moves: C toggle groove Â· SPACE hit Â· Arrow keys step</div>
  <div class="pill">E â†’ KITCHEN</div>
</div>
<div class="toast" id="toast"></div>
<div class="wrap"><canvas id="c" width="320" height="180"></canvas></div>

<script>
const STORE_KEY="SOPHIA_AUDITION_SAVE_V1";
function loadState(){
  const r=localStorage.getItem(STORE_KEY);
  if(r){try{return JSON.parse(r);}catch(e){}}
  return { drunk:false, dancedMs:0, lucas:{inKitchen:false, dancing:false}, sophia:{x:160,y:120}, milo:{x:148,y:132} };
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

let state=loadState();
if(!state.drunk){
  // This page is meant as the "club overlay" after blending.
  // If you arrive sober, we keep it playable but tell you.
}
state.lucas = state.lucas || {inKitchen:false, dancing:false};

const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d",{alpha:false});
ctx.imageSmoothingEnabled=false;

const UI={
  beat:document.getElementById("beat"),
  hype:document.getElementById("hype"),
  toast:document.getElementById("toast"),
};

function toast(msg,ms=1500){
  UI.toast.textContent=msg;
  UI.toast.classList.add("on");
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>UI.toast.classList.remove("on"),ms);
}

const keysDown=new Set();
addEventListener("keydown",(e)=>{
  const k=e.key.toLowerCase();
  if(["arrowup","arrowdown","arrowleft","arrowright"," ","shift","w","a","s","d","e","c"].includes(k)) e.preventDefault();
  keysDown.add(k);
});
addEventListener("keyup",(e)=>keysDown.delete(e.key.toLowerCase()));

const W=canvas.width,H=canvas.height;
let t=0;
let groove=false;
let hype=0;
let beat=128;

const sophia={x:160,y:120,w:10,h:12};
const lucas={x:140,y:122,w:10,h:12};
const milo={x:176,y:130,w:8,h:8};

function drawRectBevel(x,y,w,h,fill){
  ctx.fillStyle=fill; ctx.fillRect(x,y,w,h);
  ctx.fillStyle="rgba(255,255,255,.08)"; ctx.fillRect(x,y,w,1);
  ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(x,y+h-1,w,1);
  ctx.fillStyle="rgba(255,255,255,.06)"; ctx.fillRect(x,y,1,h);
  ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(x+w-1,y,1,h);
}
function vignette(){
  ctx.fillStyle="rgba(0,0,0,.18)";
  ctx.fillRect(0,0,W,12); ctx.fillRect(0,H-12,W,12);
  ctx.fillRect(0,0,12,H); ctx.fillRect(W-12,0,12,H);
}
function drawSophia(t){
  const x=(sophia.x|0), y=(sophia.y|0);
  const wob = groove ? (Math.sin(t*0.35)*1.5|0) : 0;
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(x-1,y+11,12,2);
  ctx.fillStyle="#f2d27a"; ctx.fillRect(x+1+wob,y+0,8,4); ctx.fillRect(x+0+wob,y+3,10,3);
  ctx.fillStyle="#ffd9c9"; ctx.fillRect(x+2+wob,y+5,6,4);
  ctx.fillStyle="#67b7ff"; ctx.fillRect(x+3+wob,y+6,1,1); ctx.fillRect(x+6+wob,y+6,1,1);
  ctx.fillStyle="rgba(138,46,255,.55)"; ctx.fillRect(x+2+wob,y+9,6,3);
  ctx.fillStyle="rgba(255,255,255,.14)"; ctx.fillRect(x+3+wob,y+10,4,1);
}
function drawLucas(t){
  const x=(lucas.x|0), y=(lucas.y|0);
  const bop = groove ? (Math.sin(t*0.30)*1.2|0) : 0;
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(x-1,y+11,12,2);
  ctx.fillStyle="rgba(120,70,40,.45)"; ctx.fillRect(x+1,y+0+bop,8,4);
  ctx.fillStyle="rgba(255,217,201,.95)"; ctx.fillRect(x+2,y+4+bop,6,4);
  ctx.fillStyle="rgba(0,255,213,.10)"; ctx.fillRect(x+1,y+7+bop,8,6);
  if((t%18<9)){
    ctx.fillStyle="rgba(255,255,255,.12)";
    ctx.fillRect(x+9,y+9+bop,2,2);
  }
}
function drawMilo(t){
  const x=(milo.x|0), y=(milo.y|0);
  const bop = groove ? (Math.sin(t*0.42)*1.3|0) : 0;
  ctx.fillStyle="rgba(0,0,0,.40)"; ctx.fillRect(x-1,y+7,10,2);
  ctx.fillStyle="#d8d8d8"; ctx.fillRect(x+1,y+2+bop,6,5);
  ctx.fillStyle="#cfcfcf"; ctx.fillRect(x+1,y+1+bop,2,2); ctx.fillRect(x+5,y+1+bop,2,2);
  ctx.fillStyle="rgba(26,255,211,.95)"; ctx.fillRect(x+2,y+4+bop,1,1); ctx.fillRect(x+5,y+4+bop,1,1);
  ctx.fillStyle="#cfcfcf"; ctx.fillRect(x+7,y+3+bop,1,3);
}

function drawFloor(t){
  // dark room
  ctx.fillStyle="#05050a"; ctx.fillRect(0,0,W,H);

  // disco tiles
  const fx=46, fy=76, fw=228, fh=92;
  drawRectBevel(fx,fy,fw,fh,"rgba(255,255,255,.04)");
  const tile=10;
  for(let y=fy+2;y<fy+fh-2;y+=tile){
    for(let x=fx+2;x<fx+fw-2;x+=tile){
      const s = Math.sin((t*0.14)+(x*0.07)+(y*0.09));
      const a = 0.05 + 0.12*(0.5+0.5*s);
      const c1 = `rgba(138,46,255,${a})`;
      const c2 = `rgba(0,255,213,${a*0.9})`;
      ctx.fillStyle = ((x+y)/tile)%2===0 ? c1 : c2;
      ctx.fillRect(x,y,tile-1,tile-1);
    }
  }

  // overhead glow pulse
  ctx.fillStyle=`rgba(255,99,255,${0.06+0.05*Math.sin(t*0.10)})`;
  ctx.fillRect(0,0,W,H);
  for(let y=0;y<H;y+=3){
    ctx.fillStyle=`rgba(0,255,213,${0.02 + 0.02*Math.sin(t*0.12 + y*0.2)})`;
    ctx.fillRect(0,y,W,1);
  }
}

function goBack(){
  // persist dance time
  state.dancedMs = (state.dancedMs||0) + (groove? 800 : 0);
  saveState();
  location.href="Sophie04.html";
}

function loop(){
  t++;

  if(keysDown.has("e") && !loop._e){ goBack(); loop._e=1; }
  if(!keysDown.has("e")) loop._e=0;

  // move step (tiny)
  let dx=0,dy=0;
  if(keysDown.has("arrowleft")||keysDown.has("a")) dx=-0.9;
  if(keysDown.has("arrowright")||keysDown.has("d")) dx=0.9;
  if(keysDown.has("arrowup")||keysDown.has("w")) dy=-0.9;
  if(keysDown.has("arrowdown")||keysDown.has("s")) dy=0.9;
  sophia.x = Math.max(54, Math.min(W-54, sophia.x+dx));
  sophia.y = Math.max(86, Math.min(H-24, sophia.y+dy));

  // Lucas stays close
  lucas.x += ((sophia.x-18)-lucas.x)*0.06;
  lucas.y += ((sophia.y+2)-lucas.y)*0.06;
  milo.x += ((sophia.x+16)-milo.x)*0.08;
  milo.y += ((sophia.y+10)-milo.y)*0.08;

  // groove toggle
  if(keysDown.has("c")){
    if(!loop._c){
      groove=!groove;
      toast(groove ? "Groove ON. The kitchen turns into a club." : "Groove OFF. Catch your breath.", 1500);
    }
    loop._c=1;
  } else loop._c=0;

  // hit beat (space)
  if((keysDown.has(" ")||keysDown.has("space"))){
    if(!loop._sp){
      // â€œgood hitâ€ window
      const good = (t%24<8);
      hype += good ? 3 : 1;
      if(good) toast("Perfect. ðŸ’«", 700);
      loop._sp=1;
    }
  } else loop._sp=0;

  // decay
  hype = Math.max(0, hype - 0.05);
  beat = 124 + ((Math.sin(t*0.01)*4)|0);

  // draw
  drawFloor(t);

  // confetti sparks when hype high
  if(hype>18 && (t%3===0)){
    const x=60+(Math.random()*200|0), y=84+(Math.random()*70|0);
    ctx.fillStyle=`rgba(255,255,255,${0.05+Math.random()*0.12})`;
    ctx.fillRect(x,y,1,1);
  }

  drawLucas(t);
  drawMilo(t);
  drawSophia(t);
  vignette();

  UI.hype.textContent = String(hype|0);
  UI.beat.textContent = String(beat);

  requestAnimationFrame(loop);
}

toast(state.drunk ? "Party unlocked. C to groove." : "Youâ€™re soberâ€¦ but the floor still remembers.", 1700);
loop();
</script>
</body>
</html>
