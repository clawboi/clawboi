<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Sophia's Audition — Train Milo</title>
<style>
  :root{ --bg:#07070b; --fg:#fff; --ui2:rgba(255,255,255,.14); --vio:#8a2eff;}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  body::before{content:"";position:fixed;inset:-20%;background:
      radial-gradient(circle at 20% 10%, rgba(138,46,255,.16), transparent 60%),
      radial-gradient(circle at 80% 40%, rgba(0,255,213,.10), transparent 65%),
      radial-gradient(circle at 50% 92%, rgba(138,46,255,.10), transparent 70%);
    filter:blur(40px) saturate(1.15); animation:drift 12s ease-in-out infinite; pointer-events:none;}
  body::after{content:"";position:fixed;inset:0;pointer-events:none;background:
      radial-gradient(1200px 900px at 50% 45%, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 70%, rgba(0,0,0,.60) 100%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.018) 0 1px, transparent 1px 4px);
    mix-blend-mode:overlay; opacity:.55;}
  @keyframes drift{0%,100%{transform:translate3d(0,0,0)}50%{transform:translate3d(1.5%,-1.5%,0)}}
  .wrap{height:100%; display:grid; place-items:center;}
  canvas{width:min(980px, 100vw); height:auto; image-rendering:pixelated; image-rendering:crisp-edges; touch-action:none;}
  .hud{position:fixed;left:12px;right:12px;top:12px;z-index:5;display:flex;gap:10px;flex-wrap:wrap;pointer-events:none;}
  .pill{pointer-events:auto;border:1px solid var(--ui2);background:rgba(0,0,0,.35);backdrop-filter:blur(8px);border-radius:999px;padding:10px 12px;font-size:11px;letter-spacing:.18em;text-transform:uppercase;display:flex;gap:10px;align-items:center;}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);border:1px solid var(--ui2);background:rgba(0,0,0,.55);border-radius:14px;padding:10px 12px;font-size:12px;letter-spacing:.08em;opacity:0;transition:.2s;max-width:min(720px,calc(100vw - 24px));text-align:center;z-index:6;}
  .toast.on{opacity:1}
</style>
</head>
<body>
<div class="hud">
  <div class="pill"><b>SOPHIA</b> <span>TRAIN MILO</span></div>
  <div class="pill">FOCUS: <span id="focus">0%</span></div>
  <div class="pill">TREATS: <span id="treats">0</span></div>
  <div class="pill">Hold SPACE to focus beam · Tap to lure</div>
  <div class="pill">E → LIVING ROOM</div>
</div>
<div class="toast" id="toast"></div>
<div class="wrap"><canvas id="c" width="320" height="180"></canvas></div>

<script>
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d',{alpha:false});
ctx.imageSmoothingEnabled=false;

const UI={ focus:document.getElementById('focus'), treats:document.getElementById('treats'), toast:document.getElementById('toast') };

const STORE_KEY="SOPHIA_AUDITION_SAVE_V1";
function loadState(){
  const r=localStorage.getItem(STORE_KEY);
  if(r){ try{return JSON.parse(r);}catch(e){} }
  return { trip:false, inv:{shrooms:0, grapes:0}, miloSkill:0, sophia:{x:160,y:120}, milo:{x:148,y:132} };
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
let state=loadState();
state.inv = state.inv || {shrooms:0, grapes:0};
if(typeof state.miloSkill!=="number") state.miloSkill=0;

function toast(msg,ms=1500){
  UI.toast.textContent=msg;
  UI.toast.classList.add('on');
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>UI.toast.classList.remove('on'),ms);
}

const keysDown=new Set();
addEventListener('keydown',(e)=>{
  const k=e.key.toLowerCase();
  if(["arrowup","arrowdown","arrowleft","arrowright"," ","shift","w","a","s","d","e","c"].includes(k)) e.preventDefault();
  keysDown.add(k);
});
addEventListener('keyup',(e)=>keysDown.delete(e.key.toLowerCase()));

const W=canvas.width,H=canvas.height;

function drawSophia(x,y){
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(x-1,y+11,12,2);
  ctx.fillStyle="#f2d27a"; ctx.fillRect(x+1,y+0,8,4); ctx.fillRect(x+0,y+3,10,3);
  ctx.fillStyle="#ffd9c9"; ctx.fillRect(x+2,y+5,6,4);
  ctx.fillStyle="#67b7ff"; ctx.fillRect(x+3,y+6,1,1); ctx.fillRect(x+6,y+6,1,1);
  ctx.fillStyle="rgba(138,46,255,.55)"; ctx.fillRect(x+2,y+9,6,3);
  ctx.fillStyle="rgba(255,255,255,.14)"; ctx.fillRect(x+3,y+10,4,1);
}
function drawMilo(x,y,t,focused){
  ctx.fillStyle="rgba(0,0,0,.40)"; ctx.fillRect(x-1,y+7,10,2);
  ctx.fillStyle="#d8d8d8"; ctx.fillRect(x+1,y+2,6,5);
  ctx.fillStyle="#cfcfcf"; ctx.fillRect(x+1,y+1,2,2); ctx.fillRect(x+5,y+1,2,2);
  const eye = focused ? "rgba(0,255,213,.95)" : "rgba(255,99,255,.85)";
  ctx.fillStyle=eye; ctx.fillRect(x+2,y+4,1,1); ctx.fillRect(x+5,y+4,1,1);
  ctx.fillStyle="#cfcfcf"; ctx.fillRect(x+7,y+3+((Math.sin(t*0.2)*1)|0),1,3);
}
function vignette(){
  ctx.fillStyle="rgba(0,0,0,.18)";
  ctx.fillRect(0,0,W,12); ctx.fillRect(0,H-12,W,12);
  ctx.fillRect(0,0,12,H); ctx.fillRect(W-12,0,12,H);
}

function goBack(){ saveState(); location.href="Sophie03.html"; }

// Game: keep Milo inside a moving “focus ring” while holding SPACE.
// Tap/click drops a treat lure that pulls ring toward it.
let focus=0;         // 0..100
let treats=0;
let t=0;

const ring = { x:160, y:88, r:14, tx:160, ty:88 };
const milo = { x:200, y:110, vx:0.6, vy:-0.4 };

let lure=null; // {x,y,life}
canvas.addEventListener('pointerdown',(e)=>{
  const rect=canvas.getBoundingClientRect();
  const x=((e.clientX-rect.left)/rect.width)*W;
  const y=((e.clientY-rect.top)/rect.height)*H;
  lure={x,y,life:120};
  toast("Treat toss.", 900);
});

function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function dist2(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy; }

function updateRing(){
  // base drift
  ring.tx = 160 + Math.sin(t*0.02)*34;
  ring.ty = 86 + Math.cos(t*0.017)*22;

  // lure influence
  if(lure){
    ring.tx += (lure.x - ring.tx)*0.55;
    ring.ty += (lure.y - ring.ty)*0.55;
    lure.life--;
    if(lure.life<=0) lure=null;
  }

  ring.x += (ring.tx-ring.x)*0.08;
  ring.y += (ring.ty-ring.y)*0.08;
  ring.x = clamp(ring.x, 30, W-30);
  ring.y = clamp(ring.y, 30, H-30);
}

function updateMilo(){
  // Milo floats around with soft chaos
  milo.vx += (Math.sin(t*0.05)*0.02);
  milo.vy += (Math.cos(t*0.045)*0.02);

  // if beam held, Milo drifts toward ring center more
  const focusing = (keysDown.has(" ")||keysDown.has("space"));
  if(focusing){
    const dx=(ring.x-milo.x), dy=(ring.y-milo.y);
    milo.vx += dx*0.0025;
    milo.vy += dy*0.0025;
  }

  milo.vx *= 0.985;
  milo.vy *= 0.985;

  milo.x += milo.vx;
  milo.y += milo.vy;

  // bounds bounce
  if(milo.x<18){milo.x=18; milo.vx*=-0.8}
  if(milo.x>W-18){milo.x=W-18; milo.vx*=-0.8}
  if(milo.y<26){milo.y=26; milo.vy*=-0.8}
  if(milo.y>H-18){milo.y=H-18; milo.vy*=-0.8}

  // scoring: keep Milo inside ring while holding beam
  if(focusing){
    const inside = dist2(milo.x,milo.y, ring.x, ring.y) <= (ring.r*ring.r);
    focus += inside ? 0.55 : -0.70;
  } else {
    focus -= 0.18; // decay when not training
  }

  focus = clamp(focus, 0, 100);

  // rewards
  if(focus>=100 && !updateMilo._win){
    updateMilo._win=1;
    treats++;
    state.miloSkill = Math.min(999, (state.miloSkill||0) + 1);
    saveState();
    toast("Milo mastered focus. +1 treat.", 1600);
    // reset a bit so you can farm but not instantly
    focus = 62;
    setTimeout(()=>updateMilo._win=0, 700);
  }
}

function syncHUD(){
  UI.focus.textContent = `${Math.round(focus)}%`;
  UI.treats.textContent = String(treats);
}

function draw(){
  ctx.fillStyle="#05050a"; ctx.fillRect(0,0,W,H);

  // soft glow
  const g=ctx.createRadialGradient(160,68,10,160,68,190);
  g.addColorStop(0,"rgba(255,255,255,.06)");
  g.addColorStop(0.35,"rgba(138,46,255,.10)");
  g.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // mat / toy zone
  ctx.fillStyle="rgba(255,255,255,.05)"; ctx.fillRect(10,110,300,60);
  ctx.fillStyle="rgba(255,99,255,.06)"; ctx.fillRect(46,126,228,22);

  // ring
  ctx.fillStyle="rgba(0,0,0,.40)";
  ctx.fillRect((ring.x-ring.r-2)|0, (ring.y-ring.r-2)|0, (ring.r*2+4)|0, (ring.r*2+4)|0);
  ctx.fillStyle="rgba(0,255,213,.08)";
  ctx.fillRect((ring.x-ring.r)|0, (ring.y-ring.r)|0, (ring.r*2)|0, (ring.r*2)|0);

  // lure
  if(lure){
    ctx.fillStyle="rgba(255,210,77,.12)";
    ctx.fillRect((lure.x-2)|0, (lure.y-2)|0, 4, 4);
    ctx.fillStyle="rgba(255,255,255,.10)";
    ctx.fillRect((lure.x-1)|0, (lure.y-1)|0, 2, 2);
  }

  // beam
  const focusing = (keysDown.has(" ")||keysDown.has("space"));
  if(focusing){
    ctx.fillStyle=`rgba(0,255,213,${0.06+0.04*Math.sin(t*0.12)})`;
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle="rgba(255,255,255,.05)";
    ctx.fillRect(0, (ring.y|0), W, 1);
  }

  // characters
  drawSophia(62,102);
  drawMilo((milo.x|0), (milo.y|0), t, focusing);

  // progress bar
  ctx.fillStyle="rgba(255,255,255,.06)";
  ctx.fillRect(96,30,128,8);
  ctx.fillStyle="rgba(0,255,213,.12)";
  ctx.fillRect(96,30, (128*(focus/100))|0, 8);

  vignette();
}

function loop(){
  t++;

  if(keysDown.has("e") && !loop._e){ goBack(); loop._e=1; }
  if(!keysDown.has("e")) loop._e=0;

  updateRing();
  updateMilo();
  syncHUD();
  draw();

  requestAnimationFrame(loop);
}
toast("Train Milo: hold SPACE to focus him inside the ring.", 1700);
loop();
</script>
</body>
</html>
