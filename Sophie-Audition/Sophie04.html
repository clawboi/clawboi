<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Sophia's Audition 04 — Kitchen</title>
<style>
  :root{ --bg:#07070b; --fg:#fff; --ui2:rgba(255,255,255,.14); --vio:#8a2eff; --aqua:#00ffd5;}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{height:100%; display:grid; place-items:center;}
  canvas{width:min(980px, 100vw); height:auto; image-rendering:pixelated; image-rendering:crisp-edges; touch-action:none;}
  .hud{
    position:fixed; left:12px; right:12px; top:12px; z-index:6;
    display:flex; gap:10px; flex-wrap:wrap; pointer-events:none;
  }
  .pill{
    pointer-events:auto; border:1px solid var(--ui2); background:rgba(0,0,0,.35);
    backdrop-filter: blur(8px);
    border-radius:999px; padding:10px 12px;
    font-size:11px; letter-spacing:.18em; text-transform:uppercase;
    display:flex; gap:10px; align-items:center;
  }
  .toast{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    border:1px solid var(--ui2); background:rgba(0,0,0,.55);
    border-radius:14px; padding:10px 12px;
    font-size:12px; letter-spacing:.08em; opacity:0; transition:.2s;
    max-width:min(720px, calc(100vw - 24px)); text-align:center;
    z-index:7;
  }
  .toast.on{opacity:1}
  .microhint{
    position:fixed; right:12px; bottom:12px; z-index:5;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.35);
    backdrop-filter: blur(8px);
    border-radius:14px;
    padding:8px 10px;
    font-size:10px;
    letter-spacing:.12em;
    opacity:.85;
    pointer-events:none;
  }
  .nowplaying{
    position:fixed; left:12px; bottom:12px; z-index:5;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.35);
    backdrop-filter: blur(8px);
    border-radius:14px;
    padding:8px 10px;
    font-size:10px;
    letter-spacing:.10em;
    opacity:.85;
    max-width:52vw;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    pointer-events:none;
  }
</style>
</head>
<body>

<div class="hud">
  <div class="pill"><b>SOPHIA</b> <span>KITCHEN</span></div>
  <div class="pill">PUKE: <span id="puke">NO</span></div>
  <div class="pill">LUCAS: <span id="lucas">NOT HERE</span></div>
  <div class="pill">DRUNK: <span id="drunk">NO</span></div>
  <div class="pill">Door → Living Room (left)</div>
  <div class="pill">Move: WASD/Arrows · Interact: E · Run: Shift</div>
</div>

<div class="toast" id="toast"></div>
<div class="microhint">Try: Blender · Record Player · Dance Floor · Window · Lucas Talk</div>
<div class="nowplaying" id="np">♪ no record spinning</div>

<div class="wrap"><canvas id="c" width="320" height="180"></canvas></div>

<!-- audio lives in this page, resumes from localStorage -->
<audio id="bgm" preload="auto" loop></audio>

<script>
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d',{alpha:false});
ctx.imageSmoothingEnabled=false;

const UI={
  puke:document.getElementById('puke'),
  lucas:document.getElementById('lucas'),
  drunk:document.getElementById('drunk'),
  toast:document.getElementById('toast'),
  np:document.getElementById('np'),
};

const STORE_KEY="SOPHIA_AUDITION_SAVE_V1";
const AUDIO_KEY="SOPHIA_AUDITION_AUDIO_V1";

function loadState(){ const r=localStorage.getItem(STORE_KEY); if(r){try{return JSON.parse(r);}catch(e){}}
  return {
    hasKeys:false, slept:false, trip:false, puke:false,
    poemLines:0, guitarPlayed:0, lastRoom:"KITCHEN",
    hat:false,
    lucas:{ mood:0, following:false, attempts:0, unlocked:false, inKitchen:false },
    kitchen:{ margaritaDone:false, drunk:false, dancedMs:0, party:{ bella:false, whiskers:false } },
    sophia:{x:160,y:120}, milo:{x:148,y:132}
  };
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

function loadAudio(){ const r=localStorage.getItem(AUDIO_KEY); if(r){try{return JSON.parse(r);}catch(e){}}
  return { src:"", title:"", playing:false, t:0, vol:0.85 };
}
function saveAudio(a){ localStorage.setItem(AUDIO_KEY, JSON.stringify(a)); }

let state=loadState();
state.lastRoom="KITCHEN";
state.lucas = state.lucas || { mood:0, following:false, attempts:0, unlocked:false, inKitchen:false };
state.kitchen = state.kitchen || { margaritaDone:false, drunk:false, dancedMs:0, party:{ bella:false, whiskers:false } };
state.kitchen.party = state.kitchen.party || { bella:false, whiskers:false };
saveState();

function toast(msg,ms=1500){
  UI.toast.textContent=msg;
  UI.toast.classList.add('on');
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>UI.toast.classList.remove('on'),ms);
}

UI.puke.textContent = state.puke ? "YES" : "NO";
UI.lucas.textContent = state.lucas.inKitchen ? (state.lucas.following ? "HERE + FOLLOWING" : "HERE") : (state.lucas.following ? "FOLLOWING (NOT HERE)" : "NOT HERE");
UI.drunk.textContent = state.kitchen.drunk ? "YES" : "NO";

/* ---------------- AUDIO RESUME ---------------- */
const bgm=document.getElementById("bgm");
let audioState = loadAudio();

function setNowPlaying(){
  if(audioState.playing && audioState.title) UI.np.textContent = "♪ " + audioState.title;
  else UI.np.textContent = "♪ no record spinning";
}
setNowPlaying();

async function resumeAudio(){
  audioState = loadAudio();
  if(!audioState.src) return;
  try{
    bgm.src = audioState.src;
    bgm.volume = Math.max(0, Math.min(1, audioState.vol ?? 0.85));
    bgm.currentTime = Math.max(0, audioState.t || 0);
    if(audioState.playing){
      await bgm.play(); // may require user gesture on some browsers
    }
  }catch(e){
    // if autoplay blocked, we'll start once player presses E anywhere
  }
  setNowPlaying();
}

function captureAudioState(){
  const a = loadAudio();
  if(bgm.src){
    a.src = bgm.currentSrc || bgm.src;
    a.t = bgm.currentTime || 0;
    a.playing = !bgm.paused;
    a.vol = bgm.volume;
    // keep title as-is
    saveAudio(a);
  }
}
setInterval(captureAudioState, 250);

resumeAudio();

/* if autoplay blocked, first E press will “unlock” audio */
let audioUnlocked=false;

/* input */
const keysDown=new Set();
addEventListener('keydown',(e)=>{
  const k=e.key.toLowerCase();
  if(["arrowup","arrowdown","arrowleft","arrowright"," ","shift","w","a","s","d","e"].includes(k)) e.preventDefault();
  keysDown.add(k);
});
addEventListener('keyup',(e)=>keysDown.delete(e.key.toLowerCase()));

/* world */
const W=canvas.width,H=canvas.height;
const solids=[
  [0,0,W,10],[0,0,10,H],[0,H-10,W,10],[W-10,0,10,H],
  // counter
  [40,62,240,22],
  // table
  [120,112,60,18],
  // fridge
  [240,34,44,46],
  // dance floor “anchor”
  [52,128,70,34],
  // record console anchor
  [200,112,70,28],
  // window ledge
  [26,28,64,26],
  // blender corner
  [96,62,36,22],
];

const zones=[
  {name:"DOOR_LIVING", rect:[10,78,10,28], action: ()=>go("Sophie03.html")},

  {name:"FRIDGE", rect:[244,38,36,38], action: eatGross},
  {name:"SINK", rect:[70,64,40,18], action: rinse},

  // NEW kitchen gameplay
  {name:"BLENDER", rect:[96,62,36,22], action: startMargarita},
  {name:"RECORD PLAYER", rect:[200,112,70,28], action: ()=>go("recordplayer.html")},
  {name:"DANCE FLOOR", rect:[52,128,70,34], action: toggleDance},
  {name:"WINDOW", rect:[26,28,64,26], action: ()=>go("window.html")},
  {name:"TALK TO LUCAS", rect:[206,86,60,18], action: talkToLucas},
];

const sophia={x:state.sophia.x,y:state.sophia.y,w:10,h:12,speed:0.85,run:1.35};
const milo={x:state.milo.x,y:state.milo.y,w:8,h:8};

// Lucas “presence” in kitchen (visual only; talk is separate page)
const lucas = { x:226, y:92, w:10, h:12 };

// party guests (spawn only while dancing)
const bella = { x:74, y:154, w:10, h:10 };
const whiskers = { x:96, y:154, w:8, h:8 };

function rectsOverlap(ax,ay,aw,ah,bx,by,bw,bh){
  return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by;
}
function collides(x,y,w,h){
  for(const s of solids){
    if(rectsOverlap(x,y,w,h,s[0],s[1],s[2],s[3])) return true;
  }
  return false;
}
function tryMove(ent,dx,dy){
  const nx=ent.x+dx, ny=ent.y+dy;
  if(!collides(nx,ent.y,ent.w,ent.h)) ent.x=nx;
  if(!collides(ent.x,ny,ent.w,ent.h)) ent.y=ny;
}
function nearestZone(){
  const px=sophia.x+sophia.w/2, py=sophia.y+sophia.h/2;
  let best=null, bd=9999;
  for(const z of zones){
    const [x,y,w,h]=z.rect; const cx=x+w/2, cy=y+h/2;
    const d=(cx-px)*(cx-px)+(cy-py)*(cy-py);
    if(d<bd && d<1400){ bd=d; best=z; }
  }
  return best;
}
function interact(){
  const z=nearestZone();
  if(z) z.action();
}

/* ---------- fridge/sink (kept) ---------- */
let pukeAnim=0;
function eatGross(){
  state.puke = true;
  saveState();
  UI.puke.textContent="YES";
  pukeAnim=90;
  toast("She eats something ancient. Regret arrives immediately.", 1900);
}
function rinse(){
  if(!state.puke) return toast("She rinses her hands. Milo approves.", 1400);
  state.puke=false;
  saveState();
  UI.puke.textContent="NO";
  toast("Cold water. Deep breath. Back to mission.", 1600);
}

/* ---------- margarita blender arc ---------- */
let blend= { active:false, p:0, done:false, buzz:0 };
function startMargarita(){
  if(state.kitchen.margaritaDone) return toast("The blender jar is empty. You already made it.", 1700);
  if(blend.active) return toast("Blender already going. Hold on.", 1400);

  blend.active=true;
  blend.p=0;
  blend.done=false;
  toast("You pour margarita daiquiri mix. The blender clicks on.", 1700);

  // if Lucas is following (from living room unlock), this is where he “comes inside”
  setTimeout(()=>{
    toast("The blender gets LOUD. Milo’s ears go airplane-mode.", 1600);
  }, 650);
}
function finishMargarita(){
  blend.active=false;
  blend.done=true;
  state.kitchen.margaritaDone=true;
  state.kitchen.drunk=true;
  saveState();
  UI.drunk.textContent="YES";

  if(state.lucas.following || state.lucas.unlocked){
    state.lucas.inKitchen=true;
    saveState();
    UI.lucas.textContent = state.lucas.following ? "HERE + FOLLOWING" : "HERE";
    toast("Lucas walks in at the final whirl. You both share a drink. Warm dizziness arrives.", 2400);
  }else{
    toast("You sip alone. The world softens at the edges.", 2100);
  }
}

/* ---------- dance system ---------- */
let dancing=false;
let dancePulse=0;

function toggleDance(){
  if(!audioUnlocked && loadAudio().playing){
    // try unlock audio on interaction
    bgm.play().catch(()=>{});
    audioUnlocked=true;
  }

  if(!state.kitchen.drunk && !loadAudio().playing){
    // you can still dance, but it’s “dry”
    dancing = !dancing;
    state.kitchen.dancedMs = 0;
    state.kitchen.party.bella=false;
    state.kitchen.party.whiskers=false;
    saveState();
    toast(dancing ? "You start dancing. No music. Pure courage." : "You stop dancing.", 1600);
    return;
  }

  dancing = !dancing;
  if(!dancing){
    state.kitchen.dancedMs = 0;
    state.kitchen.party.bella=false;
    state.kitchen.party.whiskers=false;
    saveState();
    toast("You stop dancing. Bella and Whiskers vanish like they were never real.", 1900);
  }else{
    toast("You start dancing. Lucas mirrors you. The kitchen becomes a tiny club.", 1900);
  }
}

/* dance progression:
   - 2s: lucas dances (if present)
   - 6s: milo dances
   - 10s: bella approaches and dances
   - 14s: whiskers appears and dances
*/
function updateDance(dt){
  if(!dancing){ dancePulse *= 0.85; return; }

  state.kitchen.dancedMs = (state.kitchen.dancedMs||0) + dt;
  saveState();

  const ms=state.kitchen.dancedMs;

  // milo dance trigger
  if(ms>6000) {
    // nothing to store; purely visual
  }

  // bella + whiskers only while dancing
  if(ms>10000 && !state.kitchen.party.bella){
    state.kitchen.party.bella=true; saveState();
    toast("Bella the dog trots in and starts dancing like she invented rhythm.", 2200);
  }
  if(ms>14000 && !state.kitchen.party.whiskers){
    state.kitchen.party.whiskers=true; saveState();
    toast("Whiskers the cat shows up. He dances like a tiny professor of funk.", 2200);
  }

  dancePulse = Math.min(1, dancePulse + 0.03);
}

/* ---------- talk to lucas gate ---------- */
function talkToLucas(){
  if(!state.lucas.inKitchen && !state.lucas.following){
    return toast("Lucas isn’t here. Make the margarita or get him to follow first.", 1900);
  }
  if(!state.kitchen.margaritaDone){
    return toast("He’s still in pre-drink mode. Blend the margarita first.", 1800);
  }
  go("lucastalk.html");
}

/* navigation */
function go(file){
  state.sophia.x=sophia.x; state.sophia.y=sophia.y;
  state.milo.x=milo.x; state.milo.y=milo.y;
  saveState();
  captureAudioState();
  location.href=file;
}

/* render helpers */
function drawRectBevel(x,y,w,h,fill){
  ctx.fillStyle=fill; ctx.fillRect(x,y,w,h);
  ctx.fillStyle="rgba(255,255,255,.08)"; ctx.fillRect(x,y,w,1);
  ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(x,y+h-1,w,1);
  ctx.fillStyle="rgba(255,255,255,.06)"; ctx.fillRect(x,y,1,h);
  ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(x+w-1,y,1,h);
}
function drawHintBubble(text,x,y){
  const pad=3;
  ctx.font="8px ui-monospace, monospace";
  const m=ctx.measureText(text);
  const w=Math.ceil(m.width)+pad*2, h=12;
  ctx.fillStyle="rgba(0,0,0,.65)"; ctx.fillRect(x-w/2,y-h,w,h);
  ctx.strokeStyle="rgba(255,255,255,.12)"; ctx.strokeRect(x-w/2+0.5,y-h+0.5,w-1,h-1);
  ctx.fillStyle="rgba(255,255,255,.9)"; ctx.fillText(text,x-w/2+pad,y-4);
}

/* sprites (kept consistent with your style) */
function drawSophia(){
  const x=Math.round(sophia.x), y=Math.round(sophia.y);
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(x-1,y+11,12,2);
  ctx.fillStyle="#f2d27a"; ctx.fillRect(x+1,y+0,8,4); ctx.fillRect(x+0,y+3,10,3);
  ctx.fillStyle="#ffd9c9"; ctx.fillRect(x+2,y+5,6,4);
  ctx.fillStyle="#67b7ff"; ctx.fillRect(x+3,y+6,1,1); ctx.fillRect(x+6,y+6,1,1);
  ctx.fillStyle="rgba(138,46,255,.55)"; ctx.fillRect(x+2,y+9,6,3);
  ctx.fillStyle="rgba(255,255,255,.14)"; ctx.fillRect(x+3,y+10,4,1);
}
function drawMilo(t){
  const x=Math.round(milo.x), y=Math.round(milo.y);
  ctx.fillStyle="rgba(0,0,0,.40)"; ctx.fillRect(x-1,y+7,10,2);
  ctx.fillStyle="#d8d8d8"; ctx.fillRect(x+1,y+2,6,5);
  ctx.fillStyle="#cfcfcf"; ctx.fillRect(x+1,y+1,2,2); ctx.fillRect(x+5,y+1,2,2);
  ctx.fillStyle="#1affd3"; ctx.fillRect(x+2,y+4,1,1); ctx.fillRect(x+5,y+4,1,1);
  ctx.fillStyle="#cfcfcf";
  const wag = Math.round(Math.sin(t*0.18)*1);
  ctx.fillRect(x+7,y+3+wag,1,3);

  // milo dance overlay after 6s dancing
  if(dancing && (state.kitchen.dancedMs||0) > 6000){
    const bop = Math.round(Math.sin(t*0.35)*1);
    ctx.fillStyle="rgba(0,255,213,.14)";
    ctx.fillRect(x-2,y+1+bop,12,1);
    ctx.fillStyle="rgba(255,255,255,.10)";
    ctx.fillRect(x+2,y+0+bop,4,1);
  }
}
function drawLucas(t){
  if(!state.lucas.inKitchen && !state.lucas.following) return;

  // if following, keep him around the record console area
  let lx = lucas.x, ly = lucas.y;
  if(state.lucas.following){
    lx = 220 + Math.sin(t*0.03)*6;
    ly = 98 + Math.cos(t*0.04)*4;
  }

  const x=Math.round(lx), y=Math.round(ly);
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(x-1,y+11,12,2);

  // hair (brown)
  ctx.fillStyle="#5a3b22";
  ctx.fillRect(x+1,y+0,8,4);
  ctx.fillRect(x+0,y+3,10,2);

  // face
  ctx.fillStyle="#ffd9c9";
  ctx.fillRect(x+2,y+5,6,4);

  // eyes (brown) + blink
  const blink = Math.sin(t*0.12) > 0.97;
  ctx.fillStyle="#3b2a1c";
  if(blink){ ctx.fillRect(x+3,y+6,4,1); }
  else{ ctx.fillRect(x+3,y+6,1,1); ctx.fillRect(x+6,y+6,1,1); }

  // shirt
  ctx.fillStyle="rgba(255,255,255,.10)";
  ctx.fillRect(x+2,y+9,6,3);
  ctx.fillStyle="rgba(0,0,0,.55)";
  ctx.fillRect(x+3,y+10,4,1);

  // dance shimmer if dancing
  if(dancing){
    const bop = Math.round(Math.sin(t*0.32)*1);
    ctx.fillStyle="rgba(138,46,255,.14)";
    ctx.fillRect(x-2,y+7+bop,14,1);
  }
}
function drawBella(t){
  if(!dancing || !state.kitchen.party.bella) return;
  const x=Math.round(bella.x + Math.sin(t*0.06)*8), y=Math.round(bella.y + Math.cos(t*0.08)*1);

  ctx.fillStyle="rgba(0,0,0,.40)"; ctx.fillRect(x-1,y+9,12,2);
  // body
  ctx.fillStyle="#c79b6b"; ctx.fillRect(x+2,y+4,8,5);
  // head
  ctx.fillRect(x+0,y+3,4,4);
  // ears
  ctx.fillStyle="#b8875c"; ctx.fillRect(x+1,y+2,1,1); ctx.fillRect(x+3,y+2,1,1);
  // eyes
  ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(x+1,y+4,1,1);
  // collar glow
  ctx.fillStyle="rgba(0,255,213,.18)"; ctx.fillRect(x+2,y+7,4,1);
}
function drawWhiskers(t){
  if(!dancing || !state.kitchen.party.whiskers) return;
  const x=Math.round(whiskers.x + Math.cos(t*0.07)*6), y=Math.round(whiskers.y + Math.sin(t*0.09)*1);

  ctx.fillStyle="rgba(0,0,0,.40)"; ctx.fillRect(x-1,y+7,10,2);
  ctx.fillStyle="#cfcfcf"; ctx.fillRect(x+1,y+2,6,5);
  // ears
  ctx.fillRect(x+1,y+1,2,2); ctx.fillRect(x+5,y+1,2,2);
  // eyes
  ctx.fillStyle="#ff4fd8"; ctx.fillRect(x+2,y+4,1,1); ctx.fillRect(x+5,y+4,1,1);
  // whiskers (tiny)
  ctx.fillStyle="rgba(255,255,255,.10)";
  ctx.fillRect(x+0,y+5,1,1); ctx.fillRect(x+7,y+5,1,1);
}

/* world render */
function drawWorld(t){
  ctx.fillStyle="#05050a"; ctx.fillRect(0,0,W,H);

  // cool kitchen light
  const g=ctx.createRadialGradient(250,40,8,250,40,150);
  g.addColorStop(0,"rgba(255,255,255,.10)");
  g.addColorStop(0.45,"rgba(0,255,213,.04)");
  g.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // walls/floor
  ctx.fillStyle="rgba(255,255,255,.06)"; ctx.fillRect(10,10,W-20,78);
  for(let y=92;y<H-10;y++){
    ctx.fillStyle=`rgba(255,255,255,${(y%6===0)?0.10:0.05})`;
    ctx.fillRect(10,y,W-20,1);
  }

  // counter + sink
  drawRectBevel(40,62,240,22,"rgba(255,255,255,.05)");
  drawRectBevel(70,64,40,18,"rgba(0,0,0,.28)");
  ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(76,70,28,6);

  // blender station
  drawRectBevel(96,62,36,22,"rgba(255,255,255,.05)");
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(100,66,28,14);
  // blender glass glow while blending
  if(blend.active){
    ctx.fillStyle=`rgba(138,46,255,${0.10 + 0.06*Math.sin(t*0.55)})`;
    ctx.fillRect(104,68,20,10);
  }

  // table
  drawRectBevel(120,112,60,18,"rgba(255,255,255,.05)");

  // fridge
  drawRectBevel(240,34,44,46,"rgba(255,255,255,.06)");
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(244,38,36,38);
  ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(279,40,2,34);

  // window
  drawRectBevel(26,28,64,26,"rgba(255,255,255,.05)");
  ctx.fillStyle="rgba(0,0,0,.55)"; ctx.fillRect(30,32,56,18);
  ctx.fillStyle="rgba(0,255,213,.06)"; ctx.fillRect(32,34,52,14);

  // record console
  drawRectBevel(200,112,70,28,"rgba(255,255,255,.05)");
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(204,116,62,10);
  // “spinning” indicator if playing
  const a = loadAudio();
  if(a.playing){
    ctx.fillStyle="rgba(0,255,213,.25)";
    const spin = 206 + (t%20);
    ctx.fillRect(spin,118,6,6);
    ctx.fillStyle="rgba(138,46,255,.15)";
    ctx.fillRect(206,128,58,2);
  }

  // dance floor
  drawRectBevel(52,128,70,34,"rgba(255,255,255,.04)");
  // dance lights
  if(dancing){
    for(let i=0;i<6;i++){
      const px=54 + i*11;
      const py=130 + ((i+t*0.2)%3)*2;
      ctx.fillStyle=`rgba(0,255,213,${0.05+0.06*Math.sin((t+i)*0.3)})`;
      ctx.fillRect(px,py,9,2);
    }
  }

  // door left back
  ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(10,78,10,28);

  // puke overlay
  if(pukeAnim>0){
    ctx.fillStyle=`rgba(0,255,213,${0.06 + 0.06*Math.sin(pukeAnim*0.3)})`;
    ctx.fillRect(0,0,W,H);
    pukeAnim--;
  }

  // drunk wobble overlay
  if(state.kitchen.drunk){
    ctx.fillStyle=`rgba(138,46,255,${0.02 + 0.02*Math.sin(t*0.08)})`;
    ctx.fillRect(0,0,W,H);
  }

  const z=nearestZone();
  if(z) drawHintBubble(z.name, sophia.x+6, sophia.y-10);
}

/* loop */
let lastTs = performance.now();
let t=0;

function loop(ts){
  t++;
  const dt = Math.min(40, ts-lastTs);
  lastTs=ts;

  // blender progression
  if(blend.active){
    blend.p += dt;
    blend.buzz = Math.min(1, blend.buzz + 0.02);
    if(blend.p > 2400){
      finishMargarita();
    }
  }else{
    blend.buzz *= 0.92;
  }

  // movement
  const run=keysDown.has("shift");
  const sp=sophia.speed*(run?sophia.run:1);

  let dx=0,dy=0;
  if(keysDown.has("w")||keysDown.has("arrowup")) dy-=sp;
  if(keysDown.has("s")||keysDown.has("arrowdown")) dy+=sp;
  if(keysDown.has("a")||keysDown.has("arrowleft")) dx-=sp;
  if(keysDown.has("d")||keysDown.has("arrowright")) dx+=sp;
  if(dx&&dy){dx*=0.72; dy*=0.72;}
  if(dx||dy) tryMove(sophia,dx,dy);

  // Milo follow
  const tx=sophia.x-10, ty=sophia.y+6;
  milo.x += (tx-milo.x)*0.06;
  milo.y += (ty-milo.y)*0.06;

  // interact
  if(keysDown.has("e")){
    if(!loop._eWasDown){
      // also unlock audio attempt
      if(loadAudio().playing && !audioUnlocked){
        bgm.play().catch(()=>{});
        audioUnlocked=true;
      }
      interact();
    }
    loop._eWasDown=true;
  } else loop._eWasDown=false;

  // dance update
  updateDance(dt);

  // autosave
  if(t%60===0){
    state.sophia.x=sophia.x; state.sophia.y=sophia.y;
    state.milo.x=milo.x; state.milo.y=milo.y;
    saveState();
  }

  // draw
  drawWorld(t);
  drawBella(t);
  drawWhiskers(t);
  drawLucas(t);
  drawMilo(t);
  drawSophia();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
