<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Sophia's Audition 04 — Kitchen</title>
<style>
  :root{ --bg:#07070b; --fg:#fff; --ui2:rgba(255,255,255,.14); --vio:#8a2eff;}
  html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}

  /* same polish layer as the other rooms */
  body::before{
    content:"";
    position:fixed;
    inset:-20%;
    background:
      radial-gradient(circle at 18% 12%, rgba(138,46,255,.16), transparent 60%),
      radial-gradient(circle at 84% 42%, rgba(0,255,213,.10), transparent 65%),
      radial-gradient(circle at 50% 92%, rgba(138,46,255,.10), transparent 70%);
    filter:blur(40px) saturate(1.15);
    animation:drift 12s ease-in-out infinite;
    pointer-events:none;
  }
  body::after{
    content:"";
    position:fixed;
    inset:0;
    pointer-events:none;
    background:
      radial-gradient(1200px 900px at 50% 45%, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 70%, rgba(0,0,0,.60) 100%),
      repeating-linear-gradient(0deg, rgba(255,255,255,.018) 0 1px, transparent 1px 4px);
    mix-blend-mode:overlay;
    opacity:.55;
  }
  @keyframes drift{0%,100%{transform:translate3d(0,0,0)}50%{transform:translate3d(1.5%, -1.5%,0)}}

  .wrap{height:100%; display:grid; place-items:center;}
  canvas{width:min(980px, 100vw); height:auto; image-rendering:pixelated; image-rendering:crisp-edges; touch-action:none;}
  .hud{
    position:fixed; left:12px; right:12px; top:12px; z-index:5;
    display:flex; gap:10px; flex-wrap:wrap; pointer-events:none;
  }
  .pill{
    pointer-events:auto; border:1px solid var(--ui2); background:rgba(0,0,0,.35);
    backdrop-filter: blur(8px);
    border-radius:999px; padding:10px 12px;
    font-size:11px; letter-spacing:.18em; text-transform:uppercase;
    display:flex; gap:10px; align-items:center;
  }
  .toast{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    border:1px solid var(--ui2); background:rgba(0,0,0,.55);
    border-radius:14px; padding:10px 12px;
    font-size:12px; letter-spacing:.08em; opacity:0; transition:.2s;
    max-width:min(720px, calc(100vw - 24px)); text-align:center;
    z-index:6;
  }
  .toast.on{opacity:1}
</style>
</head>
<body>
<div class="hud">
  <div class="pill"><b>SOPHIA</b> <span>KITCHEN</span></div>
  <div class="pill">DRUNK: <span id="drunk">NO</span></div>
  <div class="pill">PUKE: <span id="puke">NO</span></div>
  <div class="pill">LUCAS: <span id="lucasMood">OUT</span></div>
  <div class="pill">Door → Living Room (left)</div>
  <div class="pill">Interact: <b>E</b> · Dance toggle: <b>C</b> (on floor) · Run: <b>SHIFT</b></div>
</div>
<div class="toast" id="toast"></div>
<div class="wrap"><canvas id="c" width="320" height="180"></canvas></div>

<script>
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d',{alpha:false});
ctx.imageSmoothingEnabled=false;

const UI={
  drunk:document.getElementById('drunk'),
  puke:document.getElementById('puke'),
  lucasMood:document.getElementById('lucasMood'),
  toast:document.getElementById('toast')
};

const STORE_KEY="SOPHIA_AUDITION_SAVE_V1";
function loadState(){
  const r=localStorage.getItem(STORE_KEY);
  if(r){try{return JSON.parse(r);}catch(e){}}
  return {
    hasKeys:false, slept:false, trip:false, puke:false,
    poemLines:0, guitarPlayed:0,
    drunk:false, dancedMs:0,
    lucas:{state:"out", inKitchen:false, dancing:false},
    pets:{blackDog:false, orangeCat:false},
    sophia:{x:160,y:120},
    milo:{x:148,y:132}
  };
}
function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

let state=loadState();
state.lastRoom="KITCHEN";
state.lucas = state.lucas || {state:"out", inKitchen:false, dancing:false};
state.pets = state.pets || {blackDog:false, orangeCat:false};
if(typeof state.drunk!=="boolean") state.drunk=false;
if(typeof state.dancedMs!=="number") state.dancedMs=0;
saveState();

function syncHUD(){
  UI.puke.textContent = state.puke ? "YES" : "NO";
  UI.drunk.textContent = state.drunk ? "YES" : "NO";
  UI.lucasMood.textContent = state.lucas.inKitchen ? (state.lucas.dancing ? "DANCING" : "HERE") : "OUT";
}
syncHUD();

function toast(msg,ms=1500){
  UI.toast.textContent=msg;
  UI.toast.classList.add('on');
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>UI.toast.classList.remove('on'),ms);
}

/* input */
const keysDown=new Set();
addEventListener('keydown',(e)=>{
  const k=e.key.toLowerCase();
  if(["arrowup","arrowdown","arrowleft","arrowright"," ","shift","w","a","s","d","e","c"].includes(k)) e.preventDefault();
  keysDown.add(k);
});
addEventListener('keyup',(e)=>keysDown.delete(e.key.toLowerCase()));

/* world */
const W=canvas.width,H=canvas.height;
const solids=[
  [0,0,W,10],[0,0,10,H],[0,H-10,W,10],[W-10,0,10,H],
  // counter
  [40,62,240,22],
  // table
  [120,112,60,18],
  // fridge
  [240,34,44,46],
  // record shelf block (visual)
  [34,92,46,30],
];

const zones=[
  {name:"FRIDGE", rect:[244,38,36,38], action: eatGross},
  {name:"SINK", rect:[70,64,40,18], action: rinse},
  {name:"BLENDER", rect:[178,62,32,18], action: blendDrink},
  {name:"RECORD PLAYER", rect:[36,98,40,18], action: ()=>go("recordplayer.html")},
  {name:"TALK LUCAS", rect:[0,0,0,0], action: ()=>go("lucastalk.html"), dynamic:true},
  {name:"DISCO FLOOR", rect:[0,0,0,0], action: ()=>go("disco.html"), dynamic:true}, // only when drunk
  {name:"DOOR_LIVING", rect:[10,78,10,28], action: ()=>go("Sophie03.html")},
];

const sophia={x:state.sophia.x,y:state.sophia.y,w:10,h:12,speed:0.85,run:1.35};
const milo={x:state.milo.x,y:state.milo.y,w:8,h:8};

const lucas={
  x: 250, y: 120, w:10, h:12,
  tx: 250, ty: 120
};

const blackDog={x:210,y:130,w:10,h:10, show:false};
const orangeCat={x:120,y:132,w:8,h:8, show:false};

/* helpers */
function rectsOverlap(ax,ay,aw,ah,bx,by,bw,bh){
  return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by;
}
function collides(x,y,w,h){
  for(const s of solids){
    if(rectsOverlap(x,y,w,h,s[0],s[1],s[2],s[3])) return true;
  }
  return false;
}
function tryMove(ent,dx,dy){
  const nx=ent.x+dx, ny=ent.y+dy;
  if(!collides(nx,ent.y,ent.w,ent.h)) ent.x=nx;
  if(!collides(ent.x,ny,ent.w,ent.h)) ent.y=ny;
}

/* dance floor */
const floorRect = {x:86,y:134,w:148,h:32}; // appears when drunk
let dancing=false;

/* zones selection */
function nearestZone(){
  // dynamic zones
  const talk = zones.find(z=>z.name==="TALK LUCAS");
  if(state.lucas.inKitchen){
    talk.rect = [ (lucas.x-6)|0, (lucas.y-8)|0, 22, 22 ];
  }else talk.rect = [0,0,0,0];

  const disco = zones.find(z=>z.name==="DISCO FLOOR");
  if(state.drunk){
    disco.rect = [floorRect.x, floorRect.y, floorRect.w, floorRect.h];
  }else disco.rect = [0,0,0,0];

  const px=sophia.x+sophia.w/2, py=sophia.y+sophia.h/2;
  let best=null, bd=9999;
  for(const z of zones){
    const [x,y,w,h]=z.rect;
    if(!w || !h) continue;
    const cx=x+w/2, cy=y+h/2;
    const d=(cx-px)*(cx-px)+(cy-py)*(cy-py);
    if(d<bd && d<1350){ bd=d; best=z; }
  }
  return best;
}
function interact(){ const z=nearestZone(); if(z) z.action(); }

/* actions */
let pukeAnim=0;

function eatGross(){
  state.puke = true;
  saveState();
  syncHUD();
  pukeAnim=90;
  toast("Fridge opens. A smell from another timeline. You puke.", 1900);
}

function rinse(){
  if(!state.puke) return toast("She washes her hands. Milo nods politely.", 1400);
  state.puke=false;
  saveState();
  syncHUD();
  toast("Cold water. Reset button. You’re back.", 1600);
}

function blendDrink(){
  if(state.drunk) return toast("Blender already did its damage.", 1400);

  state.drunk = true;
  state.puke = false; // drinking “overwrites” the vibe
  state.lucas.inKitchen = true;
  state.lucas.state = "here";
  saveState();
  syncHUD();
  toast("You blend a daiquiri/margarita. Instant drunk. Lucas smells it and enters.", 2300);
}

/* navigation */
function go(file){
  state.sophia.x=sophia.x; state.sophia.y=sophia.y;
  state.milo.x=milo.x; state.milo.y=milo.y;
  saveState();
  location.href=file;
}

/* render helpers */
function drawRectBevel(x,y,w,h,fill){
  ctx.fillStyle=fill; ctx.fillRect(x,y,w,h);
  ctx.fillStyle="rgba(255,255,255,.08)"; ctx.fillRect(x,y,w,1);
  ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(x,y+h-1,w,1);
  ctx.fillStyle="rgba(255,255,255,.06)"; ctx.fillRect(x,y,1,h);
  ctx.fillStyle="rgba(0,0,0,.35)"; ctx.fillRect(x+w-1,y,1,h);
}
function drawHintBubble(text,x,y){
  const pad=3;
  ctx.font="8px ui-monospace, monospace";
  const m=ctx.measureText(text);
  const w=Math.ceil(m.width)+pad*2, h=12;
  ctx.fillStyle="rgba(0,0,0,.65)"; ctx.fillRect((x-w/2)|0,(y-h)|0,w,h);
  ctx.strokeStyle="rgba(255,255,255,.12)"; ctx.strokeRect((x-w/2+0.5)|0,(y-h+0.5)|0,w-1,h-1);
  ctx.fillStyle="rgba(255,255,255,.9)"; ctx.fillText(text,(x-w/2+pad)|0,(y-4)|0);
}

/* sprites */
function drawSophia(t){
  const x=Math.round(sophia.x), y=Math.round(sophia.y);
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(x-1,y+11,12,2);

  // wobble if dancing
  const wob = dancing ? Math.round(Math.sin(t*0.35)*1) : 0;

  ctx.fillStyle="#f2d27a"; ctx.fillRect(x+1+wob,y+0,8,4); ctx.fillRect(x+0+wob,y+3,10,3);
  ctx.fillStyle="#ffd9c9"; ctx.fillRect(x+2+wob,y+5,6,4);
  ctx.fillStyle="#67b7ff"; ctx.fillRect(x+3+wob,y+6,1,1); ctx.fillRect(x+6+wob,y+6,1,1);
  ctx.fillStyle="rgba(138,46,255,.55)"; ctx.fillRect(x+2+wob,y+9,6,3);
  ctx.fillStyle="rgba(255,255,255,.14)"; ctx.fillRect(x+3+wob,y+10,4,1);

  // little “tipsy” halo
  if(state.drunk && (t%22<11)){
    ctx.fillStyle="rgba(0,255,213,.10)";
    ctx.fillRect(x-2,y-2,14,1);
  }
}
function drawMilo(t){
  const x=Math.round(milo.x), y=Math.round(milo.y);
  const bop = (state.drunk && dancing) ? Math.round(Math.sin(t*0.4)*1) : 0;
  ctx.fillStyle="rgba(0,0,0,.40)"; ctx.fillRect(x-1,y+7,10,2);
  ctx.fillStyle="#d8d8d8"; ctx.fillRect(x+1,y+2+bop,6,5);
  ctx.fillStyle="#cfcfcf"; ctx.fillRect(x+1,y+1+bop,2,2); ctx.fillRect(x+5,y+1+bop,2,2);
  ctx.fillStyle="#1affd3"; ctx.fillRect(x+2,y+4+bop,1,1); ctx.fillRect(x+5,y+4+bop,1,1);
  ctx.fillStyle="#cfcfcf"; ctx.fillRect(x+7,y+3+bop,1,3);
}
function drawLucas(t){
  if(!state.lucas.inKitchen) return;
  const x=Math.round(lucas.x), y=Math.round(lucas.y);
  const bop = (state.drunk && dancing) ? Math.round(Math.sin(t*0.33)*1) : 0;

  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(x-1,y+11,12,2);

  // hair brown
  ctx.fillStyle="rgba(120,70,40,.45)"; ctx.fillRect(x+1,y+0+bop,8,4);
  // face
  ctx.fillStyle="rgba(255,217,201,.95)"; ctx.fillRect(x+2,y+4+bop,6,4);
  // hoodie
  ctx.fillStyle="rgba(0,255,213,.10)"; ctx.fillRect(x+1,y+7+bop,8,6);

  // tiny cup blink
  if(state.drunk && (t%18<9)){
    ctx.fillStyle="rgba(255,255,255,.12)";
    ctx.fillRect(x+9,y+9+bop,2,2);
  }
}
function drawBlackDog(t){
  if(!blackDog.show) return;
  const x=Math.round(blackDog.x), y=Math.round(blackDog.y);
  const bop = (dancing) ? Math.round(Math.sin(t*0.28)*1) : 0;
  ctx.fillStyle="rgba(0,0,0,.40)"; ctx.fillRect(x-1,y+9,12,2);
  ctx.fillStyle="rgba(0,0,0,.75)"; ctx.fillRect(x+1,y+3+bop,8,6);
  ctx.fillStyle="rgba(255,255,255,.06)"; ctx.fillRect(x+2,y+4+bop,1,1);
  ctx.fillRect(x+6,y+4+bop,1,1);
}
function drawOrangeCat(t){
  if(!orangeCat.show) return;
  const x=Math.round(orangeCat.x), y=Math.round(orangeCat.y);
  const bop = (dancing) ? Math.round(Math.sin(t*0.36)*1) : 0;
  ctx.fillStyle="rgba(0,0,0,.40)"; ctx.fillRect(x-1,y+7,10,2);
  ctx.fillStyle="rgba(255,140,40,.55)"; ctx.fillRect(x+1,y+2+bop,6,5);
  ctx.fillStyle="rgba(255,200,120,.30)"; ctx.fillRect(x+1,y+1+bop,2,2); ctx.fillRect(x+5,y+1+bop,2,2);
  ctx.fillStyle="rgba(0,0,0,.10)"; ctx.fillRect(x+2,y+4+bop,1,1); ctx.fillRect(x+5,y+4+bop,1,1);
}

/* kitchen world */
function drawWorld(t){
  ctx.fillStyle="#05050a"; ctx.fillRect(0,0,W,H);

  // cool kitchen light
  const g=ctx.createRadialGradient(250,40,8,250,40,150);
  g.addColorStop(0,"rgba(255,255,255,.10)");
  g.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  // walls/floor
  ctx.fillStyle="rgba(255,255,255,.06)"; ctx.fillRect(10,10,W-20,78);
  for(let y=92;y<H-10;y++){
    ctx.fillStyle=`rgba(255,255,255,${(y%6===0)?0.10:0.05})`;
    ctx.fillRect(10,y,W-20,1);
  }

  // counter + sink
  drawRectBevel(40,62,240,22,"rgba(255,255,255,.05)");
  drawRectBevel(70,64,40,18,"rgba(0,0,0,.28)");
  ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(76,70,28,6);

  // blender (on counter)
  drawRectBevel(178,62,32,18,"rgba(255,255,255,.04)");
  ctx.fillStyle="rgba(138,46,255,.14)"; ctx.fillRect(182,66,24,10);
  if(!state.drunk && (t%20<10)){
    ctx.fillStyle="rgba(0,255,213,.10)";
    ctx.fillRect(190,64,8,2);
  }

  // table
  drawRectBevel(120,112,60,18,"rgba(255,255,255,.05)");

  // record player zone (left)
  drawRectBevel(34,92,46,30,"rgba(255,255,255,.04)");
  drawRectBevel(36,98,40,18,"rgba(0,0,0,.28)");
  ctx.fillStyle="rgba(255,255,255,.08)"; ctx.fillRect(40,102,10,10); // platter hint
  ctx.fillStyle="rgba(0,255,213,.08)"; ctx.fillRect(52,106,18,2);  // arm hint

  // fridge
  drawRectBevel(240,34,44,46,"rgba(255,255,255,.06)");
  ctx.fillStyle="rgba(0,0,0,.45)"; ctx.fillRect(244,38,36,38);
  ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(279,40,2,34);

  // door back left
  ctx.fillStyle="rgba(255,255,255,.10)"; ctx.fillRect(10,78,10,28);

  // dance floor (appears only when drunk)
  if(state.drunk){
    // subtle focus wash
    ctx.fillStyle="rgba(0,0,0,.16)";
    ctx.fillRect(0,0,W,H);

    // disco tiles
    const fx=floorRect.x, fy=floorRect.y, fw=floorRect.w, fh=floorRect.h;
    drawRectBevel(fx,fy,fw,fh,"rgba(255,255,255,.04)");
    const tile=10;
    for(let y=fy+2;y<fy+fh-2;y+=tile){
      for(let x=fx+2;x<fx+fw-2;x+=tile){
        const s = Math.sin((t*0.14)+(x*0.07)+(y*0.09));
        const a = 0.05 + 0.10*(0.5+0.5*s);
        const c1 = `rgba(138,46,255,${a})`;
        const c2 = `rgba(0,255,213,${a*0.9})`;
        ctx.fillStyle = ((x+y)/tile)%2===0 ? c1 : c2;
        ctx.fillRect(x,y,tile-1,tile-1);
      }
    }
    // little “E to disco.html” hint pixel in corner
    ctx.fillStyle="rgba(255,255,255,.10)";
    ctx.fillRect(fx+fw-10, fy+4, 4, 4);
  }

  // puke overlay
  if(pukeAnim>0){
    ctx.fillStyle=`rgba(0,255,213,${0.06 + 0.06*Math.sin(pukeAnim*0.25)})`;
    ctx.fillRect(0,0,W,H);
    pukeAnim--;
  }

  // drunk shader
  if(state.drunk){
    ctx.fillStyle=`rgba(255,99,255,${0.08 + 0.05*Math.sin(t*0.09)})`;
    ctx.fillRect(0,0,W,H);
    for(let y=0;y<H;y+=3){
      ctx.fillStyle=`rgba(0,255,213,${0.02 + 0.02*Math.sin(t*0.12 + y*0.2)})`;
      ctx.fillRect(0,y,W,1);
    }
  }

  const z=nearestZone();
  if(z) drawHintBubble(z.name, sophia.x+6, sophia.y-10);
}

/* logic: dance + party spawns */
function onDanceFloor(){
  const px=sophia.x+sophia.w/2, py=sophia.y+sophia.h/2;
  return (px>floorRect.x && px<floorRect.x+floorRect.w && py>floorRect.y && py<floorRect.y+floorRect.h);
}

/* loop */
let t=0;
let lastMs=performance.now();
function loop(now){
  t++;

  const dt = Math.min(50, (now-lastMs)||16);
  lastMs = now;

  // movement
  const run=keysDown.has("shift");
  const sp=sophia.speed*(run?sophia.run:1);

  let dx=0,dy=0;
  if(keysDown.has("w")||keysDown.has("arrowup")) dy-=sp;
  if(keysDown.has("s")||keysDown.has("arrowdown")) dy+=sp;
  if(keysDown.has("a")||keysDown.has("arrowleft")) dx-=sp;
  if(keysDown.has("d")||keysDown.has("arrowright")) dx+=sp;
  if(dx&&dy){dx*=0.72; dy*=0.72;}
  if(dx||dy) tryMove(sophia,dx,dy);

  // Milo follow (or “dance hop” when dancing on floor)
  if(state.drunk && dancing && onDanceFloor()){
    const ox = sophia.x + 12 + Math.sin(t*0.06)*6;
    const oy = sophia.y + 6 + Math.cos(t*0.07)*4;
    milo.x += (ox - milo.x)*0.09;
    milo.y += (oy - milo.y)*0.09;
  }else{
    const tx=sophia.x-10, ty=sophia.y+6;
    milo.x += (tx-milo.x)*0.06;
    milo.y += (ty-milo.y)*0.06;
  }

  // Lucas behavior (appears after blending)
  if(state.lucas.inKitchen){
    if(state.drunk && dancing && onDanceFloor()){
      state.lucas.dancing = true;
      // move lucas onto floor near Sophia
      lucas.tx = sophia.x - 16;
      lucas.ty = sophia.y + 6;
    }else{
      state.lucas.dancing = false;
      // hang near table
      lucas.tx = 152;
      lucas.ty = 122;
    }
    lucas.x += (lucas.tx - lucas.x)*0.08;
    lucas.y += (lucas.ty - lucas.y)*0.08;
  }else{
    lucas.x = 250; lucas.y = 120;
  }

  // Dance toggle: only when drunk + on dance floor
  if(keysDown.has("c")){
    if(!loop._cWasDown){
      if(state.drunk && onDanceFloor()){
        dancing = !dancing;
        toast(dancing ? "You start dancing. The kitchen decides to become a club." : "You stop dancing. The tiles dim.", 1700);
      }else{
        toast("You feel like dancing… but the floor isn’t alive yet.", 1400);
      }
    }
    loop._cWasDown=true;
  } else loop._cWasDown=false;

  // Count dance time to spawn pets
  if(state.drunk && dancing && onDanceFloor()){
    state.dancedMs += dt;
    if(state.dancedMs > 5200 && !blackDog.show){
      blackDog.show = true;
      toast("A black dog appears like it was invited by the beat.", 1900);
    }
    if(state.dancedMs > 9200 && !orangeCat.show){
      orangeCat.show = true;
      toast("An orange cat pops in. The party now has lore.", 1900);
    }
  }

  // interact (E)
  if(keysDown.has("e")){
    if(!loop._eWasDown) interact();
    loop._eWasDown=true;
  } else loop._eWasDown=false;

  // persist state sometimes
  if(t%60===0){
    state.sophia.x=sophia.x; state.sophia.y=sophia.y;
    state.milo.x=milo.x; state.milo.y=milo.y;
    state.pets.blackDog = blackDog.show;
    state.pets.orangeCat = orangeCat.show;
    saveState();
    syncHUD();
  }

  // draw
  drawWorld(t);
  drawBlackDog(t);
  drawOrangeCat(t);
  drawMilo(t);
  drawLucas(t);
  drawSophia(t);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
