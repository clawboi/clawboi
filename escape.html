<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ESCAPE PSYCHWARD</title>

<style>
:root{
  --bg:#000;
  --fg:#eaeaea;
  --accent:#8a2eff;
  --red:#ff5c5c;
  --green:#8affc1;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  overflow:hidden;
  position:relative;
}

/* violet fog */
body:before{
  content:"";
  position:fixed;
  inset:-25%;
  pointer-events:none;
  background:
    radial-gradient(circle at 18% 22%, rgba(138,46,255,.22), transparent 60%),
    radial-gradient(circle at 78% 34%, rgba(138,46,255,.14), transparent 70%),
    radial-gradient(circle at 50% 86%, rgba(138,46,255,.10), transparent 72%);
  mix-blend-mode:screen;
  filter:blur(42px) saturate(1.15);
  opacity:.95;
}

/* scanlines */
.scan{
  position:fixed; inset:0;
  pointer-events:none;
  opacity:.08;
  mix-blend-mode:overlay;
  background:repeating-linear-gradient(to bottom, rgba(255,255,255,.06) 0px, rgba(255,255,255,.06) 1px, transparent 3px, transparent 6px);
}

/* top nav */
.top{
  position:fixed;
  left:14px; right:14px; top:14px;
  display:flex;
  justify-content:space-between;
  gap:12px;
  z-index:9;
}
.brand{
  font-size:11px;
  letter-spacing:.34em;
  text-transform:uppercase;
  opacity:.78;
  text-shadow:0 0 18px rgba(138,46,255,.25);
}
.brand a{color:#fff;text-decoration:none}
.brand:hover{opacity:1}
.navRight{
  display:flex;
  gap:10px;
  align-items:center;
}
.pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:10px 12px;
  border-radius:999px;
  letter-spacing:.22em;
  font-size:10px;
  text-transform:uppercase;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  color:#fff;
  text-decoration:none;
  cursor:pointer;
}
.pill:hover{filter:brightness(1.08)}
.pill.v{border-color:rgba(138,46,255,.45); background:rgba(138,46,255,.12)}

/* main frame */
.game{
  width:min(920px, 92vw);
  border:2px solid rgba(138,46,255,.55);
  border-radius:18px;
  padding:18px;
  box-shadow:0 0 40px rgba(138,46,255,.22);
  background:rgba(0,0,0,.65);
  backdrop-filter: blur(10px);
  position:relative;
  z-index:2;
}

/* header title */
.title{
  text-align:center;
  letter-spacing:.46em;
  text-transform:uppercase;
  color:#fff;
  text-shadow:0 0 18px rgba(138,46,255,.40);
  font-size:clamp(16px, 3.4vw, 30px);
}
.sub{
  margin-top:8px;
  text-align:center;
  font-size:11px;
  letter-spacing:.30em;
  text-transform:uppercase;
  opacity:.62;
}

/* status HUD */
.hud{
  margin-top:14px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
}
.badge{
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.03);
  font-size:10px;
  letter-spacing:.22em;
  text-transform:uppercase;
  opacity:.85;
}
.badge b{opacity:.95}
.badge.v{border-color:rgba(138,46,255,.35); background:rgba(138,46,255,.08)}
.badge.r{border-color:rgba(255,92,92,.35); background:rgba(255,92,92,.06)}
.badge.g{border-color:rgba(138,255,193,.25); background:rgba(138,255,193,.05)}

/* story text */
.text{
  margin-top:16px;
  min-height:170px;
  line-height:1.7;
  white-space:pre-line;
  font-size:12px;
  border-radius:14px;
  padding:14px;
  border:1px solid rgba(255,255,255,.06);
  background:rgba(0,0,0,.70);
  position:relative;
}

/* little “typing” cursor */
.cursor{
  display:inline-block;
  width:10px;
  opacity:.45;
  animation:blink 1.05s steps(2,end) infinite;
}
@keyframes blink{50%{opacity:.15}}

/* choices */
.choices{
  margin-top:14px;
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}
@media(min-width:720px){
  .choices{grid-template-columns:1fr 1fr}
}
button{
  background:#070707;
  color:#fff;
  border:1px solid rgba(138,46,255,.55);
  padding:12px 12px;
  cursor:pointer;
  font-family:inherit;
  letter-spacing:.18em;
  text-transform:uppercase;
  font-size:11px;
  border-radius:14px;
}
button:hover{background:rgba(138,46,255,.18); filter:brightness(1.05)}
button:active{transform:translateY(1px)}
button.danger{border-color:rgba(255,92,92,.55)}
button.danger:hover{background:rgba(255,92,92,.10)}
button.safe{border-color:rgba(138,255,193,.35)}
button.safe:hover{background:rgba(138,255,193,.08)}

/* name input */
.inputRow{
  margin-top:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
}
input{
  width:min(360px, 100%);
  padding:12px 12px;
  background:#000;
  border:1px solid rgba(138,46,255,.55);
  color:#fff;
  font-family:inherit;
  text-align:center;
  letter-spacing:.22em;
  border-radius:14px;
}
small.hint{
  display:block;
  margin-top:10px;
  text-align:center;
  font-size:10px;
  letter-spacing:.30em;
  text-transform:uppercase;
  opacity:.50;
}

/* endings */
.dead{color:var(--red)}
.win{color:var(--green)}

/* optional audio */
.audioRow{
  margin-top:14px;
  display:flex;
  gap:10px;
  justify-content:center;
  flex-wrap:wrap;
}
.note{
  margin-top:10px;
  font-size:10px;
  letter-spacing:.30em;
  text-transform:uppercase;
  opacity:.48;
  text-align:center;
}

/* tiny glitch shimmer */
@keyframes shimmer{
  0%,100%{filter:contrast(1) hue-rotate(0deg)}
  50%{filter:contrast(1.22) hue-rotate(10deg)}
}
.shimmer{animation:shimmer 2.6s steps(2,end) infinite}

/* help modal */
.helpMask{
  position:fixed; inset:0;
  background:rgba(0,0,0,.72);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99;
}
.helpMask.open{display:flex}
.helpBox{
  width:min(720px, 92vw);
  border:1px solid rgba(138,46,255,.55);
  border-radius:16px;
  background:rgba(0,0,0,.82);
  box-shadow:0 0 50px rgba(138,46,255,.22);
  padding:16px;
}
.helpTitle{
  letter-spacing:.34em;
  text-transform:uppercase;
  opacity:.92;
}
.helpBody{
  margin-top:10px;
  font-size:12px;
  line-height:1.8;
  opacity:.86;
  white-space:pre-line;
}
.helpActions{
  margin-top:14px;
  display:flex;
  gap:10px;
  justify-content:flex-end;
  flex-wrap:wrap;
}

/* reduced motion */
@media (prefers-reduced-motion: reduce){
  body:before{animation:none!important}
  .cursor{animation:none!important}
  .shimmer{animation:none!important}
}
</style>
</head>
<body>
<div class="scan"></div>

<div class="top">
  <div class="brand"><a href="index.html">CLAWBOI</a></div>
  <div class="navRight">
    <button class="pill" id="helpBtn" type="button" title="Help">HELP (H)</button>
    <button class="pill" id="sfxBtn" type="button" title="Toggle SFX">SFX: ON</button>
    <a class="pill" href="games.html">RETURN TO GAMES</a>
  </div>
</div>

<div class="game">
  <div class="title">ESCAPE PSYCHWARD</div>
  <div class="sub">THREE DOORS. ONE MIND. ABSOLUTELY NO CUSTOMER SUPPORT. <span class="cursor">▮</span></div>

  <div class="hud">
    <div class="badge v">PATIENT: <b id="hudName">UNKNOWN</b></div>
    <div class="badge">STABILITY: <b id="hudStab">05</b></div>
    <div class="badge r">HEAT: <b id="hudHeat">00</b></div>
    <div class="badge g">KEYS: <b id="hudKeys">0</b></div>
    <div class="badge">LOOP: <b id="hudLoop">00</b></div>
    <div class="badge v">POCKET: <b id="hudInv">EMPTY</b></div>
  </div>

  <div id="text" class="text"></div>
  <div id="choices" class="choices"></div>

  <div class="audioRow">
    <button class="pill v" id="playSong" type="button">PLAY SONG</button>
    <button class="pill" id="stopSong" type="button">STOP</button>
    <audio id="song" preload="auto">
      <!-- put your track here -->
      <source src="audio/psychward.mp3?v=1" type="audio/mpeg">
    </audio>
  </div>
  <div class="note">PUT YOUR FILE AT <span class="shimmer">/audio/psychward.mp3</span> OR CHANGE THE SRC ABOVE.</div>
  <small class="hint">TIP: PRESS 1-4 TO PICK A CHOICE. PRESS H FOR HELP. YOUR BRAIN IS THE MAP.</small>
</div>

<!-- HELP MODAL -->
<div class="helpMask" id="helpMask" aria-hidden="true">
  <div class="helpBox">
    <div class="helpTitle">HELP / QUICK RULES</div>
    <div class="helpBody" id="helpBody"></div>
    <div class="helpActions">
      <button class="pill v" id="closeHelp" type="button">CLOSE</button>
    </div>
  </div>
</div>

<script>
/* =========================
   ESCAPE PSYCHWARD (upgraded)
   - still deterministic (no RNG death)
   - clearer/funnier text + extra branches
   - REAL loop pressure (but always winnable)
   - quality-of-life: SFX, help, autosave
   - no “bad choice reveal” or % survival talk
========================= */

const elText = document.getElementById("text");
const elChoices = document.getElementById("choices");
const hudName = document.getElementById("hudName");
const hudStab = document.getElementById("hudStab");
const hudHeat = document.getElementById("hudHeat");
const hudKeys = document.getElementById("hudKeys");
const hudLoop = document.getElementById("hudLoop");
const hudInv  = document.getElementById("hudInv");

/* audio (song) */
const song = document.getElementById("song");
document.getElementById("playSong").onclick = async ()=>{
  try{ await song.play(); }catch(e){}
};
document.getElementById("stopSong").onclick = ()=>{
  song.pause(); song.currentTime = 0;
};

/* SFX (tiny, tasteful) */
let SFX_ON = true;
let AC = null;
function ensureAC(){
  if(AC) return AC;
  const Ctx = window.AudioContext || window.webkitAudioContext;
  if(!Ctx) return null;
  AC = new Ctx();
  return AC;
}
function beep(freq=440, dur=0.06, type="sine", vol=0.03){
  if(!SFX_ON) return;
  const ac = ensureAC();
  if(!ac) return;
  const t0 = ac.currentTime;
  const o = ac.createOscillator();
  const g = ac.createGain();
  o.type = type;
  o.frequency.setValueAtTime(freq, t0);
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(vol, t0+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
  o.connect(g); g.connect(ac.destination);
  o.start(t0);
  o.stop(t0+dur+0.02);
}
function clickSFX(kind="ok"){
  if(kind==="ok"){ beep(720, 0.05, "triangle", 0.03); beep(980, 0.05, "triangle", 0.018); }
  else if(kind==="bad"){ beep(220, 0.07, "sawtooth", 0.028); }
  else if(kind==="ui"){ beep(520, 0.04, "square", 0.018); }
}
function whoosh(){
  if(!SFX_ON) return;
  const ac = ensureAC();
  if(!ac) return;
  const t0 = ac.currentTime;
  const n = ac.createBuffer(1, Math.floor(ac.sampleRate*0.14), ac.sampleRate);
  const d = n.getChannelData(0);
  for(let i=0;i<d.length;i++){
    const t = i/d.length;
    d[i] = (Math.random()*2-1) * (1-t) * 0.35;
  }
  const src = ac.createBufferSource();
  const f = ac.createBiquadFilter();
  const g = ac.createGain();
  src.buffer = n;
  f.type = "highpass"; f.frequency.value = 650;
  g.gain.value = 0.06;
  src.connect(f); f.connect(g); g.connect(ac.destination);
  src.start(t0);
}

/* HELP */
const helpMask = document.getElementById("helpMask");
const helpBody = document.getElementById("helpBody");
const helpBtn  = document.getElementById("helpBtn");
const closeHelp= document.getElementById("closeHelp");
function openHelp(){
  clickSFX("ui");
  helpBody.textContent =
`CONTROLS
- CLICK BUTTONS OR PRESS 1-4 TO CHOOSE.
- PRESS H TO TOGGLE THIS HELP.
- SFX BUTTON TO TURN CLICK/BEEP SOUNDS ON/OFF.
- YOUR MUSIC BUTTONS ARE BELOW. (I'M NOT YOUR DJ THOUGH.)

HUD MEANINGS
- STABILITY: YOUR BRAIN’S GRIP ON REALITY (0 = NOPE).
- HEAT: HOW MUCH SECURITY CARES ABOUT YOU (9 = THEY CARE TOO MUCH).
- KEYS: LITERAL KEYS. (WILD CONCEPT.)
- LOOP: HOW MANY TIMES YOU’VE “BACKED OUT” AND PACED.
  LOOP DOES NOT KILL YOU BY ITSELF. IT JUST MAKES THE WARD NOTICE YOU MORE.

IMPORTANT VIBE RULE
- THIS GAME IS DETERMINISTIC.
  IF YOU DIE, IT’S BECAUSE YOU CHOSE A THING THAT ALWAYS LEADS THERE.
  NO RANDOM “LOL YOU LOSE” ENERGY.

TIP
- IF HEAT IS HIGH, BE BORING.
- IF STABILITY IS LOW, DON’T DO GLASS-BASED HOBBIES.`;
  helpMask.classList.add("open");
  helpMask.setAttribute("aria-hidden","false");
}
function closeHelpNow(){
  clickSFX("ui");
  helpMask.classList.remove("open");
  helpMask.setAttribute("aria-hidden","true");
}
helpBtn.onclick = ()=> helpMask.classList.contains("open") ? closeHelpNow() : openHelp();
closeHelp.onclick = closeHelpNow;
helpMask.addEventListener("click",(e)=>{ if(e.target===helpMask) closeHelpNow(); });

/* SFX toggle */
const sfxBtn = document.getElementById("sfxBtn");
function updateSfxBtn(){ sfxBtn.textContent = `SFX: ${SFX_ON ? "ON" : "OFF"}`; }
sfxBtn.onclick = async ()=>{
  // resume audio context on first click (browser policy)
  try{ const ac = ensureAC(); await ac?.resume?.(); }catch(e){}
  SFX_ON = !SFX_ON;
  updateSfxBtn();
  clickSFX("ui");
};
updateSfxBtn();

/* =========================
   SAVE / LOAD (tiny autosave)
========================= */
const SAVE_KEY = "escape_psychward_save_v2";
function safeCloneState(){
  return {
    name:S.name,
    stability:S.stability,
    heat:S.heat,
    keys:S.keys,
    loop:S.loop,
    inv:Array.from(S.inv),
    flags: {...S.flags},
    scene:S.scene,
    last:S.last
  };
}
function save(){
  try{ localStorage.setItem(SAVE_KEY, JSON.stringify(safeCloneState())); }catch(e){}
}
function load(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return false;
    const o = JSON.parse(raw);
    if(!o || typeof o !== "object") return false;
    S.name = o.name || "";
    S.stability = (o.stability ?? 5);
    S.heat = (o.heat ?? 0);
    S.keys = (o.keys ?? 0);
    S.loop = (o.loop ?? 0);
    S.inv = new Set(Array.isArray(o.inv) ? o.inv : []);
    S.flags = {...S.flags, ...(o.flags||{})};
    S.scene = o.scene || "";
    S.last = o.last || "";
    return true;
  }catch(e){ return false; }
}

/* =========================
   STATE
========================= */
const S = {
  name:"",
  stability:5, // 0..9
  heat:0,      // 0..9
  keys:0,      // 0..3
  loop:0,
  inv: new Set(), // paperclip, shard, badge, map, tape, pills, dust
  flags: {
    tookPills:false,
    hidPills:false,
    befriended:false,
    lied:false,
    confessed:false,
    listened:false,
    camerasOff:false,
    nurseTrust:false,
    doorCode:false,
    vents:false,
    heardIntercom:false,
    knowsRoutes:false,
    pocketLintLegend:false
  },
  scene:"",
  last:""
};

function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

function invPretty(){
  const arr = Array.from(S.inv);
  if(!arr.length) return "EMPTY";
  // keep it short for HUD, but readable
  const nice = arr.map(x=>x.toUpperCase().replace(/_/g," "));
  return nice.slice(0,3).join(" + ") + (nice.length>3 ? ` +${nice.length-3}` : "");
}

function updateHUD(){
  hudName.textContent = (S.name || "UNKNOWN").toUpperCase();
  hudStab.textContent = String(clamp(S.stability,0,9)).padStart(2,"0");
  hudHeat.textContent = String(clamp(S.heat,0,9)).padStart(2,"0");
  hudKeys.textContent = String(S.keys);
  hudLoop.textContent = String(S.loop).padStart(2,"0");
  hudInv.textContent  = invPretty();
}

function say(text, options=[]){
  elText.innerHTML = text;
  elChoices.innerHTML = "";
  options.forEach((o, idx)=>{
    const b = document.createElement("button");
    b.textContent = o.label;
    if(o.kind==="danger") b.classList.add("danger");
    if(o.kind==="safe") b.classList.add("safe");

    // hover micro-sfx
    b.addEventListener("mouseenter", ()=> clickSFX("ui"), {passive:true});

    b.onclick = ()=>{
      // resume AC on first user gesture
      try{ ensureAC()?.resume?.(); }catch(e){}
      clickSFX(o.kind==="danger" ? "bad" : "ok");
      o.action?.();
      save();
    };
    b.dataset.idx = String(idx+1);
    elChoices.appendChild(b);
  });
  updateHUD();
  save();
}

/* small “typewriter” flavor (fast, not annoying) */
function typeScene(lines, after){
  const chunks = Array.isArray(lines) ? lines : String(lines).split("\n");
  let i=0;
  elText.innerHTML = "";
  function step(){
    if(i >= chunks.length){ after?.(); return; }
    elText.innerHTML += (i? "\n":"") + chunks[i];
    // tiny tick
    if(SFX_ON && (i%2===0)) beep(980, 0.02, "triangle", 0.012);
    i++;
    setTimeout(step, 105);
  }
  step();
}

/* =========================
   CORE HELPERS
========================= */
function addHeat(n=1){
  S.heat = clamp(S.heat + n, 0, 9);
}
function addStability(n=1){
  S.stability = clamp(S.stability + n, 0, 9);
}
function take(item){
  S.inv.add(item);
}
function has(item){ return S.inv.has(item); }

/* Loop pressure that makes it longer (more scenes) and harder (more Heat),
   but still possible. No surprise deaths purely from looping. */
function bumpLoop(reason=""){
  S.loop = clamp(S.loop + 1, 0, 99);

  // soft pressure: every 2 loops, +1 heat (cap)
  if(S.loop>0 && S.loop % 2 === 0){
    addHeat(1);
  }

  // narrative flavor, no “bad choice reveal”
  if(reason && S.loop % 3 === 0){
    S.last = reason;
  }
}

/* deterministic ending */
function death(reason, extra=""){
  whoosh();
  say(
`<span class="dead">YOU GOT CAUGHT.</span>

${reason}
${extra ? "\n\n"+extra : ""}

<span class="cursor">▮</span>`,
  [
    {label:"TRY AGAIN", kind:"safe", action:()=>{ localStorage.removeItem(SAVE_KEY); location.reload(); }},
    {label:"RETURN TO GAMES", action:()=>{ window.location.href="games.html"; }}
  ]);
}

function win(text){
  whoosh();
  say(
`<span class="win">ESCAPE SUCCESSFUL</span>

${text}

<span class="cursor">▮</span>`,
  [
    {label:"PLAY AGAIN", kind:"safe", action:()=>{ localStorage.removeItem(SAVE_KEY); location.reload(); }},
    {label:"RETURN TO GAMES", action:()=>{ window.location.href="games.html"; }}
  ]);
}

/* “soft reset” option for people who want to keep name but restart */
function restartKeepName(){
  const nm = S.name;
  localStorage.removeItem(SAVE_KEY);
  boot(true, nm);
}

/* =========================
   START
========================= */
boot(false);

function boot(fromRestart=false, keepName=""){
  // offer continue if save exists and not a restart
  if(!fromRestart && load() && S.name){
    // show continue screen
    return say(
`WELCOME BACK, ${S.name.toUpperCase()}.

LAST KNOWN STATUS:
- STABILITY: ${String(S.stability).padStart(2,"0")}
- HEAT: ${String(S.heat).padStart(2,"0")}
- KEYS: ${S.keys}
- LOOP: ${String(S.loop).padStart(2,"0")}
- POCKET: ${invPretty()}

CONTINUE WHERE YOU LEFT OFF?
<span class="cursor">▮</span>`,
    [
      {label:"CONTINUE", kind:"safe", action:()=>{ routeResume(); }},
      {label:"RESTART (KEEP NAME)", action:()=>restartKeepName()},
      {label:"FULL RESET", kind:"danger", action:()=>{ localStorage.removeItem(SAVE_KEY); location.reload(); }}
    ]);
  }

  // fresh start
  S.scene = "";
  S.loop = 0;
  S.stability = 5; S.heat = 0; S.keys = 0;
  S.inv = new Set();
  S.flags = {
    tookPills:false, hidPills:false, befriended:false, lied:false,
    confessed:false, listened:false, camerasOff:false, nurseTrust:false,
    doorCode:false, vents:false, heardIntercom:false, knowsRoutes:false,
    pocketLintLegend:false
  };
  S.last = "";
  S.name = keepName || "";

  if(keepName){
    updateHUD();
    return intro();
  }

  say(
`ENTER PATIENT NAME:
(YES, IT MATTERS. NO, YOU CAN’T PUT “AAAAA” AND EXPECT RESPECT.)
<span class="cursor">▮</span>`,
  []);
  // input row
  const wrap = document.createElement("div");
  wrap.className="inputRow";
  wrap.innerHTML = `
    <input id="nameInput" placeholder="NAME" autocomplete="off" />
    <button class="safe" id="confirmBtn" type="button">CONFIRM</button>
  `;
  elChoices.appendChild(wrap);

  const inp = document.getElementById("nameInput");
  const btn = document.getElementById("confirmBtn");
  const go = ()=>{
    const v = (inp.value||"").trim();
    if(!v) return;
    S.name = v.slice(0,18);
    updateHUD();
    intro();
  };
  btn.onclick = go;
  inp.addEventListener("keydown",(e)=>{ if(e.key==="Enter") go(); });
  setTimeout(()=>inp.focus(), 90);
}

/* resume router (keeps it simple: if a scene exists, route; else intro) */
function routeResume(){
  // if they were in an ending, just intro
  const sc = S.scene || "";
  const map = {
    "intro": intro,
    "hallway": hallway,
    "staffDoor": staffDoor,
    "vent": vent,
    "humRoom": humRoom
  };
  (map[sc] || intro)();
}

/* =========================
   INTRO
========================= */
function intro(){
  S.scene = "intro";
  typeScene([
`${S.name}, YOU WAKE UP IN A HOSPITAL BED.`,
`THE CEILING HUMS LIKE A FRIDGE FULL OF BEES.`,
`YOUR WRISTS ACHE. NOT BLEEDING. WORSE: REMEMBERING.`,
`A NURSE ENTERS WITH A CUP: WHITE PILLS + WATER.`,
`SHE SMILES LIKE IT’S IN HER JOB DESCRIPTION.`,
``,
`DO YOU TAKE THEM?`
  ], ()=>{
    say(elText.innerHTML, [
      {label:"TAKE PILLS (CALM MODE)", kind:"safe", action:takePills},
      {label:"REFUSE (SPICY)", kind:"danger", action:refusePills},
      {label:"HIDE PILLS (SLEIGHT OF HAND)", action:hidePills}
    ]);
  });
}

function takePills(){
  S.flags.tookPills = true;
  addStability(2);
  addHeat(1); // they note compliance
  say(
`THE PILLS GO DOWN.
YOUR CHEST UNCLENCHES.
THE ROOM GETS QUIETER. TOO QUIET. LIKE SOMEONE MUTED LIFE.

THE NURSE: “GOOD.”

A SOFT CLICK FROM THE HALL. A DOOR UNLOCKING.
THAT CLICK FEELS LIKE A TIMER STARTING.

<span class="cursor">▮</span>`,
  [
    {label:"MOVE NOW", kind:"safe", action:hallway},
    {label:"ASK HER A QUESTION", action:questionNurse},
    {label:"WAIT (PLAY NICE)", action:waitNice}
  ]);
}

function refusePills(){
  S.flags.lied = true;
  addHeat(2);
  addStability(-1);
  say(
`“NO.”

THE NURSE’S SMILE DOESN’T MOVE.
SHE WRITES ONE WORD ON HER CLIPBOARD:
“NONCOMPLIANT.”

THE AIR FEELS THINNER.
LIKE OXYGEN GOT A NEW POLICY.

<span class="cursor">▮</span>`,
  [
    {label:"APOLOGIZE (FAKE IT)", action:fakeIt},
    {label:"DOUBLE DOWN (DON’T)", kind:"danger", action:doubleDown},
    {label:"SEARCH THE ROOM", action:searchRoom}
  ]);
}

function hidePills(){
  S.flags.hidPills = true;
  addHeat(1);
  say(
`YOU PALM THE PILLS.
YOUR HAND IS A LITTLE BANK VAULT.

THE NURSE LOOKS AT YOUR FINGERTIPS FOR ONE EXTRA SECOND.
THE EXACT LENGTH OF A HUMAN LIE.

<span class="cursor">▮</span>`,
  [
    {label:"SWALLOW THEM (NOW)", action:takePills},
    {label:"POCKET THEM", action:keepPills},
    {label:"DROP THEM UNDER THE BED", kind:"danger", action:dropPills}
  ]);
}

function questionNurse(){
  const options = [
    {label:"“WHAT DAY IS IT?”", action: ()=>{ S.flags.listened=true; nurseDay(); } },
    {label:"“WHAT IS THIS PLACE?”", action: ()=>{ addHeat(1); nursePlace(); } },
    {label:"“WHAT’S IN THOSE PILLS?”", action: ()=>{ addHeat(1); nursePills(); } }
  ];
  say(`YOU SPEAK SOFT.\nSHE LISTENS WITH HER EYES.\n\nASK WHAT?`, options);
}
function nurseDay(){
  addStability(1);
  say(
`“IT’S THURSDAY,” SHE SAYS.
“BUT THAT DOESN’T HELP YOU.”

SHE TAPS YOUR WRISTBAND.
A TINY QR GLINTS.
(IT’S TRYING TO LOOK INNOCENT.)

<span class="cursor">▮</span>`,
  [
    {label:"READ WRISTBAND (LOOK CLOSE)", action:wristband},
    {label:"LEAVE THE BED", kind:"safe", action:hallway},
    {label:"WAIT", action:waitNice}
  ]);
}
function nursePlace(){
  say(
`“OBSERVATION,” SHE SAYS.
“UNTIL YOUR THOUGHTS STOP TRYING TO RUN.”

THE WORD “RUN” FEELS LIKE A KEY.
THE KIND YOU DON’T HAVE YET.

<span class="cursor">▮</span>`,
  [
    {label:"RUN (BAD ACTING)", kind:"danger", action:hallRun},
    {label:"WALK OUT LIKE YOU BELONG", kind:"safe", action:hallway},
    {label:"SEARCH ROOM", action:searchRoom}
  ]);
}
function nursePills(){
  addStability(-1);
  say(
`“HELP,” SHE SAYS.
THE WAY SOME PEOPLE SAY “HANDCUFFS.”

SHE SETS THE CUP DOWN.
LEAVES IT.
LIKE A CHESS MOVE.

<span class="cursor">▮</span>`,
  [
    {label:"TAKE THEM", kind:"safe", action:takePills},
    {label:"HIDE THEM", action:hidePills},
    {label:"SEARCH ROOM", action:searchRoom}
  ]);
}

function waitNice(){
  // waiting can be safe, but if heat is high, it’s bad
  if(S.heat >= 4){
    return death(
      "YOU WAIT.\nFOOTSTEPS MULTIPLY.\nA STRAP SNAPS.\nTHE LIGHTS GO WHITE.",
      "THAT DOOR CLICK WAS YOUR WINDOW. IT CLOSED."
    );
  }
  addStability(1);
  S.flags.nurseTrust = true;
  say(
`YOU WAIT.
BREATH IN. BREATH OUT.
YOU DO THE WHOLE “I’M NORMAL” ROUTINE.

THE NURSE RETURNS, DIFFERENT NOW.
“YOU’RE TRYING,” SHE SAYS, LIKE IT’S A THREAT.

SHE LEAVES A BADGE ON THE TABLE. “ACCIDENTALLY.”
THE WORLD’S WORST MAGIC TRICK.

<span class="cursor">▮</span>`,
  [
    {label:"TAKE BADGE", kind:"safe", action:takeBadge},
    {label:"LEAVE IT (TOO HOT)", action:hallway},
    {label:"SEARCH ROOM", action:searchRoom}
  ]);
}

function fakeIt(){
  addHeat(-1);
  addStability(1);
  say(
`“SORRY,” YOU SAY.
THE NURSE’S SMILE RETURNS, RELIEVED.
LIKE YOU DID HER A FAVOR.

SHE HANDS YOU THE CUP AGAIN.
THE CUP DOESN’T CARE ABOUT MORALITY.

<span class="cursor">▮</span>`,
  [
    {label:"TAKE PILLS", kind:"safe", action:takePills},
    {label:"HIDE PILLS", action:hidePills},
    {label:"ASK A QUESTION", action:questionNurse}
  ]);
}

function doubleDown(){
  return death(
    "YOU RAISE YOUR VOICE.\nTHE NURSE NODS ONCE.\nA BUTTON CLICKS UNDER HER THUMB.\nYOU HEAR TWO ORDERLIES BEFORE YOU SEE THEM.",
    "THEY MOVE LIKE THEY’VE DONE THIS ALL DAY. BECAUSE THEY HAVE."
  );
}

function keepPills(){
  take("pills");
  say(
`YOU POCKET THE PILLS.
A PRIVATE LITTLE CHEAT CODE.

THE DOOR TO THE HALL IS AJAR.
LIKE IT WANTS TO BE YOUR PROBLEM.

<span class="cursor">▮</span>`,
  [
    {label:"STEP INTO HALL", kind:"safe", action:hallway},
    {label:"SEARCH ROOM", action:searchRoom},
    {label:"CRUSH A PILL (IN HAND)", action:crushPill}
  ]);
}

function dropPills(){
  addHeat(2);
  return death(
    "YOU DROP THEM.\nTHEY SKITTER LIKE BUGS.\nA CAMERA TILTS.\nAN ALARM DOESN’T SCREAM.\nWORSE.\nIT BEEPS ONCE.",
    "SOMEONE HEARD THAT BEEP A LONG TIME AGO. NOW IT’S YOUR TURN."
  );
}

function crushPill(){
  take("dust");
  addStability(-1);
  say(
`YOU CRUSH IT.
WHITE DUST.
SMELLS LIKE “CALM DOWN.”

POCKET IT.
(YES, YOU JUST INVENTED POCKET SAND: MEDICAL EDITION.)

<span class="cursor">▮</span>`,
  [
    {label:"HALLWAY", kind:"safe", action:hallway},
    {label:"SEARCH ROOM", action:searchRoom}
  ]);
}

function wristband(){
  S.flags.doorCode = true;
  say(
`YOU LEAN IN.
THE QR IS SCRATCHED, BUT READABLE.

A CODE PRINTED UNDER THE PLASTIC:
“19-02-09”

YOUR BRAIN DOES THAT THING:
IT MAKES IT FEEL IMPORTANT.

<span class="cursor">▮</span>`,
  [
    {label:"MEMORIZE IT", kind:"safe", action:hallway},
    {label:"SCRATCH IT INTO THE BEDFRAME", action:markCode}
  ]);
}
function markCode(){
  addHeat(1);
  say(
`YOU SCRATCH IT INTO METAL.
A LITTLE PRAYER FOR LATER.
A LITTLE VANDALISM FOR NOW.

<span class="cursor">▮</span>`,
  [{label:"HALLWAY", kind:"safe", action:hallway}]
  );
}

/* =========================
   ROOM SEARCH / ITEMS
========================= */
function searchRoom(){
  const found = [];
  if(!has("paperclip")) found.push({label:"TAKE BENT PAPERCLIP", action:()=>{ take("paperclip"); addHeat(1); searchRoom2(); }});
  if(!has("shard")) found.push({label:"TAKE MIRROR SHARD", kind:"danger", action:()=>{ take("shard"); addStability(-1); searchRoom2(); }});
  if(!has("map")) found.push({label:"CHECK VENT (LOOSE SCREW)", action:()=>{ take("map"); S.flags.vents=true; addHeat(1); searchRoom2(); }});

  if(found.length===0){
    return say(
`THE ROOM IS EMPTY NOW.
OR YOU ARE.
HARD TO TELL.

<span class="cursor">▮</span>`,
    [
      {label:"HALLWAY", kind:"safe", action:hallway},
      {label:"SIT ON BED (COUNT BREATHS)", action:waitNice}
    ]);
  }

  say(
`YOU SEARCH FAST.
LIKE A PERSON WHO HAS PLACES TO BE.
(OUTSIDE.)

YOU NOTICE:
${found.map(()=> "•").join(" ")}

<span class="cursor">▮</span>`,
  [
    ...found,
    {label:"STOP SEARCHING", kind:"safe", action:hallway}
  ]);
}

function searchRoom2(){
  const inv = Array.from(S.inv).map(x=>x.toUpperCase()).join(", ") || "NOTHING";
  say(
`POCKET CHECK: ${inv}

THE DOOR IS STILL AJAR.
IT’S NOT AN INVITATION.
IT’S A TEST.
AND YOU’RE TAKING IT OPEN-BOOK.

<span class="cursor">▮</span>`,
  [
    {label:"GO HALLWAY", kind:"safe", action:hallway},
    {label:"KEEP SEARCHING", action:searchRoom}
  ]);
}

function takeBadge(){
  take("badge");
  S.keys += 1;
  addHeat(1);
  say(
`YOU TAKE THE BADGE.
IT SAYS “TEMP” IN TINY LETTERS.
THE PHOTO IS BLANK.
LIKE YOU.
LIKE A LIE PRINTED IN PLASTIC.

<span class="cursor">▮</span>`,
  [
    {label:"HALLWAY", kind:"safe", action:hallway},
    {label:"HIDE BADGE IN SHIRT", action:hideBadge}
  ]);
}
function hideBadge(){
  addHeat(-1);
  say(
`BADGE HIDDEN.
YOU LOOK 7% LESS GUILTY.
WHICH IS A LOT IN THIS BUILDING.

<span class="cursor">▮</span>`,
  [{label:"HALLWAY", kind:"safe", action:hallway}]
  );
}

/* =========================
   HALLWAY
========================= */
function hallway(){
  S.scene = "hallway";

  if(S.heat >= 7 && !S.flags.camerasOff){
    return death(
      "YOU STEP OUT.\nA RED LIGHT BLINKS.\nA VOICE: “PATIENT OFF UNIT.”\nYOUR NAME SOUNDS WRONG IN THEIR MOUTH.",
      "THE WARD DOESN’T YELL. IT JUST DECIDES."
    );
  }

  // ambient intercom flavor (no mechanics, just vibe)
  if(!S.flags.heardIntercom && S.loop >= 3){
    S.flags.heardIntercom = true;
    addHeat(1);
  }

  const invHint = [];
  if(has("paperclip")) invHint.push("PAPERCLIP");
  if(has("badge")) invHint.push("BADGE");
  if(has("map")) invHint.push("VENT MAP");
  if(has("pills")) invHint.push("PILLS");
  const h = invHint.length ? `YOU HAVE: ${invHint.join(" / ")}\n\n` : "";

  const intercomLine = S.flags.heardIntercom
    ? `THE INTERCOM CRACKLES: “${S.name.toUpperCase()}, PLEASE RETURN TO YOUR ROOM.”\n(IT SAYS IT LIKE A SUGGESTION. IT IS NOT.)\n\n`
    : "";

  say(
`${h}${intercomLine}THE HALLWAY LIGHTS FLICKER.
DOORS LINE BOTH SIDES LIKE TEETH.

YOU SEE:
• A “STAFF ONLY” DOOR (KEYPAD + CAMERA)
• A VENT GRATE NEAR THE FLOOR
• A CAMERA THAT BLINKS LIKE IT’S BREATHING

YOU ALSO HEAR… HUMMING.
SOMEONE IN A ROOM, SINGING UNDER THEIR BREATH.

<span class="cursor">▮</span>`,
  [
    {label:"GO STAFF DOOR", kind:"safe", action:staffDoor},
    {label:"CHECK VENT", action:vent},
    {label:"FOLLOW HUMMING", action:humRoom},
    {label:"PACE BACK (BUY TIME)", action:pace}
  ]);
}

function pace(){
  bumpLoop("PACED IN THE HALL");
  addStability( (S.stability<6) ? 1 : 0 ); // pacing can calm you if you’re not already zen
  say(
`YOU PACE.
TEN STEPS. TURN. TEN STEPS.
YOU LOOK LIKE YOU’RE WAITING FOR SOMEBODY.
WHICH IS TRUE. YOU’RE WAITING FOR “FREEDOM.”

YOU NOTICE A JANITOR CART AT THE END OF THE HALL.
CLEANING SUPPLIES.
TAPE.
A CLIPBOARD THAT SAYS “NOTHING IMPORTANT.”
(LIAR.)

<span class="cursor">▮</span>`,
  [
    {label:"CHECK JANITOR CART", kind:"safe", action:janitorCart},
    {label:"GO STAFF DOOR", kind:"safe", action:staffDoor},
    {label:"CHECK VENT", action:vent},
    {label:"FOLLOW HUMMING", action:humRoom}
  ]);
}

function janitorCart(){
  // deterministic: if heat too high and cameras on, poking around draws attention
  if(S.heat >= 6 && !S.flags.camerasOff){
    addHeat(1);
    return say(
`YOU REACH FOR THE CART.
THE CAMERA TILTS.
JUST A LITTLE.
LIKE IT’S RAISING AN EYEBROW.

YOU FEEL ATTENTION LAND ON YOU.
HEAVY. QUIET.

<span class="cursor">▮</span>`,
    [
      {label:"BACK OFF", kind:"safe", action:hallway},
      {label:"COMMIT ANYWAY", kind:"danger", action:cartCommit}
    ]);
  }

  // reward: tape if not already
  if(!has("tape")){
    take("tape");
    addHeat(1);
    return say(
`YOU CHECK THE CART.
UNDER A RAG: A ROLL OF TAPE.
LABEL: “BMA / SIDE A” (??)

YOU POCKET IT.
IT FEELS LIKE A MESSAGE.
OR A JOKE. OR BOTH.

<span class="cursor">▮</span>`,
    [
      {label:"HALLWAY", kind:"safe", action:hallway},
      {label:"STAFF DOOR", kind:"safe", action:staffDoor}
    ]);
  }

  // already has tape: small stability bonus
  addStability(1);
  return say(
`THE CART HAS… CLEANER.
AND A STAGGERING AMOUNT OF LINT.

YOU POCKET A PIECE OF LINT FOR NO REASON.
CONGRATS. YOU’VE INVENTED “POCKET LINT.”
IT DOES NOTHING.
BUT IT’S YOURS.

<span class="cursor">▮</span>`,
  [
    {label:"HALLWAY", kind:"safe", action:hallway}
  ]);
}

function cartCommit(){
  return death(
    "YOU DIG THROUGH THE CART LIKE YOU OWN IT.\nFOOTSTEPS SPEED UP.\nSOMEONE SAYS: “HEY.”\nIT’S NEVER GOOD WHEN THEY SAY “HEY.”",
    "YOU WEREN’T STEALTHY. YOU WERE CONFIDENT. WRONG BUILDING FOR THAT."
  );
}

function hallRun(){
  addHeat(3);
  return hallway();
}

/* =========================
   HUMMING ROOM (social puzzle)
========================= */
function humRoom(){
  S.scene = "humRoom";
  say(
`THE DOOR IS HALF-OPEN.
INSIDE: A PATIENT WITH A PAPER CROWN
MADE OF HOSPITAL FORMS.

THEY LOOK UP.
“YOU’RE NEW,” THEY SAY.
LIKE THEY’VE BEEN WAITING.
LIKE YOU’RE A PACKAGE.

<span class="cursor">▮</span>`,
  [
    {label:"SAY HI (HUMAN MODE)", kind:"safe", action:friendHi},
    {label:"ASK ABOUT EXIT", action:askExit},
    {label:"STEAL THEIR CROWN (WHY)", kind:"danger", action:stealCrown},
    {label:"BACK TO HALL", action:()=>{ bumpLoop("BACKED OUT OF HUMMING ROOM"); hallway(); }}
  ]);
}

function friendHi(){
  S.flags.befriended = true;
  addHeat(-1);
  addStability(1);
  say(
`THEY NOD.
“NAME?” THEY ASK.

YOU FEEL THE ROOM LISTEN.
THE CROWN TILTS LIKE IT’S JUDGING YOUR ANSWER.

<span class="cursor">▮</span>`,
  [
    {label:`“${S.name}.”`, kind:"safe", action:friendName},
    {label:"LIE", action:friendLie}
  ]);
}
function friendName(){
  S.flags.confessed = true;
  addStability(1);

  // gift: tape if not already, else stability
  if(!has("tape")) take("tape"); else addStability(1);

  say(
`THEY SMILE LIKE A DOOR UNLOCKING.
“GOOD,” THEY WHISPER, AND SLIP YOU A CASSETTE TAPE.

LABEL: “BMA / SIDE A”
(IT FEELS HEAVY. LIKE IT HAS A PURPOSE.)

“THE STAFF DOOR HAS A KEYPAD,” THEY SAY.
“THE CODE IS A DATE.”
“IMPORTANT TO SOMEBODY.”
“PROBABLY YOU.”

<span class="cursor">▮</span>`,
  [
    {label:"ASK WHAT DATE", kind:"safe", action:friendDate},
    {label:"LEAVE QUIETLY", action:hallway}
  ]);
}
function friendLie(){
  S.flags.lied = true;
  addHeat(1);
  say(
`YOU LIE.
THEY DON’T CALL YOU OUT.

THEY JUST LOOK SADDER.
LIKE THEY LOST SOMEONE THEY NEVER MET.

THE CROWN DROOPS.
DRAMA.

<span class="cursor">▮</span>`,
  [
    {label:"APOLOGIZE", kind:"safe", action:friendName},
    {label:"LEAVE", action:hallway}
  ]);
}
function friendDate(){
  S.flags.doorCode = true;
  say(
`“FEB 19,” THEY SAY.
“9:30.”
“DON’T ASK WHY.”
(OF COURSE.)

THE CASSETTE FEELS WARM IN YOUR HAND.
LIKE IT’S BEEN PLAYED A THOUSAND TIMES.

<span class="cursor">▮</span>`,
  [
    {label:"GO STAFF DOOR", kind:"safe", action:staffDoor},
    {label:"VENT", action:vent},
    {label:"HALLWAY", action:hallway}
  ]);
}
function askExit(){
  addHeat(1);
  say(
`“EXIT?” THEY LAUGH.
“YOU’RE FUNNY.”

THEY TAP THEIR TEMPLE.
“EXIT IS A THOUGHT.
DOOR IS A LIE.”

UNHELPFUL.
ICONIC.

<span class="cursor">▮</span>`,
  [
    {label:"LEAVE", kind:"safe", action:hallway},
    {label:"ASK ABOUT STAFF DOOR", action:friendDate}
  ]);
}
function stealCrown(){
  return death(
    "YOU SNATCH THE PAPER CROWN.\nTHEY SCREAM LIKE A FIRE ALARM.\nTHE HALLWAY FILLS WITH SHOES.",
    "STEALING SYMBOLS DOESN’T MAKE YOU KING."
  );
}

/* =========================
   VENT PATH (stealth puzzle)
========================= */
function vent(){
  S.scene = "vent";

  if(!has("map") && !has("paperclip")){
    addHeat(1);
    return say(
`THE VENT GRATE IS SCREWED IN TIGHT.
NO TOOLS. NO LUCK. NO “MANIFESTING” OUT OF THIS ONE.

YOU FEEL THE CAMERA BLINK.
LIKE IT’S COUNTING YOUR MISTAKES.

<span class="cursor">▮</span>`,
    [
      {label:"BACK", kind:"safe", action:()=>{ bumpLoop("BACKED OUT OF VENT"); hallway(); }},
      {label:"TRY STAFF DOOR", action:staffDoor},
      {label:"FOLLOW HUMMING", action:humRoom}
    ]);
  }

  if(has("paperclip")){
    S.flags.vents = true;
    addHeat(1);

    // bonus: vent dust if not already
    if(!has("dust")) take("dust");

    say(
`YOU POP THE GRATE WITH THE PAPERCLIP.
THE VENT BREATHES OUT COLD AIR.

INSIDE: DARK, DUST, AND A LOW HUM
LIKE A SERVER ROOM HAVING A BAD DREAM.

<span class="cursor">▮</span>`,
    [
      {label:"CRAWL IN", kind:"safe", action:ventCrawl},
      {label:"CLOSE IT (NOT YET)", action:hallway}
    ]);
    return;
  }

  addHeat(1);
  say(
`YOU HAVE A MAP, NOT A WAY IN.
THE VENT DOESN’T CARE ABOUT YOUR VISION BOARD.

<span class="cursor">▮</span>`,
  [{label:"BACK", kind:"safe", action:hallway}]
  );
}

function ventCrawl(){
  // deterministic: if heat already high, you get spotted
  if(S.heat >= 6 && !S.flags.camerasOff){
    return death(
      "YOU CRAWL.\nTHE METAL POPS.\nTHE SOUND TRAVELS.\nFLASHLIGHTS FIND THE GRATE.",
      "THE VENT PATH DOESN’T LIKE DRAMA."
    );
  }
  addStability(-1);

  say(
`YOU CRAWL.
THE WORLD IS A TUNNEL NOW.
YOUR THOUGHTS GET LOUDER IN SMALL SPACES.
LOVE THAT FOR YOU.

YOU SEE LIGHT THROUGH SLATS:
A SECURITY OFFICE.
MONITORS.
KEYPAD LOGS.

YOU COULD DROP IN.
OR KEEP CRAWLING TO A LAUNDRY CHUTE.

<span class="cursor">▮</span>`,
  [
    {label:"DROP INTO SECURITY", kind:"safe", action:securityFromVent},
    {label:"CRAWL TO LAUNDRY CHUTE", action:laundryChute},
    {label:"TURN BACK", action:()=>{ bumpLoop("TURNED BACK IN VENT"); hallway(); }}
  ]);
}

function securityFromVent(){
  // deterministic gate: badge or low heat
  if(!has("badge") && S.heat >= 4){
    return death(
      "YOU DROP IN.\nA GUARD LOOKS UP.\nYOU FREEZE LIKE A PAUSE BUTTON.\nHE DOESN’T.",
      "BADGE OR LOW HEAT. THAT’S THE PRICE OF THIS MOVE."
    );
  }
  S.flags.camerasOff = true;
  S.keys = clamp(S.keys + 1, 0, 3);
  addHeat(1);

  say(
`YOU DROP INTO SECURITY.
NOBODY LOOKS UP.
THEY’RE ARGUING ABOUT A SHOW.
SOMETHING ABOUT SEASON 3 “FALLING OFF.” (RELATABLE.)

YOU REACH THE PANEL:
“CAMERAS” → OFFLINE.

THE HALLWAY FEELS LESS ALIVE IMMEDIATELY.

YOU ALSO FIND A KEYRING. ONE KEY.

<span class="cursor">▮</span>`,
  [
    {label:"TAKE KEY + LEAVE", kind:"safe", action:()=>{ S.keys++; hallway(); }},
    {label:"OPEN STAFF DOOR FROM HERE", action:remoteUnlock},
    {label:"HIDE UNDER DESK (LET THEM PASS)", action:hideDesk}
  ]);
}

function remoteUnlock(){
  // requires doorCode known OR tape clue
  if(S.flags.doorCode || has("tape")){
    return win(
`YOU TYPE THE CODE FROM MEMORY.
BEEP. GREEN.

THE STAFF DOOR CLICKS OPEN DOWN THE HALL.
YOU WALK OUT LIKE A GHOST THAT PAYS RENT.

OUTSIDE, AIR FEELS ILLEGAL.
YOUR BRAIN IS STILL LOUD.
BUT IT’S YOURS.`
    );
  }
  addHeat(2);
  return death(
    "YOU HIT RANDOM KEYS.\nTHE SCREEN FLASHES RED.\nTHE GUARDS STOP TALKING.\nALL EYES TURN AT ONCE.",
    "YOU NEEDED A REAL CODE. A REAL DATE. NOT VIBES."
  );
}

function hideDesk(){
  if(S.stability <= 2){
    return death(
      "YOU HOLD YOUR BREATH TOO LONG.\nYOU COUGH.\nTHE SOUND BETRAYS YOU.",
      "STABILITY LOW = BODY SNITCHES."
    );
  }
  addHeat(-1);
  addStability(1);
  say(
`YOU HIDE.
THEY PASS.
THE ROOM SMELLS LIKE COFFEE AND CONTROL.

YOU SLIP OUT THE WAY YOU CAME.
LIKE YOU WERE NEVER HERE.
LIKE A THOUGHT YOU CAN’T PROVE.

<span class="cursor">▮</span>`,
  [{label:"BACK TO HALLWAY", kind:"safe", action:hallway}]
  );
}

function laundryChute(){
  // Win path: requires shard OR key
  if(!has("shard") && S.keys < 1){
    addHeat(1);
    return say(
`THE LAUNDRY CHUTE DOOR IS PADLOCKED.
YOU CAN’T “WILL” A PADLOCK OPEN.
(UNFORTUNATE.)

YOU NEED:
• A KEY  OR  • A SHARP THING

<span class="cursor">▮</span>`,
    [
      {label:"GO GET A KEY (SECURITY)", kind:"safe", action:ventCrawl},
      {label:"TURN BACK", action:hallway}
    ]);
  }

  if(has("shard")){
    addStability(-2);
    if(S.stability <= 0){
      return death(
        "YOU SAW THROUGH METAL WITH GLASS.\nIT FIGHTS BACK.\nYOU BLEED OUT QUIETLY.",
        "SHARP THINGS ARE HONEST. TOO HONEST."
      );
    }
  } else {
    addStability(1);
  }

  return win(
`YOU OPEN THE CHUTE.
YOU DROP.
THE WORLD BECOMES A RUSH OF FABRIC AND STATIC.

YOU LAND IN A LAUNDRY ROOM.
A BACK EXIT.
NO CAMERA.
NO QUESTIONS.

YOU STEP OUT.
THE SUN DOESN’T ASK FOR A WRISTBAND.`
  );
}

/* =========================
   STAFF DOOR (front door puzzle)
========================= */
function staffDoor(){
  S.scene = "staffDoor";

  // if cameras are off, heat matters less
  if(!S.flags.camerasOff && S.heat >= 6){
    return death(
      "YOU REACH THE STAFF DOOR.\nTHE CAMERA ABOVE IT TRACKS YOU.\nA VOICE ON SPEAKER: “STEP BACK.”\nYOU DON’T GET TO NEGOTIATE.",
      "HEAT TOO HIGH. CAMERA STILL WATCHING. BAD COMBO."
    );
  }

  const knowsCode = S.flags.doorCode || has("tape");
  const codeLine = knowsCode
    ? "YOU FEEL A CODE IN YOUR SKULL.\nA DATE. A TIME.\n"
    : "THE KEYPAD WAITS.\nYOU DO NOT KNOW THE CODE.\n";

  const camLine = S.flags.camerasOff
    ? "THE CAMERA LIGHT IS OFF.\n(YES, THAT’S AS NICE AS THIS PLACE GETS.)\n"
    : "THE CAMERA LIGHT IS ON.\nIT BLINKS SLOW. LIKE IT’S BORED.\n";

  say(
`${camLine}${codeLine}
THE DOOR SAYS: STAFF ONLY.

YOU CAN:
• ENTER CODE
• SWIPE BADGE
• USE KEY
• WALK AWAY AND PRETEND YOU DIDN’T TRY TO ESCAPE A FACILITY

<span class="cursor">▮</span>`,
  [
    {label:"ENTER CODE", kind:"safe", action:enterCode},
    {label:"SWIPE BADGE", action:swipeBadge},
    {label:"USE KEY", action:useKey},
    {label:"BACK", action:()=>{ bumpLoop("BACKED OUT OF STAFF DOOR"); hallway(); }}
  ]);
}

function enterCode(){
  if(!(S.flags.doorCode || has("tape"))){
    addHeat(2);
    return death(
      "YOU GUESS.\nTHE KEYPAD BEEPS WRONG.\nLOUD.\nA RED LIGHT THINKS ABOUT YOU.",
      "GUESSING IS JUST CONFESSING WITH EXTRA STEPS."
    );
  }
  return win(
`YOU TYPE THE CODE.
BEEP.
GREEN.

THE DOOR OPENS LIKE IT WAS TIRED OF HOLDING YOU.

OUTSIDE: WIND.
NO CLIPBOARDS.
NO STRAPS.

YOUR MIND IS STILL A LITTLE BROKEN.
BUT IT’S OUT HERE WITH YOU.`
  );
}

function swipeBadge(){
  if(!has("badge")){
    addHeat(2);
    return say(
`YOU SWIPE… AIR.
THE DOOR DOESN’T CARE.

<span class="cursor">▮</span>`,
    [
      {label:"BACK", kind:"safe", action:staffDoor},
      {label:"GO FIND A BADGE", action:hallway}
    ]);
  }

  // badge alone is not enough unless nurseTrust or camerasOff
  if(S.flags.nurseTrust || S.flags.camerasOff){
    return win(
`YOU SWIPE THE BADGE.
IT ACCEPTS YOU.

THE DOOR OPENS.
YOU WALK OUT LIKE YOU’VE ALWAYS BEEN STAFF.

YOU’RE FREE.
WHICH IS A DIFFERENT KIND OF SCARY.`
    );
  }
  addHeat(2);
  return death(
    "THE BADGE BEEPS.\nYELLOW.\n“VERIFY.”\nA CAMERA BLINKS.\nSOMEONE SAYS YOUR NAME LIKE A WARNING.",
    "BADGE NEEDS TRUST. OR DARK CAMERAS. YOU HAVE NEITHER."
  );
}

function useKey(){
  if(S.keys <= 0){
    return say(
`NO KEY.

<span class="cursor">▮</span>`,
    [
      {label:"BACK", kind:"safe", action:staffDoor},
      {label:"TRY VENT (SECURITY)", action:vent}
    ]);
  }
  if(S.heat >= 6 && !S.flags.camerasOff){
    return death(
      "YOU INSERT THE KEY.\nIT TURNS.\nTHE LOCK CLICKS.\nAND SO DOES A RADIO.\nTHEY WERE WAITING.",
      "KEYS OPEN DOORS. THEY ALSO OPEN ATTENTION."
    );
  }
  return win(
`YOU TURN THE KEY.
THE DOOR OPENS.

OUTSIDE: AIR THAT DOESN’T SMELL LIKE BLEACH.
YOU DON’T RUN.
YOU WALK.

THAT’S THE FLEX.`
  );
}

/* =========================
   Tiny convenience: keys 1-4 choose option
========================= */
document.addEventListener("keydown",(e)=>{
  // help toggle
  if(e.key.toLowerCase() === "h"){
    e.preventDefault();
    helpMask.classList.contains("open") ? closeHelpNow() : openHelp();
    return;
  }
  const n = parseInt(e.key,10);
  if(!n) return;
  const btns = Array.from(elChoices.querySelectorAll("button"));
  if(btns[n-1]) btns[n-1].click();
});

/* =========================
   Start HUD
========================= */
updateHUD();
save();
</script>
</body>
</html>
